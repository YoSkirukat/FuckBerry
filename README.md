## WB Dashboard — Аналитика заказов Wildberries

Небольшое Flask‑приложение для анализа заказов и продаж по API Wildberries: графики по дням, сводка по складам, ТОП товаров, экспорт в Excel, страница настроек для токена. Данные кэшируются в пределах сессии. 

### Возможности
- Загрузка заказов и продаж за выбранный период (пагинация по lastChangeDate)
- Графики:
  - Количество заказов и продаж по дням (тултип показывает сумму выручки за день)
  - Выручка по дням (тултип показывает количество за день)
- Сводка по складам: «Кол-во заказано» и «Кол-во продано»
- ТОП товаров по заказам: две таблицы (краткая и сводная с фильтром по складу)
  - Сводная таблица обновляется автоматически при выборе склада
- Экспорт заказов в Excel (xlsx)
- Страница «Настройки»: ввод/очистка API‑токена + отображение наименования продавца
- Страница «Маркетплейс FBS»: получение новых заданий на сборку с сортировкой по дате
- Страница «Коэффициенты приёмки»: сетка коэффициентов (только тип «Короба») на сегодня + 14 дней
  - Красный фон — приёмка недоступна (−1), зелёный — доступна (≥0)
  - Складa отсортированы по числу дней с неотрицательными коэффициентами (больше — выше)
- Асинхронное обновление без перезагрузки страницы:
  - Кнопка «Загрузить» с индикатором загрузки обновляет KPI, графики, таблицы и заголовки дат
  - Показ времени последнего обновления
- Единый навбар (partials): `templates/_navbar.html` подключается на всех страницах, «Настройки» всегда последним пунктом меню

### Требования
- Python 3.10+ (рекомендовано 3.11+)
- Доступный API‑токен WB (Supplier Statistics API)

### Установка
```bash
python -m venv .venv
# Windows PowerShell
.\.venv\Scripts\Activate.ps1
# Linux/macOS
# source .venv/bin/activate

pip install -r requirements.txt
```

### Запуск
```bash
# (опционально) секрет для Flask-сессий
# Windows PowerShell
$env:FLASK_SECRET = "your-random-secret"

python app.py
# Откройте http://127.0.0.1:5000
```

### Первые шаги
1. Откройте «Настройки» и сохраните ваш WB API токен.
2. На странице «Заказы» выберите период и нажмите «Загрузить» — данные подтянутся и обновятся без перезагрузки.
3. Изучайте графики и таблицы; скачайте Excel при необходимости.
4. Внизу страницы используйте «Сводная таблица: ТОП товаров по заказам». Фильтр по складу обновляет таблицу автоматически.
5. Дополнительно: «Маркетплейс FBS» и «Коэффициенты приёмки» доступны из меню.

### Конфигурация
- Переменные окружения:
  - `FLASK_SECRET` — секрет сессий Flask (рекомендуется задать в продакшене)
- Токен WB задается в UI («Настройки»)

### Эндпоинты
- Страницы:
  - `GET /` → редирект на `/orders`
  - `GET|POST /orders` — аналитика: графики, сводки, ТОПы
  - `GET|POST /settings` — ввод/очистка токена, показ наименования продавца
  - `GET|POST /fbs` — новые задания FBS
  - `GET|POST /coefficients` — коэффициенты приёмки (сегодня + 14 дней)
- Экспорт/JSON:
  - `POST /export` — экспорт заказов в xlsx
  - `POST /api/orders-refresh` — асинхронное обновление аналитики (KPI, графики, таблицы)
  - `GET /api/top-products-orders?warehouse=` — JSON‑ТОП по заказам (для сводной таблицы)
  - `GET /api/acceptance-coefficients` — JSON‑сетка коэффициентов приёмки (кнопка «Обновить данные» на странице)

### Форматы и UX
- Формат дат в заголовках: `дд.мм.гггг` (например, 13.08.2025)
- Индикатор загрузки на кнопке «Загрузить» (спиннер + надпись «Загрузка…»)
- Время последнего обновления отображается рядом с KPI

### Структура проекта
```
app.py
requirements.txt
templates/
  _navbar.html
  index.html
  settings.html
  fbs.html
  coefficients.html
cache/               # кэш сессий (игнорируется в git)
.venv/               # виртуальное окружение (игнорируется)
```

### Траблшутинг
- HTTP 429 (Too Many Requests): сузьте период; приложение повторяет запросы автоматически (backoff), но это займет больше времени
- Пустые графики/таблицы: нажмите «Загрузить» для нужного периода; кэш обновится
- Нет токена: укажите его на странице «Настройки»

### Лицензия
MIT (по желанию смените на подходящую для проекта) 