<!doctype html>
<html lang="ru">
<head>
  {% block title %}<title>Поставки FBW — WB Dashboard</title>{% endblock %}
  {% include '_header.html' %}
  {% block extra_styles %}
  <style>
    h1 { font-size: 1.7rem; }
    .table-sm td, .table-sm th { font-size: 0.9rem; }
    th, td { vertical-align: middle; }
    .wh-name { position: relative; display: inline-block; max-width: 100%; white-space: nowrap; overflow: hidden; vertical-align: middle; }
    .wh-name.truncate-fade::after { content: ""; position: absolute; right: 0; top: 0; height: 100%; width: 2rem; pointer-events: none; background: linear-gradient(to right, rgba(255,255,255,0), #fff 60%); }
    .text-badge {
      display: inline-block;
      padding: 0.15rem 0.35rem;
      border-radius: 0.25rem;
      white-space: nowrap;
    }
    .supply-row { cursor: pointer; }
    .package-toggle { cursor: pointer; }
    .pkg-arrow { display: inline-block; width: 1rem; text-align: center; }
    .status-accepted { color: #14532d; background: #d1fae5; font-size: 11px; font-weight: bold; }
    .status-allowed { color: #0c4a6e; background: #e0f2fe; font-size: 11px; font-weight: bold; }
    .status-notallowed { color: #ef3a00; background: #ffdf7d; font-size: 11px; font-weight: bold; }
    .status-planned { color: #0c4a6e; background: #e0f2fe; font-size: 11px; font-weight: bold; }
    .text-free { color: #14532d; font-weight: 600; }
    
    /* Стили для индикатора загрузки */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(2px);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }
    
    .loading-content {
      text-align: center;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #666;
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    .table-blurred {
      filter: blur(1px);
      opacity: 0.6;
      transition: all 0.3s ease;
    }
  </style>
  {% endblock %}
  <script>
    // no dynamic scripts yet; static render of last 10 supplies
  </script>
</head>
<body>
  {% include '_navbar.html' %}

  <div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">Поставки FBW</h1>
      <div class="d-flex align-items-center gap-3">
        <div class="text-muted">Обновлено: <span id="lastUpdated">{{ generated_at }}</span></div>
        <button id="refreshBtn" class="btn btn-outline-primary btn-sm" type="button">Обновить</button>
      </div>
    </div>

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <div class="mb-2 small text-muted" id="fbwStats" style="display:none;">
      <span class="me-3">Товаров в доставке: <strong id="fbwStatGoods">0</strong></span>
      <span>Коробов в доставке: <strong id="fbwStatBoxes">0</strong></span>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle" id="supTable">
            <thead class="table-light text-center">
              <tr>
                <th>#</th>
                <th>Номер поставки</th>
                <th>Тип поставки</th>
                <th>Дата создания</th>
                <th>Упаковано/принято</th>
                <th>Кол-во коробов</th>
                <th class="text-start">Склад</th>
                <th>Коэфициент приёмки</th>
                <th class="text-start">Стоимость приёмки</th>
                <th>Плановая дата</th>
                <th>Фактическая дата</th>
                <th class="text-nowrap">Статус</th>
              </tr>
            </thead>
            <tbody id="supBody">
              {% for s in supplies %}
              <tr class="supply-row" data-supply-id="{{ s.supply_id }}">
                <td class="text-center">{{ loop.index }}</td>
                <td class="text-center fw-semibold">{{ s.supply_id }}</td>
                <td class="text-center text-nowrap">{% set _st = (s.status or '') %}{% if 'Не запланировано' in _st %}{% set _t = '' %}{% else %}{% set _t = (s.type or '') %}{% if _t == 'Без коробов' or not _t %}{% set _t = 'Допринято' %}{% endif %}{% endif %}{{ _t }}</td>
                <td class="text-center text-nowrap">{{ s.created_at }}</td>
                <td class="text-center">
                  {% if s.total_goods is not none %}
                    {% set sent = s.total_goods %}
                    {% set accepted = s.accepted_goods if s.accepted_goods is not none else 0 %}
                    {{ sent }}/{{ accepted }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-center" data-pkg-cell="1">{% if s.package_count is defined and s.package_count %}{{ s.package_count }}{% else %}-{% endif %}</td>
                <td class="text-start"><span class="wh-name" data-full-name="{{ s.warehouse }}">{{ s.warehouse }}</span></td>
                <td class="text-center">
                  {% if s.acceptance_coefficient is not none %}
                    {% if s.acceptance_coefficient == 0 %}
                      <span class="text-free">Бесплатно</span>
                    {% else %}
                      x{{ s.acceptance_coefficient }}
                    {% endif %}
                  {% else %}-{% endif %}
                </td>
                <td class="text-start">
                  {% if s.acceptance_cost is not none %}{{ s.acceptance_cost }} ₽{% else %}-{% endif %}
                </td>
                <td class="text-center text-nowrap">
                  <div>{{ s.planned_date }}</div>
                  {% set dl = (s.planned_date|days_left) %}
                  {% if dl is not none and ('Принято' not in (s.status or '')) %}
                    <div class="text-muted" style="font-size: 0.8em;">Осталось дней: {{ dl }}</div>
                  {% endif %}
                </td>
                <td class="text-center text-nowrap">{{ s.fact_date.split(' ')|first if s.fact_date else '' }}</td>
                <td class="text-center">
                  {# Вычисляем отображаемый статус с учётом типа "Допринято" #}
                  {% set _raw_status = s.status or '' %}
                  {% set _type_tmp = s.type or '' %}
                  {% if 'Не запланировано' in _raw_status %}{% set _type_tmp = '' %}{% endif %}
                  {% if (_type_tmp == 'Без коробов') or (not _type_tmp) and ('Не запланировано' not in _raw_status) %}{% set _type_tmp = 'Допринято' %}{% endif %}
                  {% set st = 'Принято' if _type_tmp == 'Допринято' else _raw_status %}
                  {% set cls = '' %}
                  {% if 'Принято' in st %}{% set cls = 'status-accepted' %}{% endif %}
                  {% if 'Отгрузка разрешена' in st %}{% set cls = 'status-allowed' %}{% endif %}
                  {% if 'Идёт приёмка' in st %}{% set cls = 'status-accepted' %}{% endif %}
                  {% if 'Отгружено на воротах' in st %}{% set cls = 'status-accepted' %}{% endif %}
                  {% if 'Не запланировано' in st %}{% set cls = 'status-notallowed' %}{% endif %}
                  {% if 'Запланировано' in st %}{% set cls = 'status-planned' %}{% endif %}
                  <span class="text-badge {{ cls }}">{{ st }}</span>
                </td>
              </tr>
              <tr class="supply-details" data-for="{{ s.supply_id }}" style="display:none;">
                <td colspan="12">
                  <div class="p-2 bg-light border rounded">
                    <div class="supply-summary small text-muted mb-2" data-for="{{ s.supply_id }}"></div>
                    <div class="fw-semibold mb-2">Упаковки</div>
                    <div class="packages" data-for="{{ s.supply_id }}">Загрузка...</div>
                  </div>
                </td>
              </tr>
              {% endfor %}
              {% if not supplies %}
              <tr><td colspan="12" class="text-center text-muted">Нет данных</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <div class="d-flex justify-content-center mt-3">
          <button id="loadMoreBtn" class="btn btn-outline-secondary btn-sm">Загрузить ещё</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Индикатор загрузки -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Обновление данных о поставках...</div>
    </div>
  </div>

  {% include '_footer.html' %}
  <!-- Docs reference: https://dev.wildberries.ru/openapi/orders-fbw#tag/Informaciya-o-postavkah/paths/~1api~1v1~1supplies/post -->
</body>
<script>
// Источник API: https://dev.wildberries.ru/openapi/orders-fbw#tag/Informaciya-o-postavkah/paths/~1api~1v1~1supplies/post
let supAll = [];
let rendered = 0;

// Ленивая подзагрузка количества коробов с ограничением параллелизма
let __pkgQueue = [];
let __pkgActive = 0;
const __PKG_MAX = 3;
function __pumpPkg(){
  while (__pkgActive < __PKG_MAX && __pkgQueue.length){
    const row = __pkgQueue.shift();
    if (!row) continue;
    const id = (row.getAttribute('data-supply-id')||'').trim();
    // Если нет корректного supply_id, пропускаем, чтобы не слать /supplies//package-count
    if (!id) { continue; }
    const cell = row.querySelector('td[data-pkg-cell]');
    if (!cell || cell.textContent.trim() !== '-') { continue; }
    __pkgActive++;
    fetch(`/api/fbw/supplies/${encodeURIComponent(id)}/package-count`).then(r=>r.json()).then(d=>{
      const val = (d && typeof d.package_count !== 'undefined') ? d.package_count : '-';
      if (cell) cell.textContent = (val && Number(val) > 0) ? String(val) : '-';
    }).catch(()=>{}).finally(()=>{ __pkgActive--; __pumpPkg(); });
  }
}
function __enqueuePkgRow(row){
  __pkgQueue.push(row);
  __pumpPkg();
}

function statusClass(st){
  if(!st) return '';
  if(st.includes('Принято')) return 'status-accepted';
  if(st.includes('Отгрузка разрешена')) return 'status-allowed';
  if(st.includes('Идёт приёмка')) return 'status-accepted';
  if(st.includes('Отгружено на воротах')) return 'status-accepted';
  if(st.includes('Не запланировано')) return 'status-notallowed';
  if(st.includes('Запланировано')) return 'status-planned';
  return '';
}

function onlyDate(s){
  if(!s) return '';
  return s.split(' ')[0] || s;
}

function parseDMY(s){
  try{
    const [d,m,y] = String(s||'').split('.').map(x=>parseInt(x,10));
    if(!d||!m||!y) return null;
    return new Date(y, m-1, d);
  }catch(_){ return null; }
}

function daysLeftText(dateStr){
  try{
    const dt = parseDMY(dateStr);
    if(!dt) return '';
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const end = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
    const diffMs = end - start;
    const days = Math.round(diffMs/86400000);
    return `Осталось дней: ${days}`;
  }catch(_){ return ''; }
}

function recomputeStats(){
  const block = document.getElementById('fbwStats');
  if (!block) return;
  try{
    let goods = 0; let boxes = 0;
    const rows = Array.from(document.querySelectorAll('#supBody tr.supply-row'));
    rows.forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      const status = (tds[11]?.textContent || '').trim();
      // Считаем все поставки, которые еще не приняты (исключаем только "Принято")
      if (status && !status.includes('Принято')){
        // Товары: берем первую часть из формата "sent/accepted"
        const goodsStr = (tds[4]?.textContent || '').replace(/\s+/g,'').trim();
        if (goodsStr && goodsStr !== '-'){
          const sentPart = goodsStr.split('/')[0];
          const goodsVal = parseInt(sentPart, 10);
          if (!isNaN(goodsVal) && goodsVal > 0) goods += goodsVal;
        }
        // Коробы: берем значение из колонки "Кол-во коробов"
        const boxStr = (tds[5]?.textContent || '').replace(/\s+/g,'').trim();
        if (boxStr && boxStr !== '-'){
          const boxVal = parseInt(boxStr, 10);
          if (!isNaN(boxVal) && boxVal > 0) boxes += boxVal;
        }
      }
    });
    document.getElementById('fbwStatGoods').textContent = goods.toString();
    document.getElementById('fbwStatBoxes').textContent = boxes.toString();
    block.style.display = '';
  }catch(_){ }
}

function renderChunk(count){
  const tbody = document.getElementById('supBody');
  const next = Math.min(rendered + count, supAll.length);
  for(let i=rendered;i<next;i++){
    const s = supAll[i];
    const coefVal = s.acceptance_coefficient;
    let coefHtml = '-';
    if(coefVal !== undefined && coefVal !== null && String(coefVal).trim() !== ''){
      const num = Number(coefVal);
      if(!isNaN(num)){
        coefHtml = num === 0 ? '<span class="text-free">Бесплатно</span>' : ('x' + num);
      } else {
        // already formatted text like 'Бесплатно' or 'x4'
        coefHtml = String(coefVal);
      }
    }
    const costVal = s.acceptance_cost;
    let costText = '-';
    if(costVal !== undefined && costVal !== null && String(costVal).trim() !== ''){
      const txt = String(costVal);
      costText = txt.includes('₽') ? txt : (txt + ' ₽');
    }
    const tr = document.createElement('tr');
    tr.className = 'supply-row';
    tr.setAttribute('data-supply-id', s.supply_id||'');
    tr.innerHTML = `
      <td class="text-center">${i+1}</td>
      <td class="text-center fw-semibold">${s.supply_id||''}</td>
      <td class="text-center text-nowrap">${(function(){
        const status = String(s.status||'');
        if (status.includes('Не запланировано')) return '';
        const t = String(s.type||'').trim();
        return (!t || t==='Без коробов') ? 'Допринято' : t;
      })()}</td>
      <td class="text-center text-nowrap">${s.created_at||''}</td>
      <td class="text-center">${s.total_goods !== undefined && s.total_goods !== null ? (s.total_goods + '/' + (s.accepted_goods !== undefined && s.accepted_goods !== null ? s.accepted_goods : 0)) : '-'}</td>
      <td class="text-center" data-pkg-cell="1">${(s.package_count ? s.package_count : '-') }</td>
      <td class="text-start"><span class="wh-name" data-full-name="${s.warehouse||''}">${s.warehouse||''}</span></td>
      <td class="text-center">${coefHtml}</td>
      <td class="text-start">${costText}</td>
      <td class="text-center text-nowrap">
        <div>${s.planned_date||''}</div>
        ${(!s.status || !String(s.status).includes('Принято')) ? (`<div class=\"text-muted\" style=\"font-size: 0.8em;\">${daysLeftText(s.planned_date)}</div>`) : ''}
      </td>
      <td class="text-center text-nowrap">${onlyDate(s.fact_date)}</td>
      <td class="text-center">${(function(){
        const status0 = String(s.status||'');
        const typeShown = (function(){
          if (status0.includes('Не запланировано')) return '';
          const t = String(s.type||'').trim();
          return (!t || t==='Без коробов') ? 'Допринято' : t;
        })();
        const finalStatus = (typeShown === 'Допринято') ? 'Принято' : status0;
        return `<span class="text-badge ${statusClass(finalStatus)}">${finalStatus}</span>`;
      })()}</td>
    `;
    tbody.appendChild(tr);
    // Ленивая подзагрузка количества коробов для добавленной строки
    (function(){
      try{
        const pkgCell = tr.querySelector('td[data-pkg-cell]');
        if (pkgCell && pkgCell.textContent.trim() === '-') __enqueuePkgRow(tr);
      }catch(_){}
    })();
    // details row skeleton
    const dtr = document.createElement('tr');
    dtr.className = 'supply-details';
    dtr.setAttribute('data-for', s.supply_id||'');
    dtr.style.display = 'none';
    dtr.innerHTML = `
      <td colspan="12">
        <div class="p-2 bg-light border rounded">
          <div class="supply-summary small text-muted mb-2" data-for="${s.supply_id||''}"></div>
          <div class="fw-semibold mb-2">Упаковки</div>
          <div class="packages" data-for="${s.supply_id||''}">Загрузка...</div>
        </div>
      </td>`;
    tbody.appendChild(dtr);
  }
  rendered = next;
  // Не блокируем кнопку по длине локального массива, так как на сервере могут быть ещё записи
  const lm = document.getElementById('loadMoreBtn');
  if (lm) lm.disabled = false;
  // Пересчёт статистики после дорисовки
  try{ recomputeStats(); }catch(_){}
}

async function refresh(){
  const btn = document.getElementById('refreshBtn');
  const overlay = document.getElementById('loadingOverlay');
  const table = document.getElementById('supTable');
  
  // Показываем индикатор загрузки
  btn.disabled = true; 
  btn.textContent = 'Обновляем...';
  if (overlay) overlay.style.display = 'flex';
  if (table) table.classList.add('table-blurred');
  
  try{
    // Добавляем таймаут для запроса
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 секунд таймаут
    
    const res = await fetch('/api/fbw/supplies', {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
      },
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (!res.ok) {
      if (res.status === 401) {
        throw new Error('Требуется авторизация. Пожалуйста, войдите в систему.');
      }
      throw new Error(`Ошибка сервера: ${res.status}`);
    }
    
    const data = await res.json();
    if (data.error) {
      throw new Error(data.error);
    }
    supAll = data.items||[];
    rendered = 0;
    const tbody = document.getElementById('supBody');
    tbody.innerHTML = '';
    renderChunk(15);
    document.getElementById('lastUpdated').textContent = data.updated_at||'';
    try{ recomputeStats(); }catch(_){}
    // Для уже отрисованных строк: если колонка с коробами '-', запускаем ленивую подгрузку
    try{
      const rows = Array.from(document.querySelectorAll('#supBody tr.supply-row'));
      rows.forEach((tr)=>{
        const cell = tr.querySelector('td[data-pkg-cell]');
        if (cell && cell.textContent.trim() === '-') __enqueuePkgRow(tr);
      });
    }catch(_){}
  }catch(e){ 
    console.error('Ошибка обновления:', e);
    
    // Различаем типы ошибок
    if (e.name === 'AbortError') {
      console.log('Запрос был прерван (таймаут)');
      // Не показываем alert для AbortError, так как это может быть нормальным поведением
    } else {
      // Показываем пользователю ошибку только для реальных проблем
      alert(`Ошибка обновления данных: ${e.message}`);
    }
  }
  finally{ 
    btn.disabled = false; 
    btn.textContent = 'Обновить';
    // Скрываем индикатор загрузки
    if (overlay) overlay.style.display = 'none';
    if (table) table.classList.remove('table-blurred');
  }
}

document.getElementById('refreshBtn')?.addEventListener('click', refresh);

document.getElementById('loadMoreBtn')?.addEventListener('click', ()=>{
  // Try from cache first
  // Всегда запрашиваем следующую страницу у сервера согласно текущему rendered,
  // чтобы избежать пропусков при рассинхроне локального массива
  // Ask server for next page without calling WB API again if possible (server decides)
  const btn = document.getElementById('loadMoreBtn');
  const overlay = document.getElementById('loadingOverlay');
  const table = document.getElementById('supTable');
  
  btn.disabled = true; 
  btn.textContent = 'Загружаем...';
  
  // Показываем индикатор загрузки для дополнительных данных
  if (overlay) {
    overlay.querySelector('.loading-text').textContent = 'Загрузка дополнительных данных...';
    overlay.style.display = 'flex';
  }
  if (table) table.classList.add('table-blurred');
  
  const nextOffset = rendered;
  
  // Добавляем таймаут для запроса
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 секунд таймаут
  
  fetch(`/api/fbw/supplies?offset=${nextOffset}&limit=5`, {
    method: 'GET',
    credentials: 'include',
    headers: {
      'Content-Type': 'application/json',
    },
    signal: controller.signal
  }).then(r=>{
    clearTimeout(timeoutId);
    if (!r.ok) {
      if (r.status === 401) {
        throw new Error('Требуется авторизация. Пожалуйста, войдите в систему.');
      }
      throw new Error(`Ошибка сервера: ${r.status}`);
    }
    return r.json();
  }).then(data=>{
    if (data.error) {
      throw new Error(data.error);
    }
    const items = data.items||[];
    // Добавляем в общий массив и отрисовываем ровно полученную порцию
    supAll = supAll.concat(items);
    renderChunk(items.length);
    try{ recomputeStats(); }catch(_){}
    // Если сервер вернул пусто — дальше блокируем кнопку
    if (items.length === 0) btn.disabled = true;
  }).catch(e=>{ 
    console.error('Ошибка загрузки дополнительных данных:', e);
    alert(`Ошибка загрузки данных: ${e.message}`);
  }).finally(()=>{ 
    clearTimeout(timeoutId);
    btn.disabled = false; 
    btn.textContent = 'Загрузить ещё';
    // Скрываем индикатор загрузки
    if (overlay) {
      overlay.style.display = 'none';
      overlay.querySelector('.loading-text').textContent = 'Обновление данных о поставках...';
    }
    if (table) table.classList.remove('table-blurred');
  });
});

// Toggle details and lazy-load
document.getElementById('supBody')?.addEventListener('click', async (e)=>{
  // Игнорируем клики внутри внутренних таблиц упаковок
  if (e.target.closest('.package-toggle .table') || e.target.closest('.package-toggle table')) return;
  const row = e.target.closest('.supply-row');
  if(!row) return;
  const id = row.getAttribute('data-supply-id');
  const detailsRow = document.querySelector(`.supply-details[data-for="${id}"]`);
  if(!detailsRow) return;
  const visible = detailsRow.style.display !== 'none';
  // collapse any other opened
  document.querySelectorAll('.supply-details').forEach(r=>{ if(r!==detailsRow) r.style.display='none'; });
  if(visible){ detailsRow.style.display='none'; return; }
  detailsRow.style.display='';
  // if already loaded once, skip
  const goodsBody = detailsRow.querySelector(`tbody.goods[data-for="${id}"]`);
  if(goodsBody && goodsBody.getAttribute('data-loaded')==='1') return;
  try{
    const res = await fetch(`/api/fbw/supplies/${encodeURIComponent(id)}/details`);
    const data = await res.json();
    // summary
    const sumDiv = detailsRow.querySelector(`.supply-summary[data-for="${id}"]`);
    const det = data.details||{};
    function numOrNull(v){ return (v===0 || v==="0" || (v && !isNaN(Number(v)))) ? Number(v) : null; }
    function fmt(v){ return (v===0 || (v && !isNaN(Number(v)))) ? Number(v) : (v ? v : '-'); }
    const sent = numOrNull(det.quantity);
    const accepted = numOrNull(det.acceptedQuantity);
    let acceptedHtml = `<strong>${fmt(det.acceptedQuantity)}</strong>`;
    if (sent !== null && accepted !== null && accepted > 0 && accepted < sent) {
      const diff = sent - accepted;
      acceptedHtml += ` (<strong class="text-danger">-${diff}</strong>)`;
    }
    sumDiv.innerHTML = `
      <span title="Количество баркодов, добавленных в поставку">Добавлено: <strong>${fmt(det.quantity)}</strong></span>
      | <span title="Количество баркодов, принятых на складе">Принято: ${acceptedHtml}</span>
      | <span title="Количество баркодов, поступивших в продажу">В продаже: <strong>${fmt(det.readyForSaleQuantity)}</strong></span>
      | <span title="Количество баркодов на раскладке">На раскладке: <strong>${fmt(det.unloadingQuantity)}</strong></span>
      | <span title="Количество коробов (упаковок) в поставке">Коробов: <strong>${(Array.isArray(data.packages)?data.packages.length:'-')}</strong></span>
    `;
    // packages
    const packDiv = detailsRow.querySelector(`.packages[data-for="${id}"]`);
    const packs = Array.isArray(data.packages)?data.packages:[];
    if(packs.length===0){ packDiv.textContent = 'Нет данных'; }
    else{
      const ul = document.createElement('ul'); ul.className='mb-2 list-unstyled';
      packs.forEach((p, idx)=>{
        // aggregate counts per barcode entry
        const code = p.packageCode || p.package_code || '';
        const qty = Number(p.quantity ?? 0);
        const barcodesArr = Array.isArray(p.barcodes)?p.barcodes:[];
        const totalPieces = barcodesArr.reduce((s,b)=> s + Number(b.quantity||0), 0);
        const itemsCount = barcodesArr.length;
        const li = document.createElement('li');
        li.className = 'package-toggle py-1';
        li.setAttribute('data-code', code);
        li.innerHTML = `<span class="pkg-arrow">▸</span><span class="fw-semibold">${code}</span> ${itemsCount} ${itemsCount===1?'Баркод':'Баркодов'}, ${totalPieces} шт.`;
        // hidden inner table
        const wrapper = document.createElement('div'); wrapper.className='mt-2 ms-4 package-content'; wrapper.style.display='none';
        const tbl = document.createElement('table'); tbl.className='table table-sm table-bordered mb-0';
        tbl.innerHTML = `
          <thead class="table-light">
            <tr>
              <th class="text-center">#</th>
              <th class="text-start">Артикул продавца</th>
              <th class="text-center">Артикул WB</th>
              <th class="text-center">Баркод</th>
              <th class="text-center">Кол-во</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = tbl.querySelector('tbody');
        // Enrich from goods list if available by barcode
        const goodsList = Array.isArray(data.goods)?data.goods:[];
        const goodsByBarcode = new Map();
        goodsList.forEach(g=>{ const bc = (g.barcode||'').trim(); if(bc) goodsByBarcode.set(bc, g); });
        barcodesArr.forEach((b, i)=>{
          const tr = document.createElement('tr');
          const g = goodsByBarcode.get(String(b.barcode||'').trim()) || {};
          const vendor = g.vendorCode || g.vendor_code || '';
          const nm = g.nmID || g.nmId || '';
          tr.innerHTML = `
            <td class="text-center">${i+1}</td>
            <td class="text-start">${vendor}</td>
            <td class="text-center">${nm}</td>
            <td class="text-center">${b.barcode||''}</td>
            <td class="text-center">${b.quantity ?? 0}</td>
          `;
          tbody.appendChild(tr);
        });
        wrapper.appendChild(tbl);
        li.appendChild(wrapper);
        // toggle
        li.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          // Если клик внутри таблицы — не сворачиваем, позволяем выделение
          if (ev.target.closest('.package-content')) return;
          const open = wrapper.style.display !== 'none';
          wrapper.style.display = open ? 'none' : '';
          const arrow = li.querySelector('.pkg-arrow'); if (arrow) arrow.textContent = open ? '▸' : '▾';
        });
        ul.appendChild(li);
      });
      packDiv.innerHTML=''; packDiv.appendChild(ul);
    }
    // goods
    const goods = Array.isArray(data.goods)?data.goods:[];
    goodsBody.innerHTML='';
    goods.forEach((g, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="text-center">${idx+1}</td>
        <td class="text-start">${g.vendorCode||g.vendor_code||''}</td>
        <td class="text-center">${g.nmID||g.nmId||''}</td>
        <td class="text-center">${g.barcode||''}</td>
        <td class="text-center">${g.quantity ?? g.acceptedQuantity ?? 0}</td>
      `;
      goodsBody.appendChild(tr);
    });
    goodsBody.setAttribute('data-loaded','1');
  }catch(err){
    if(goodsBody){
      goodsBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Ошибка загрузки</td></tr>';
    }
  }
});

// Инициализация данных с сервера для load more: захват из HTML в массив
(function bootstrapData(){
  try{
    const rows = Array.from(document.querySelectorAll('#supBody tr.supply-row'));
    supAll = rows.map((tr, idx)=>{
      const tds = tr.querySelectorAll('td');
      const statusSpan = tds[11]?.querySelector('span');
      return {
        supply_id: tds[1]?.textContent.trim(),
        type: tds[2]?.textContent.trim(),
        created_at: tds[3]?.textContent.trim(),
        total_goods: tds[4]?.textContent.trim(),
        accepted_goods: null, // Will be populated from API
        package_count: tds[5]?.textContent.trim(),
        warehouse: tds[6]?.textContent.trim(),
        acceptance_coefficient: tds[7]?.textContent.trim(),
        acceptance_cost: tds[8]?.textContent.trim(),
        planned_date: tds[9]?.textContent.trim(),
        fact_date: tds[10]?.textContent.trim(),
        status: statusSpan ? statusSpan.textContent.trim() : tds[11]?.textContent.trim()
      };
    });
    // Уже отрисовано сервером (считаем только строки поставок)
    rendered = rows.length;
    const moreBtn = document.getElementById('loadMoreBtn');
    if (moreBtn) moreBtn.disabled = false;
    // Асинхронно подгружаем полный список (до 50) для кнопки "Загрузить ещё"
    fetch('/api/fbw/supplies?cached=1', {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
      }
    }).then(r=>{
      if (!r.ok) {
        console.warn('Не удалось загрузить кэшированные данные:', r.status);
        return { items: [] };
      }
      return r.json();
    }).then(data=>{
      if (data && Array.isArray(data.items)) {
        supAll = data.items;
        if (moreBtn) moreBtn.disabled = false; // всегда активна, даже если в кэше только 10
      }
    }).catch(()=>{});
    // Ленивая подзагрузка количества коробов для уже отрисованных строк
    try{
      rows.forEach((tr)=>{
        const cell = tr.querySelector('td[data-pkg-cell]');
        if (cell && cell.textContent.trim() === '-') __enqueuePkgRow(tr);
      });
    }catch(_){}
    try{ recomputeStats(); }catch(_){}
  }catch(_){ supAll = []; }
})();

// Инициализация затухания и тултипов только для обрезанных названий складов
(function initTooltips(){
  try{
    const isTruncated = (el)=>{ try{ return el.scrollWidth > el.clientWidth; }catch(_){ return false; } };
    const initOrDestroyTooltip = (el)=>{
      try{
        const needs = isTruncated(el);
        // управляем fade и тултипом
        if (needs){
          el.classList.add('truncate-fade');
          el.setAttribute('title', el.getAttribute('data-full-name') || el.textContent || '');
          el.setAttribute('data-bs-toggle', 'tooltip');
          // если тултип ещё не создан — создаём
          if (!el._wbTooltipInstance){ el._wbTooltipInstance = new bootstrap.Tooltip(el); }
        } else {
          el.classList.remove('truncate-fade');
          // удалить тултип, если был
          if (el._wbTooltipInstance){ try{ el._wbTooltipInstance.dispose(); }catch(_){}; el._wbTooltipInstance = null; }
          el.removeAttribute('data-bs-toggle');
          el.removeAttribute('title');
        }
      }catch(_){ }
    };
    const whs = [].slice.call(document.querySelectorAll('.wh-name'));
    whs.forEach(el=>{
      initOrDestroyTooltip(el);
      const ro = new ResizeObserver(()=>{ initOrDestroyTooltip(el); });
      try{ ro.observe(el); }catch(_){ }
    });
  }catch(_){ }
})();

// Автоматическое обновление при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  // Небольшая задержка, чтобы страница полностью загрузилась
  setTimeout(() => {
    // Сначала пробуем загрузить кэшированные данные
    loadCachedData();
  }, 500);
});

// Функция для загрузки кэшированных данных
async function loadCachedData() {
  try {
    const res = await fetch('/api/fbw/supplies?cached=1', {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    if (res.ok) {
      const data = await res.json();
      if (data.items && data.items.length > 0) {
        supAll = data.items;
        rendered = 0;
        const tbody = document.getElementById('supBody');
        tbody.innerHTML = '';
        renderChunk(15);
        document.getElementById('lastUpdated').textContent = data.updated_at || '';
        try { recomputeStats(); } catch(_) {}
        return; // Успешно загрузили кэшированные данные
      }
    }
  } catch (e) {
    console.log('Не удалось загрузить кэшированные данные:', e);
  }
  
  // Если кэшированные данные недоступны, делаем полное обновление
  refresh();
}

</script>
</html>


