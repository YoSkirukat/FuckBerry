<!doctype html>
<html lang="ru">
<head>
  {% block title %}<title>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç</title>{% endblock %}
  {% include '_header.html' %}
  {% block extra_styles %}
  <style>
    input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0; position: absolute; right: 10px; width: 1.2em; height: 1.2em; }
    .table-fixed-head { max-height: 70vh; overflow: auto; }
    .mb-2 {
    margin-bottom: 1.4rem !important;
}
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
    .calendar-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      z-index: 1050;
      margin-top: 0.25rem;
      width: 320px;
      max-width: 90vw;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #dee2e6;
      background-color: #f8f9fa;
    }
    
    .calendar-nav {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      transition: background-color 0.15s ease-in-out;
    }
    
    .calendar-nav:hover {
      background-color: #e9ecef;
    }
    
    .calendar-grid {
      padding: 1rem;
    }
    
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.25rem;
      margin-bottom: 0.5rem;
    }
    
    .calendar-weekday {
      text-align: center;
      font-weight: 600;
      font-size: 0.875rem;
      color: #6c757d;
      padding: 0.5rem 0;
    }
    
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.25rem;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      transition: all 0.15s ease-in-out;
      position: relative;
    }
    
    .calendar-day:hover {
      background-color: #e9ecef;
    }
    
    .calendar-day.other-month {
      color: #adb5bd;
    }
    
    .calendar-day.today {
      background-color: #fff3cd;
      color: #856404;
      font-weight: 600;
    }
    
    .calendar-day.selected-start {
      background-color: #0d6efd;
      color: white;
      font-weight: 600;
    }
    
    .calendar-day.selected-end {
      background-color: #0d6efd;
      color: white;
      font-weight: 600;
    }
    
    .calendar-day.in-range {
      background-color: #e7f1ff;
      color: #0d6efd;
    }
    
    .calendar-day.in-range:not(.selected-start):not(.selected-end) {
      border-radius: 0;
    }
    
    .calendar-day.selected-start.in-range {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }
    
    .calendar-day.selected-end.in-range {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }
    
    .calendar-footer {
      display: flex;
      justify-content: space-between;
      padding: 1rem;
      border-top: 1px solid #dee2e6;
      background-color: #f8f9fa;
    }
    
    .calendar-day.weekend {
      color: #dc3545;
    }
    
    .calendar-day.other-month.weekend {
      color: #f5c6cb;
    }
    
    /* –ú–æ–±–∏–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
    @media (max-width: 768px) {
      .calendar-dropdown.mobile-centered {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: 90vw !important;
        max-width: 400px !important;
        z-index: 1060 !important;
        margin: 0 !important;
        box-shadow: 0 0.5rem 2rem rgba(0, 0, 0, 0.3) !important;
      }
      
      .calendar-dropdown.mobile-centered .calendar-grid {
        max-height: 60vh;
        overflow-y: auto;
      }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–æ–≤ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–π */
    .compensation-card .text-muted {
      color: #009688 !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–æ–≤ —É–¥–µ—Ä–∂–∞–Ω–∏–π */
    .deduction-card .text-muted {
      color: #ff574b !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∞ "–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é" */
    .for-pay-card {
      background-color: #90ee9040;
    }
    
    .for-pay-card .text-muted {
      color: #337736 !important;
      font-weight: bold;
      text-align: center;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(2px);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }
    
    .loading-content {
      text-align: center;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #666;
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    .content-blurred {
      filter: blur(1px);
      opacity: 0.6;
      transition: all 0.3s ease;
    }
  </style>
  {% endblock %}
  <script>
    // –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å –≤—ã–±–æ—Ä–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
    class DateRangeCalendar {
      constructor() {
        this.currentDate = new Date();
        this.selectedStart = null;
        this.selectedEnd = null;
        this.isSelecting = false;
        this.calendar = document.getElementById('fDateRangeCalendar');
        this.input = document.getElementById('fDateRangeInput');
        this.startInput = document.getElementById('fDateFrom');
        this.endInput = document.getElementById('fDateTo');
        this.btn = document.getElementById('fDateRangeBtn');
        this.grid = document.getElementById('calendarGrid');
        this.monthYear = document.getElementById('currentMonthYear');
        this.prevBtn = document.getElementById('prevMonth');
        this.nextBtn = document.getElementById('nextMonth');
        this.resetBtn = document.getElementById('resetDates');
        this.applyBtn = document.getElementById('applyDates');
        
        this.months = [
          '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
          '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
        ];
        
        this.weekdays = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
        
        this.init();
      }
      
      init() {
        if (!this.calendar || !this.input || !this.btn) {
          console.error('–ù–µ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞–π–¥–µ–Ω—ã!');
          return;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞—Ç—ã
        this.loadSavedDates();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        this.btn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleCalendar();
        });
        this.input.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleCalendar();
        });
        this.prevBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.prevMonth();
        });
        this.nextBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.nextMonth();
        });
        this.resetBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.resetSelection();
        });
        this.applyBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.applySelection();
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
          if (!this.calendar.contains(e.target) && 
              !this.input.contains(e.target) && 
              !this.btn.contains(e.target)) {
            this.hideCalendar();
          }
        });
        
        // –ü–µ—Ä–µ–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
          if (this.calendar.style.display === 'block') {
            this.adjustPosition();
          }
        });
        
        this.renderCalendar();
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ
        this.calendar.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }
      
      loadSavedDates() {
        const startVal = this.startInput.value;
        const endVal = this.endInput.value;
        
        if (startVal) {
          // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
          const [year, month, day] = startVal.split('-').map(Number);
          this.selectedStart = new Date(year, month - 1, day);
        }
        if (endVal) {
          // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
          const [year, month, day] = endVal.split('-').map(Number);
          this.selectedEnd = new Date(year, month - 1, day);
        }
        
        this.updateInputDisplay();
      }
      
      toggleCalendar() {
        if (this.calendar.style.display === 'none' || !this.calendar.style.display) {
          this.showCalendar();
        } else {
          this.hideCalendar();
        }
      }
      
      showCalendar() {
        this.calendar.style.display = 'block';
        this.renderCalendar();
        this.adjustPosition();
      }
      
      adjustPosition() {
        const rect = this.input.getBoundingClientRect();
        const calendar = this.calendar;
        const viewportHeight = window.innerHeight;
        const viewportWidth = window.innerWidth;
        const calendarHeight = 400; // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–±–∏–ª—å–Ω—ã–º
        const isMobile = viewportWidth <= 768;
        
        if (isMobile) {
          // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
          calendar.classList.add('mobile-centered');
          calendar.style.position = 'fixed';
          calendar.style.top = '50%';
          calendar.style.left = '50%';
          calendar.style.transform = 'translate(-50%, -50%)';
          calendar.style.width = '90vw';
          calendar.style.maxWidth = '400px';
          calendar.style.zIndex = '1060';
          calendar.style.margin = '0';
          calendar.style.boxShadow = '0 0.5rem 2rem rgba(0, 0, 0, 0.3)';
        } else {
          // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
          calendar.classList.remove('mobile-centered');
          calendar.style.position = 'absolute';
          calendar.style.transform = 'none';
          calendar.style.zIndex = '1050';
          calendar.style.boxShadow = '0 0.5rem 1rem rgba(0, 0, 0, 0.15)';
          
          // –ï—Å–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è —Å–Ω–∏–∑—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–µ—Ä—Ö—É
          if (rect.bottom + calendarHeight > viewportHeight) {
            calendar.style.top = 'auto';
            calendar.style.bottom = '100%';
            calendar.style.marginTop = '0';
            calendar.style.marginBottom = '0.25rem';
          } else {
            calendar.style.top = '100%';
            calendar.style.bottom = 'auto';
            calendar.style.marginTop = '0.25rem';
            calendar.style.marginBottom = '0';
          }
        }
      }
      
      hideCalendar() {
        this.calendar.style.display = 'none';
      }
      
      prevMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
        this.renderCalendar();
      }
      
      nextMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
        this.renderCalendar();
      }
      
      renderCalendar() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        
        this.monthYear.textContent = `${this.months[month]} ${year}`;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - (firstDay.getDay() + 6) % 7);
        
        let html = '<div class="calendar-weekdays">';
        this.weekdays.forEach(day => {
          html += `<div class="calendar-weekday">${day}</div>`;
        });
        html += '</div><div class="calendar-days">';
        
        const today = new Date();
        const currentDate = new Date(startDate);
        const currentMonth = month; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞
        
        for (let i = 0; i < 42; i++) {
          const isCurrentMonth = currentDate.getMonth() === currentMonth;
          const isToday = currentDate.toDateString() === today.toDateString();
          const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
          const isSelectedStart = this.selectedStart && currentDate.toDateString() === this.selectedStart.toDateString();
          const isSelectedEnd = this.selectedEnd && currentDate.toDateString() === this.selectedEnd.toDateString();
          const isInRange = this.isDateInRange(currentDate);
          
          let classes = 'calendar-day';
          if (!isCurrentMonth) classes += ' other-month';
          if (isToday) classes += ' today';
          if (isWeekend) classes += ' weekend';
          if (isSelectedStart) classes += ' selected-start';
          if (isSelectedEnd) classes += ' selected-end';
          if (isInRange) classes += ' in-range';
          
          // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –±–µ–∑ UTC –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
          const year = currentDate.getFullYear();
          const month = String(currentDate.getMonth() + 1).padStart(2, '0');
          const day = String(currentDate.getDate()).padStart(2, '0');
          const localDateStr = `${year}-${month}-${day}`;
          html += `<div class="${classes}" data-date="${localDateStr}">${currentDate.getDate()}</div>`;
          currentDate.setDate(currentDate.getDate() + 1);
        }
        
        html += '</div>';
        this.grid.innerHTML = html;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–Ω–µ–π
        this.grid.querySelectorAll('.calendar-day').forEach(day => {
          day.addEventListener('click', (e) => {
            e.stopPropagation();
            this.selectDate(day);
          });
        });
      }
      
      selectDate(dayElement) {
        const dateStr = dayElement.dataset.date;
        
        // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
        const [year, month, day] = dateStr.split('-').map(Number);
        const date = new Date(year, month - 1, day);
        
        if (!this.selectedStart || (this.selectedStart && this.selectedEnd)) {
          // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π –≤—ã–±–æ—Ä
          this.selectedStart = date;
          this.selectedEnd = null;
          this.isSelecting = true;
        } else if (this.selectedStart && !this.selectedEnd) {
          // –ó–∞–≤–µ—Ä—à–∞–µ–º –≤—ã–±–æ—Ä
          if (date < this.selectedStart) {
            this.selectedEnd = this.selectedStart;
            this.selectedStart = date;
          } else {
            this.selectedEnd = date;
          }
          this.isSelecting = false;
        }
        
        this.updateInputDisplay();
        this.renderCalendar();
      }
      
      isDateInRange(date) {
        if (!this.selectedStart || !this.selectedEnd) return false;
        return date >= this.selectedStart && date <= this.selectedEnd;
      }
      
      updateInputDisplay() {
        if (this.selectedStart && this.selectedEnd) {
          const startStr = this.formatDate(this.selectedStart);
          const endStr = this.formatDate(this.selectedEnd);
          this.input.value = `${startStr} - ${endStr}`;
        } else if (this.selectedStart) {
          const startStr = this.formatDate(this.selectedStart);
          this.input.value = `${startStr} - ...`;
        } else {
          this.input.value = '';
        }
      }
      
      formatDate(date) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –¥–∞—Ç—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏
        const localDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const day = String(localDate.getDate()).padStart(2, '0');
        const month = String(localDate.getMonth() + 1).padStart(2, '0');
        const year = localDate.getFullYear();
        return `${day}.${month}.${year}`;
      }
      
      resetSelection() {
        this.selectedStart = null;
        this.selectedEnd = null;
        this.isSelecting = false;
        this.startInput.value = '';
        this.endInput.value = '';
        this.updateInputDisplay();
        this.renderCalendar();
      }
      
      applySelection() {
        if (this.selectedStart) {
          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ ISO —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π
          const year = this.selectedStart.getFullYear();
          const month = String(this.selectedStart.getMonth() + 1).padStart(2, '0');
          const day = String(this.selectedStart.getDate()).padStart(2, '0');
          this.startInput.value = `${year}-${month}-${day}`;
        }
        if (this.selectedEnd) {
          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ ISO —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π
          const year = this.selectedEnd.getFullYear();
          const month = String(this.selectedEnd.getMonth() + 1).padStart(2, '0');
          const day = String(this.selectedEnd.getDate()).padStart(2, '0');
          this.endInput.value = `${year}-${month}-${day}`;
        }
        this.hideCalendar();
        this.validateDates();
      }
      
      validateDates() {
        const df = this.startInput?.value || '';
        const dt = this.endInput?.value || '';
        const dateWarn = document.getElementById('finDateWarn');
        const loadBtn = document.getElementById('financeLoadBtn');
        
        let ok = true; 
        let msg = '';
        
        if (df && dt && df > dt) {
          ok = false; 
          msg = '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞.';
        }
        if (!df || !dt) {
          ok = false; 
          msg = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –æ—Ç—á–µ—Ç–∞.';
        }
        
        if (!ok) {
          if (dateWarn) {
            dateWarn.textContent = msg; 
            dateWarn.style.display = 'block';
          }
          if (loadBtn) {
            loadBtn.disabled = true;
          }
        } else {
          if (dateWarn) {
            dateWarn.style.display = 'none'; 
            dateWarn.textContent = '';
          }
          if (loadBtn) {
            loadBtn.disabled = false;
          }
        }
        return ok;
      }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    let dateRangeCalendar;
    
    document.addEventListener('DOMContentLoaded', function(){
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
      dateRangeCalendar = new DateRangeCalendar();
      
      const form = document.getElementById('financeForm');
      const loadBtn = document.getElementById('financeLoadBtn');
      const exportBtn = document.getElementById('financeExportBtn');
      const dfInput = document.getElementById('fDateFrom');
      const dtInput = document.getElementById('fDateTo');
      const dateWarn = document.getElementById('finDateWarn');
      
      function fmtRu(ymd){
        if (!ymd) return '';
        const parts = String(ymd).split('-');
        if (parts.length !== 3) return ymd;
        const [y,m,d] = parts;
        return `${d}.${m}.${y}`;
      }
      
      function validateDates(){
        const df = dfInput?.value || '';
        const dt = dtInput?.value || '';
        // validate order
        let ok = true; let msg = '';
        if (df && dt && df > dt){ ok = false; msg = '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞.'; }
        if (!df || !dt){ ok = false; msg = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –æ—Ç—á–µ—Ç–∞.'; }
        if (!ok){
          if (dateWarn){ dateWarn.textContent = msg; dateWarn.style.display = 'block'; }
          if (loadBtn){ loadBtn.disabled = true; }
        } else {
          if (dateWarn){ dateWarn.style.display = 'none'; dateWarn.textContent = ''; }
          if (loadBtn){ loadBtn.disabled = false; }
        }
        return ok;
      }
      
      dfInput?.addEventListener('change', validateDates);
      dtInput?.addEventListener('change', validateDates);
      // initial validation
      validateDates();
      // hydrate UI from server-provided cached data (if any)
      try{
        const mnode = document.getElementById('finServerMetrics');
        const rnode = document.getElementById('finServerRows');
        if (mnode && rnode){
          const metrics = JSON.parse(mnode.textContent || '{}');
          const rowsSrv = JSON.parse(rnode.textContent || '[]');
          if (Array.isArray(rowsSrv) && rowsSrv.length){
            // mimic subset of API response
            const data = Object.assign({rows: rowsSrv}, metrics || {});
            // update important fields similarly to submit handler
            const revenueEl = document.getElementById('finRevenueVal'); if (revenueEl) revenueEl.textContent = ((Number(data.revenue)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const buyoutsEl = document.getElementById('finBuyoutsVal'); if (buyoutsEl) buyoutsEl.textContent = ((Number(data.total_buyouts)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const returnsEl = document.getElementById('finReturnsVal'); if (returnsEl) returnsEl.textContent = ((Number(data.total_returns)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const logisticsEl = document.getElementById('finLogisticsVal'); if (logisticsEl) logisticsEl.textContent = ((Number(data.total_logistics)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const storageEl = document.getElementById('finStorageVal'); if (storageEl) storageEl.textContent = ((Number(data.total_storage)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const acceptanceEl = document.getElementById('finAcceptanceVal'); if (acceptanceEl) acceptanceEl.textContent = ((Number(data.total_acceptance)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const acquiringEl = document.getElementById('finAcquiringVal'); if (acquiringEl) acquiringEl.textContent = ((Number(data.total_acquiring)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const otherDedEl = document.getElementById('finOtherDedVal'); if (otherDedEl) otherDedEl.textContent = ((Number(data.total_other_deductions)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const penaltiesEl = document.getElementById('finPenaltiesVal'); if (penaltiesEl) penaltiesEl.textContent = ((Number(data.total_penalties)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const addPayEl = document.getElementById('finAdditionalPayVal'); if (addPayEl) addPayEl.textContent = ((Number(data.total_additional_payment)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const defectCompEl = document.getElementById('finDefectCompVal'); if (defectCompEl) defectCompEl.textContent = ((Number(data.total_defect_compensation)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const damageCompEl = document.getElementById('finDamageCompVal'); if (damageCompEl) damageCompEl.textContent = ((Number(data.total_damage_compensation)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const paidDeliveryEl0 = document.getElementById('finPaidDeliveryVal'); if (paidDeliveryEl0) paidDeliveryEl0.textContent = ((Number(data.total_paid_delivery)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const commissionEl = document.getElementById('finCommissionVal'); if (commissionEl) commissionEl.textContent = ((Number(data.total_commission)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const wbRealEl = document.getElementById('finWbRealizedVal'); if (wbRealEl) wbRealEl.textContent = ((Number(data.total_wb_realized)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const wbDed = ((Number(data.total_commission)||0) + (Number(data.total_acquiring)||0) + (Number(data.total_logistics)||0) + (Number(data.total_storage)||0) + (Number(data.total_other_deductions)||0) + (Number(data.total_acceptance)||0) - (Number(data.total_defect_compensation)||0) - (Number(data.total_damage_compensation)||0) - (Number(data.total_paid_delivery)||0) + (Number(data.total_penalties)||0) + (Number(data.total_additional_payment)||0));
            const wbDedEl = document.getElementById('finWbDedTotal'); if (wbDedEl) wbDedEl.textContent = Number(wbDed).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            const forPayEl2 = document.getElementById('finForPayVal'); if (forPayEl2) forPayEl2.textContent = (Number(data.total_for_transfer || 0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
            const buyoutOps = new Set(['–ø—Ä–æ–¥–∞–∂–∞','—Å—Ç–æ—Ä–Ω–æ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤','–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞','–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –ø—Ä–æ–¥–∞–∂']);
            const buyoutsQty = rowsSrv.reduce((acc, r) => { const op = (r && r.supplier_oper_name ? String(r.supplier_oper_name).trim().toLowerCase() : ''); return acc + (buyoutOps.has(op) ? 1 : 0); }, 0);
            const buyoutsQtyEl = document.getElementById('finBuyoutsQty'); if (buyoutsQtyEl) buyoutsQtyEl.textContent = (Number(buyoutsQty).toLocaleString('ru-RU'));
            const returnOps = new Set(['–≤–æ–∑–≤—Ä–∞—Ç','—Å—Ç–æ—Ä–Ω–æ –ø—Ä–æ–¥–∞–∂','–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç']);
            const returnsQty = rowsSrv.reduce((acc, r) => { const op = (r && r.supplier_oper_name ? String(r.supplier_oper_name).trim().toLowerCase() : ''); return acc + (returnOps.has(op) ? 1 : 0); }, 0);
            const returnsQtyEl = document.getElementById('finReturnsQty'); if (returnsQtyEl) returnsQtyEl.textContent = (Number(returnsQty).toLocaleString('—Ä—É-RU'));
            const revenueQtyEl = document.getElementById('finRevenueQty'); if (revenueQtyEl) revenueQtyEl.textContent = (Number(Math.max(0, buyoutsQty - returnsQty)).toLocaleString('ru-RU'));
            const resWrap = document.getElementById('finResults'); if (resWrap) resWrap.style.display = rowsSrv.length ? 'block' : 'none';
            if (exportBtn) exportBtn.disabled = !(rowsSrv && rowsSrv.length > 0);
          }
        }
      } catch(e){}
      form?.addEventListener('submit', async function(e){
        e.preventDefault();
        if (!loadBtn) return;
        if (!validateDates()) return; // stop if dates invalid
        try{
          loadBtn.disabled = true; const prev = loadBtn.textContent; loadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Ä–∞–∑–º—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
          const overlay = document.getElementById('loadingOverlay');
          const content = document.querySelector('.container');
          const loadingText = overlay?.querySelector('.loading-text');
          if (overlay) overlay.style.display = 'flex';
          if (content) content.classList.add('content-blurred');
          if (loadingText) loadingText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
          
          const params = new URLSearchParams(new FormData(form));
          const res = await fetch(`/api/report/finance?${params.toString()}`);
          const data = await res.json();
          // error handling
          if (data && data.error){
            const alertBox = document.getElementById('finAlert');
            if (alertBox){ alertBox.textContent = data.error; alertBox.style.display = 'block'; }
          } else {
            const alertBox = document.getElementById('finAlert');
            if (alertBox){ alertBox.style.display = 'none'; alertBox.textContent = ''; }
          }
          const rows = (data.rows || []);
          const revenueEl = document.getElementById('finRevenueVal');
          if (revenueEl) revenueEl.textContent = ((Number(data.revenue)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const buyoutsEl = document.getElementById('finBuyoutsVal');
          if (buyoutsEl) buyoutsEl.textContent = ((Number(data.total_buyouts)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const returnsEl = document.getElementById('finReturnsVal');
          if (returnsEl) returnsEl.textContent = ((Number(data.total_returns)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          // –ö–æ–ª-–≤–æ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤: —Å—É–º–º–∏—Ä—É–µ–º –ø–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º –í–æ–∑–≤—Ä–∞—Ç, –°—Ç–æ—Ä–Ω–æ –ø—Ä–æ–¥–∞–∂, –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
          const returnOps = new Set(['–≤–æ–∑–≤—Ä–∞—Ç','—Å—Ç–æ—Ä–Ω–æ –ø—Ä–æ–¥–∞–∂','–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç']);
          const returnsQty = rows.reduce((acc, r) => {
            const op = (r && r.supplier_oper_name ? String(r.supplier_oper_name).trim().toLowerCase() : '');
            return acc + (returnOps.has(op) ? 1 : 0);
          }, 0);
          const returnsQtyEl = document.getElementById('finReturnsQty');
          if (returnsQtyEl) returnsQtyEl.textContent = (Number(returnsQty).toLocaleString('ru-RU'));
          const wbRealEl = document.getElementById('finWbRealizedVal');
          if (wbRealEl) wbRealEl.textContent = ((Number(data.total_wb_realized)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const logisticsEl = document.getElementById('finLogisticsVal');
          if (logisticsEl) logisticsEl.textContent = ((Number(data.total_logistics)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const logisticsPctEl = document.getElementById('finLogisticsPct');
          if (logisticsPctEl){
            const revL = Number(data.revenue)||0; const vL = Number(data.total_logistics)||0;
            logisticsPctEl.textContent = (revL ? (vL/revL*100) : 0).toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' %';
          }
          const storageEl = document.getElementById('finStorageVal');
          if (storageEl) storageEl.textContent = ((Number(data.total_storage)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const storagePctEl = document.getElementById('finStoragePct');
          if (storagePctEl){
            const revS = Number(data.revenue)||0; const vS = Number(data.total_storage)||0;
            storagePctEl.textContent = (revS ? (vS/revS*100) : 0).toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' %';
          }
          const acceptanceEl = document.getElementById('finAcceptanceVal');
          if (acceptanceEl) acceptanceEl.textContent = ((Number(data.total_acceptance)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const acceptancePctEl = document.getElementById('finAcceptancePct');
          if (acceptancePctEl){
            const revA = Number(data.revenue)||0; const vA = Number(data.total_acceptance)||0;
            acceptancePctEl.textContent = (revA ? (vA/revA*100) : 0).toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' %';
          }
          const forPayEl = document.getElementById('finForPayVal');
          if (forPayEl) forPayEl.textContent = ((Number(data.total_for_transfer)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const acquiringEl = document.getElementById('finAcquiringVal');
          if (acquiringEl) acquiringEl.textContent = ((Number(data.total_acquiring)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const acquiringPctEl = document.getElementById('finAcquiringPct');
          if (acquiringPctEl){
            const rev = Number(data.revenue)||0;
            const acq = Number(data.total_acquiring)||0;
            const pctA = rev ? (acq / rev) * 100 : 0;
            acquiringPctEl.textContent = pctA.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' %';
          }
          const otherDedEl = document.getElementById('finOtherDedVal');
          if (otherDedEl) otherDedEl.textContent = ((Number(data.total_other_deductions)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const otherDedPctEl = document.getElementById('finOtherDedPct');
          if (otherDedPctEl){
            const revO = Number(data.revenue)||0; const vO = Number(data.total_other_deductions)||0;
            otherDedPctEl.textContent = (revO ? (vO/revO*100) : 0).toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' %';
          }
          const penaltiesEl = document.getElementById('finPenaltiesVal');
          if (penaltiesEl) penaltiesEl.textContent = ((Number(data.total_penalties)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const addPayEl = document.getElementById('finAdditionalPayVal');
          if (addPayEl) addPayEl.textContent = ((Number(data.total_additional_payment)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const defectCompEl = document.getElementById('finDefectCompVal');
          if (defectCompEl) defectCompEl.textContent = ((Number(data.total_defect_compensation)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const damageCompEl = document.getElementById('finDamageCompVal');
          if (damageCompEl) damageCompEl.textContent = ((Number(data.total_damage_compensation)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const paidDeliveryElS = document.getElementById('finPaidDeliveryVal');
          if (paidDeliveryElS) paidDeliveryElS.textContent = ((Number(data.total_paid_delivery)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const commissionEl = document.getElementById('finCommissionVal');
          if (commissionEl) commissionEl.textContent = ((Number(data.total_commission)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');
          const commissionPctEl = document.getElementById('finCommissionPct');
          if (commissionPctEl){
            const rev = Number(data.revenue)||0;
            const comm = Number(data.total_commission)||0;
            const pct = rev ? (comm / rev) * 100 : 0;
            commissionPctEl.textContent = pct.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' %';
          }
          // –ò—Ç–æ–≥ –ø–æ –±–ª–æ–∫—É –£–¥–µ—Ä–∂–∞–Ω–∏—è –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ WB
          const wbDed = (
            (Number(data.total_commission)||0)
            + (Number(data.total_acquiring)||0)
            + (Number(data.total_logistics)||0)
            + (Number(data.total_storage)||0)
            + (Number(data.total_other_deductions)||0)
            + (Number(data.total_acceptance)||0)
            - (Number(data.total_defect_compensation)||0)
            - (Number(data.total_damage_compensation)||0)
            - (Number(data.total_paid_delivery)||0)
            + (Number(data.total_penalties)||0)
            + (Number(data.total_additional_payment)||0)
          );
          const wbDedEl = document.getElementById('finWbDedTotal');
          if (wbDedEl) wbDedEl.textContent = Number(wbDed).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
          const wbDedPctEl = document.getElementById('finWbDedPct');
          if (wbDedPctEl){
            const revW = Number(data.revenue)||0; const pW = revW ? (wbDed/revW*100) : 0;
            wbDedPctEl.textContent = pW.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' %';
          }
          // –ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é = –í—ã—Ä—É—á–∫–∞ - –£–¥–µ—Ä–∂–∞–Ω–∏—è + E3 (–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞)
          const forPayEl2 = document.getElementById('finForPayVal');
          if (forPayEl2) forPayEl2.textContent = (Number(data.total_for_transfer || 0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' —Ä—É–±.');

          // –ö–æ–ª-–≤–æ –≤—ã–∫—É–ø–æ–≤ (—à—Ç.) = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ —Å supplier_oper_name –≤ –Ω—É–∂–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö
          const buyoutOps = new Set(['–ø—Ä–æ–¥–∞–∂–∞','—Å—Ç–æ—Ä–Ω–æ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤','–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞','–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –ø—Ä–æ–¥–∞–∂']);
          const buyoutsQty = rows.reduce((acc, r) => {
            const op = (r && r.supplier_oper_name ? String(r.supplier_oper_name).trim().toLowerCase() : '');
            return acc + (buyoutOps.has(op) ? 1 : 0);
          }, 0);
          const buyoutsQtyEl = document.getElementById('finBuyoutsQty');
          if (buyoutsQtyEl) buyoutsQtyEl.textContent = (Number(buyoutsQty).toLocaleString('ru-RU'));
          // –ö–æ–ª-–≤–æ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ ‚Äî —É–∂–µ –ø–æ—Å—á–∏—Ç–∞–Ω–æ –≤—ã—à–µ –∫–∞–∫ returnsQty
          const revenueQtyEl = document.getElementById('finRevenueQty');
          if (revenueQtyEl) revenueQtyEl.textContent = (Number(Math.max(0, buyoutsQty - (returnsQty || 0))).toLocaleString('ru-RU'));
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          const resWrap = document.getElementById('finResults');
          if (resWrap) resWrap.style.display = rows.length ? 'block' : 'none';
          if (exportBtn) exportBtn.disabled = !(rows && rows.length > 0);
          loadBtn.textContent = prev; loadBtn.disabled = false;
          
          // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —É–±–∏—Ä–∞–µ–º —Ä–∞–∑–º—ã—Ç–∏–µ
          if (overlay) overlay.style.display = 'none';
          if (content) content.classList.remove('content-blurred');
        } catch(err){
          console.error(err);
          const alertBox = document.getElementById('finAlert');
          if (alertBox){ alertBox.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á—ë—Ç–∞'; alertBox.style.display = 'block'; }
          if (loadBtn){ loadBtn.disabled = false; }
          
          // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —É–±–∏—Ä–∞–µ–º —Ä–∞–∑–º—ã—Ç–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
          if (overlay) overlay.style.display = 'none';
          if (content) content.classList.remove('content-blurred');
        }
      });
    });
  </script>
  <script type="application/json" id="finServerRows">{{ (rows or []) | tojson | safe }}</script>
  <script type="application/json" id="finServerMetrics">{{ (finance_metrics or {}) | tojson | safe }}</script>
  <script>
    function submitExport(){
      const form = document.getElementById('financeForm');
      if (!form) return;
      const a = document.createElement('a');
      const params = new URLSearchParams(new FormData(form));
      a.href = `/report/finance/export?${params.toString()}`;
      a.click();
    }
  </script>
</head>
<body>
  {% include '_navbar.html' %}
  <div class="container mt-3">
    <h1 class="mb-3" style="font-size:1.6rem;">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç</h1>
    {% if error %}
      <div class="alert alert-warning">{{ error }}</div>
    {% endif %}

    <form class="row g-3 mb-3" id="financeForm" method="get" action="/report/finance">
      <div class="col-sm-3 col-md-3">
        <label class="form-label">–ü–µ—Ä–∏–æ–¥ –æ—Ç—á–µ—Ç–∞</label>
        <div class="position-relative" style="position: relative !important;">
          <input type="text" class="form-control" id="fDateRangeInput" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥" readonly style="cursor: pointer;" />
          <input type="hidden" name="date_from" id="fDateFrom" value="{{ date_from_val or '' }}" />
          <input type="hidden" name="date_to" id="fDateTo" value="{{ date_to_val or '' }}" />
          <span class="position-absolute top-50 end-0 translate-middle-y me-3" style="cursor: pointer;" id="fDateRangeBtn">üìÖ</span>
          <div id="fDateRangeCalendar" class="calendar-dropdown" style="display: none;">
          <div class="calendar-header">
            <button type="button" class="calendar-nav" id="prevMonth">‚Äπ</button>
            <span id="currentMonthYear">–°–µ–Ω—Ç—è–±—Ä—å 2025</span>
            <button type="button" class="calendar-nav" id="nextMonth">‚Ä∫</button>
          </div>
          <div class="calendar-grid" id="calendarGrid">
            <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è JavaScript -->
          </div>
          <div class="calendar-footer">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="resetDates">–°–±—Ä–æ—Å–∏—Ç—å</button>
            <button type="button" class="btn btn-sm btn-primary" id="applyDates">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          </div>
          </div>
        </div>
      </div>
      <div class="col-sm-2 col-md-2 d-flex align-items-end">
        <button id="financeLoadBtn" class="btn btn-primary w-100" type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>
      <div class="col-sm-2 col-md-2 d-flex align-items-end">
        <button id="financeExportBtn" type="button" class="btn btn-success w-100" onclick="submitExport()" {% if not rows or not rows|length %}disabled{% endif %}>–°–∫–∞—á–∞—Ç—å XLS</button>
      </div>
    </form>

    <div id="finDateWarn" class="alert alert-warning py-1" role="alert" style="display:none;"></div>

    <div id="finAlert" class="alert alert-warning" role="alert" style="display:none;"></div>
    <div id="finResults" {% if rows and rows|length %}style="display:block;"{% else %}style="display:none;"{% endif %}>
      <h5 class="mb-2">–ü—Ä–æ–¥–∞–∂–∏</h5>
      <div class="row g-3 mb-3">
        <div class="col-12 col-md-2">
          <div class="card h-100"><div class="card-body">
            <div class="text-muted">–í—ã—Ä—É—á–∫–∞</div>
            <div class="fs-6"><strong id="finRevenueVal">0</strong></div>
            <div class="text-muted small">–ö–æ–ª-–≤–æ: <span id="finRevenueQty">0</span> —à—Ç.</div>
          </div></div>
        </div>
        <div class="col-6 col-md-2">
          <div class="card h-100"><div class="card-body">
            <div class="text-muted">–í—ã–∫—É–ø—ã</div>
            <div class="fs-6"><strong id="finBuyoutsVal">0</strong></div>
            <div class="text-muted small">–ö–æ–ª-–≤–æ: <span id="finBuyoutsQty">0</span> —à—Ç.</div>
          </div></div>
        </div>
        <div class="col-6 col-md-2">
          <div class="card h-100"><div class="card-body">
            <div class="text-muted">–í–æ–∑–≤—Ä–∞—Ç—ã</div>
            <div class="fs-6"><strong id="finReturnsVal">0</strong></div>
            <div class="text-muted small">–ö–æ–ª-–≤–æ: <span id="finReturnsQty">0</span> —à—Ç.</div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card h-100"><div class="card-body">
            <div class="text-muted">WB —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª</div>
            <div class="fs-6"><strong id="finWbRealizedVal">0</strong></div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card h-100 for-pay-card"><div class="card-body">
            <div class="text-muted">–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –Ω–∞ —Ä/—Å</div>
            <div class="fs-4" style="text-align: center;"><strong id="finForPayVal">0</strong></div>
          </div></div>
        </div>
      </div>
      <hr/>
      <h5 class="mb-2">–£–¥–µ—Ä–∂–∞–Ω–∏—è –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ WB <span class="text-muted">(<span id="finWbDedTotal">0</span> —Ä—É–±., <span id="finWbDedPct">0,00 %</span> –æ—Ç –≤—ã—Ä—É—á–∫–∏)</span></h5>
      <div class="row g-3">
        <div class="col-12 col-md-3">
          <div class="card h-100 compensation-card"><div class="card-body">
            <div class="text-muted">–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –±—Ä–∞–∫–∞</div>
            <div class="fs-6"><strong id="finDefectCompVal">0</strong></div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card h-100 compensation-card"><div class="card-body">
            <div class="text-muted">–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è —É—â–µ—Ä–±–∞</div>
            <div class="fs-6"><strong id="finDamageCompVal">0</strong></div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card h-100 compensation-card"><div class="card-body">
            <div class="text-muted">–ü–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</div>
            <div class="fs-6"><strong id="finPaidDeliveryVal">0</strong></div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">–ö–æ–º–∏—Å—Å–∏—è</div>
            <div class="fs-6"><strong id="finCommissionVal">0</strong></div>
            <div class="small">–û—Ç –≤—ã—Ä—É—á–∫–∏: <span id="finCommissionPct">0,00 %</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">–õ–æ–≥–∏—Å—Ç–∏–∫–∞</div>
            <div class="fs-6"><strong id="finLogisticsVal">0</strong></div>
            <div class="small">–û—Ç –≤—ã—Ä—É—á–∫–∏: <span id="finLogisticsPct">0,00 %</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">–•—Ä–∞–Ω–µ–Ω–∏–µ</div>
            <div class="fs-6"><strong id="finStorageVal">0</strong></div>
            <div class="small">–û—Ç –≤—ã—Ä—É—á–∫–∏: <span id="finStoragePct">0,00 %</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">–ü—Ä–∏—ë–º–∫–∞</div>
            <div class="fs-6"><strong id="finAcceptanceVal">0</strong></div>
            <div class="small">–û—Ç –≤—ã—Ä—É—á–∫–∏: <span id="finAcceptancePct">0,00 %</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">–≠–∫–≤–∞–π—Ä–∏–Ω–≥</div>
            <div class="fs-6"><strong id="finAcquiringVal">0</strong></div>
            <div class="small">–û—Ç –≤—ã—Ä—É—á–∫–∏: <span id="finAcquiringPct">0,00 %</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">–ü—Ä–æ—á–∏–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è</div>
            <div class="fs-6"><strong id="finOtherDedVal">0</strong></div>
            <div class="small">–û—Ç –≤—ã—Ä—É—á–∫–∏: <span id="finOtherDedPct">0,00 %</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">–®—Ç—Ä–∞—Ñ—ã</div>
            <div class="fs-6"><strong id="finPenaltiesVal">0</strong></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">–î–æ–ø–ª–∞—Ç–∞</div>
            <div class="fs-6"><strong id="finAdditionalPayVal">0</strong></div>
          </div></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>
  </div>
  
  {% include '_footer.html' %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


