<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Финансовый отчёт</title>
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0; position: absolute; right: 10px; width: 1.2em; height: 1.2em; }
    .table-fixed-head { max-height: 70vh; overflow: auto; }
    .mb-2 {
    margin-bottom: 1.4rem !important;
}
    
    /* Стили для выпадающего календаря */
    .calendar-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      z-index: 1050;
      margin-top: 0.25rem;
      width: 320px;
      max-width: 90vw;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #dee2e6;
      background-color: #f8f9fa;
    }
    
    .calendar-nav {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      transition: background-color 0.15s ease-in-out;
    }
    
    .calendar-nav:hover {
      background-color: #e9ecef;
    }
    
    .calendar-grid {
      padding: 1rem;
    }
    
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.25rem;
      margin-bottom: 0.5rem;
    }
    
    .calendar-weekday {
      text-align: center;
      font-weight: 600;
      font-size: 0.875rem;
      color: #6c757d;
      padding: 0.5rem 0;
    }
    
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.25rem;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      transition: all 0.15s ease-in-out;
      position: relative;
    }
    
    .calendar-day:hover {
      background-color: #e9ecef;
    }
    
    .calendar-day.other-month {
      color: #adb5bd;
    }
    
    .calendar-day.today {
      background-color: #fff3cd;
      color: #856404;
      font-weight: 600;
    }
    
    .calendar-day.selected-start {
      background-color: #0d6efd;
      color: white;
      font-weight: 600;
    }
    
    .calendar-day.selected-end {
      background-color: #0d6efd;
      color: white;
      font-weight: 600;
    }
    
    .calendar-day.in-range {
      background-color: #e7f1ff;
      color: #0d6efd;
    }
    
    .calendar-day.in-range:not(.selected-start):not(.selected-end) {
      border-radius: 0;
    }
    
    .calendar-day.selected-start.in-range {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }
    
    .calendar-day.selected-end.in-range {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }
    
    .calendar-footer {
      display: flex;
      justify-content: space-between;
      padding: 1rem;
      border-top: 1px solid #dee2e6;
      background-color: #f8f9fa;
    }
    
    .calendar-day.weekend {
      color: #dc3545;
    }
    
    .calendar-day.other-month.weekend {
      color: #f5c6cb;
    }
    
    /* Мобильное позиционирование календаря */
    @media (max-width: 768px) {
      .calendar-dropdown.mobile-centered {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: 90vw !important;
        max-width: 400px !important;
        z-index: 1060 !important;
        margin: 0 !important;
        box-shadow: 0 0.5rem 2rem rgba(0, 0, 0, 0.3) !important;
      }
      
      .calendar-dropdown.mobile-centered .calendar-grid {
        max-height: 60vh;
        overflow-y: auto;
      }
    }
  </style>
  <script>
    // Календарь с выбором диапазона дат
    class DateRangeCalendar {
      constructor() {
        this.currentDate = new Date();
        this.selectedStart = null;
        this.selectedEnd = null;
        this.isSelecting = false;
        this.calendar = document.getElementById('fDateRangeCalendar');
        this.input = document.getElementById('fDateRangeInput');
        this.startInput = document.getElementById('fDateFrom');
        this.endInput = document.getElementById('fDateTo');
        this.btn = document.getElementById('fDateRangeBtn');
        this.grid = document.getElementById('calendarGrid');
        this.monthYear = document.getElementById('currentMonthYear');
        this.prevBtn = document.getElementById('prevMonth');
        this.nextBtn = document.getElementById('nextMonth');
        this.resetBtn = document.getElementById('resetDates');
        this.applyBtn = document.getElementById('applyDates');
        
        this.months = [
          'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
          'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
        ];
        
        this.weekdays = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
        
        this.init();
      }
      
      init() {
        if (!this.calendar || !this.input || !this.btn) {
          console.error('Не все элементы календаря найдены!');
          return;
        }
        
        // Загружаем сохраненные даты
        this.loadSavedDates();
        
        // Обработчики событий
        this.btn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleCalendar();
        });
        this.input.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleCalendar();
        });
        this.prevBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.prevMonth();
        });
        this.nextBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.nextMonth();
        });
        this.resetBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.resetSelection();
        });
        this.applyBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.applySelection();
        });
        
        // Закрытие календаря при клике вне его
        document.addEventListener('click', (e) => {
          if (!this.calendar.contains(e.target) && 
              !this.input.contains(e.target) && 
              !this.btn.contains(e.target)) {
            this.hideCalendar();
          }
        });
        
        // Перепозиционирование при изменении размера окна
        window.addEventListener('resize', () => {
          if (this.calendar.style.display === 'block') {
            this.adjustPosition();
          }
        });
        
        this.renderCalendar();
        
        // Предотвращаем закрытие календаря при клике внутри него
        this.calendar.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }
      
      loadSavedDates() {
        const startVal = this.startInput.value;
        const endVal = this.endInput.value;
        
        if (startVal) {
          // Создаем дату в локальном часовом поясе
          const [year, month, day] = startVal.split('-').map(Number);
          this.selectedStart = new Date(year, month - 1, day);
        }
        if (endVal) {
          // Создаем дату в локальном часовом поясе
          const [year, month, day] = endVal.split('-').map(Number);
          this.selectedEnd = new Date(year, month - 1, day);
        }
        
        this.updateInputDisplay();
      }
      
      toggleCalendar() {
        if (this.calendar.style.display === 'none' || !this.calendar.style.display) {
          this.showCalendar();
        } else {
          this.hideCalendar();
        }
      }
      
      showCalendar() {
        this.calendar.style.display = 'block';
        this.renderCalendar();
        this.adjustPosition();
      }
      
      adjustPosition() {
        const rect = this.input.getBoundingClientRect();
        const calendar = this.calendar;
        const viewportHeight = window.innerHeight;
        const viewportWidth = window.innerWidth;
        const calendarHeight = 400; // Примерная высота календаря
        
        // Проверяем, является ли устройство мобильным
        const isMobile = viewportWidth <= 768;
        
        if (isMobile) {
          // На мобильных устройствах центрируем календарь
          calendar.classList.add('mobile-centered');
          calendar.style.position = 'fixed';
          calendar.style.top = '50%';
          calendar.style.left = '50%';
          calendar.style.transform = 'translate(-50%, -50%)';
          calendar.style.width = '90vw';
          calendar.style.maxWidth = '400px';
          calendar.style.zIndex = '1060';
          calendar.style.margin = '0';
          calendar.style.boxShadow = '0 0.5rem 2rem rgba(0, 0, 0, 0.3)';
        } else {
          // На десктопе используем обычное позиционирование
          calendar.classList.remove('mobile-centered');
          calendar.style.position = 'absolute';
          calendar.style.transform = 'none';
          calendar.style.zIndex = '1050';
          calendar.style.boxShadow = '0 0.5rem 1rem rgba(0, 0, 0, 0.15)';
          
          // Если календарь не помещается снизу, показываем сверху
          if (rect.bottom + calendarHeight > viewportHeight) {
            calendar.style.top = 'auto';
            calendar.style.bottom = '100%';
            calendar.style.marginTop = '0';
            calendar.style.marginBottom = '0.25rem';
          } else {
            calendar.style.top = '100%';
            calendar.style.bottom = 'auto';
            calendar.style.marginTop = '0.25rem';
            calendar.style.marginBottom = '0';
          }
        }
      }
      
      hideCalendar() {
        this.calendar.style.display = 'none';
      }
      
      prevMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
        this.renderCalendar();
      }
      
      nextMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
        this.renderCalendar();
      }
      
      renderCalendar() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        
        this.monthYear.textContent = `${this.months[month]} ${year}`;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - (firstDay.getDay() + 6) % 7);
        
        let html = '<div class="calendar-weekdays">';
        this.weekdays.forEach(day => {
          html += `<div class="calendar-weekday">${day}</div>`;
        });
        html += '</div><div class="calendar-days">';
        
        const today = new Date();
        const currentDate = new Date(startDate);
        const currentMonth = month; // Сохраняем значение месяца
        
        for (let i = 0; i < 42; i++) {
          const isCurrentMonth = currentDate.getMonth() === currentMonth;
          const isToday = currentDate.toDateString() === today.toDateString();
          const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
          const isSelectedStart = this.selectedStart && currentDate.toDateString() === this.selectedStart.toDateString();
          const isSelectedEnd = this.selectedEnd && currentDate.toDateString() === this.selectedEnd.toDateString();
          const isInRange = this.isDateInRange(currentDate);
          
          let classes = 'calendar-day';
          if (!isCurrentMonth) classes += ' other-month';
          if (isToday) classes += ' today';
          if (isWeekend) classes += ' weekend';
          if (isSelectedStart) classes += ' selected-start';
          if (isSelectedEnd) classes += ' selected-end';
          if (isInRange) classes += ' in-range';
          
          // Создаем дату в локальном формате без UTC конвертации
          const year = currentDate.getFullYear();
          const month = String(currentDate.getMonth() + 1).padStart(2, '0');
          const day = String(currentDate.getDate()).padStart(2, '0');
          const localDateStr = `${year}-${month}-${day}`;
          html += `<div class="${classes}" data-date="${localDateStr}">${currentDate.getDate()}</div>`;
          currentDate.setDate(currentDate.getDate() + 1);
        }
        
        html += '</div>';
        this.grid.innerHTML = html;
        
        // Добавляем обработчики для дней
        this.grid.querySelectorAll('.calendar-day').forEach(day => {
          day.addEventListener('click', (e) => {
            e.stopPropagation();
            this.selectDate(day);
          });
        });
      }
      
      selectDate(dayElement) {
        const dateStr = dayElement.dataset.date;
        
        // Создаем дату в локальном часовом поясе
        const [year, month, day] = dateStr.split('-').map(Number);
        const date = new Date(year, month - 1, day);
        
        if (!this.selectedStart || (this.selectedStart && this.selectedEnd)) {
          // Начинаем новый выбор
          this.selectedStart = date;
          this.selectedEnd = null;
          this.isSelecting = true;
        } else if (this.selectedStart && !this.selectedEnd) {
          // Завершаем выбор
          if (date < this.selectedStart) {
            this.selectedEnd = this.selectedStart;
            this.selectedStart = date;
          } else {
            this.selectedEnd = date;
          }
          this.isSelecting = false;
        }
        
        this.updateInputDisplay();
        this.renderCalendar();
      }
      
      isDateInRange(date) {
        if (!this.selectedStart || !this.selectedEnd) return false;
        return date >= this.selectedStart && date <= this.selectedEnd;
      }
      
      updateInputDisplay() {
        if (this.selectedStart && this.selectedEnd) {
          const startStr = this.formatDate(this.selectedStart);
          const endStr = this.formatDate(this.selectedEnd);
          this.input.value = `${startStr} - ${endStr}`;
        } else if (this.selectedStart) {
          const startStr = this.formatDate(this.selectedStart);
          this.input.value = `${startStr} - ...`;
        } else {
          this.input.value = '';
        }
      }
      
      formatDate(date) {
        // Используем локальную дату, чтобы избежать проблем с часовыми поясами
        const localDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const day = String(localDate.getDate()).padStart(2, '0');
        const month = String(localDate.getMonth() + 1).padStart(2, '0');
        const year = localDate.getFullYear();
        return `${day}.${month}.${year}`;
      }
      
      resetSelection() {
        this.selectedStart = null;
        this.selectedEnd = null;
        this.isSelecting = false;
        this.startInput.value = '';
        this.endInput.value = '';
        this.updateInputDisplay();
        this.renderCalendar();
      }
      
      applySelection() {
        if (this.selectedStart) {
          // Форматируем дату в ISO формате для скрытых полей
          const year = this.selectedStart.getFullYear();
          const month = String(this.selectedStart.getMonth() + 1).padStart(2, '0');
          const day = String(this.selectedStart.getDate()).padStart(2, '0');
          this.startInput.value = `${year}-${month}-${day}`;
        }
        if (this.selectedEnd) {
          // Форматируем дату в ISO формате для скрытых полей
          const year = this.selectedEnd.getFullYear();
          const month = String(this.selectedEnd.getMonth() + 1).padStart(2, '0');
          const day = String(this.selectedEnd.getDate()).padStart(2, '0');
          this.endInput.value = `${year}-${month}-${day}`;
        }
        this.hideCalendar();
        this.validateDates();
      }
      
      validateDates() {
        const df = this.startInput?.value || '';
        const dt = this.endInput?.value || '';
        const dateWarn = document.getElementById('finDateWarn');
        const loadBtn = document.getElementById('financeLoadBtn');
        
        let ok = true; 
        let msg = '';
        
        if (df && dt && df > dt) {
          ok = false; 
          msg = 'Дата окончания не может быть раньше даты начала.';
        }
        if (!df || !dt) {
          ok = false; 
          msg = 'Выберите период отчета.';
        }
        
        if (!ok) {
          if (dateWarn) {
            dateWarn.textContent = msg; 
            dateWarn.style.display = 'block';
          }
          if (loadBtn) {
            loadBtn.disabled = true;
          }
        } else {
          if (dateWarn) {
            dateWarn.style.display = 'none'; 
            dateWarn.textContent = '';
          }
          if (loadBtn) {
            loadBtn.disabled = false;
          }
        }
        return ok;
      }
    }
    
    // Инициализация календаря
    let dateRangeCalendar;
    
    document.addEventListener('DOMContentLoaded', function(){
      // Инициализируем календарь
      dateRangeCalendar = new DateRangeCalendar();
      
      const form = document.getElementById('financeForm');
      const loadBtn = document.getElementById('financeLoadBtn');
      const exportBtn = document.getElementById('financeExportBtn');
      const dfInput = document.getElementById('fDateFrom');
      const dtInput = document.getElementById('fDateTo');
      const dateWarn = document.getElementById('finDateWarn');
      
      function fmtRu(ymd){
        if (!ymd) return '';
        const parts = String(ymd).split('-');
        if (parts.length !== 3) return ymd;
        const [y,m,d] = parts;
        return `${d}.${m}.${y}`;
      }
      
      function validateDates(){
        const df = dfInput?.value || '';
        const dt = dtInput?.value || '';
        // validate order
        let ok = true; let msg = '';
        if (df && dt && df > dt){ ok = false; msg = 'Дата окончания не может быть раньше даты начала.'; }
        if (!df || !dt){ ok = false; msg = 'Выберите период отчета.'; }
        if (!ok){
          if (dateWarn){ dateWarn.textContent = msg; dateWarn.style.display = 'block'; }
          if (loadBtn){ loadBtn.disabled = true; }
        } else {
          if (dateWarn){ dateWarn.style.display = 'none'; dateWarn.textContent = ''; }
          if (loadBtn){ loadBtn.disabled = false; }
        }
        return ok;
      }
      
      dfInput?.addEventListener('change', validateDates);
      dtInput?.addEventListener('change', validateDates);
      // initial validation
      validateDates();
      // hydrate UI from server-provided cached data (if any)
      try{
        const mnode = document.getElementById('finServerMetrics');
        const rnode = document.getElementById('finServerRows');
        if (mnode && rnode){
          const metrics = JSON.parse(mnode.textContent || '{}');
          const rowsSrv = JSON.parse(rnode.textContent || '[]');
          if (Array.isArray(rowsSrv) && rowsSrv.length){
            // mimic subset of API response
            const data = Object.assign({rows: rowsSrv}, metrics || {});
            // update important fields similarly to submit handler
            const revenueEl = document.getElementById('finRevenueVal'); if (revenueEl) revenueEl.textContent = ((Number(data.revenue)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const buyoutsEl = document.getElementById('finBuyoutsVal'); if (buyoutsEl) buyoutsEl.textContent = ((Number(data.total_buyouts)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const returnsEl = document.getElementById('finReturnsVal'); if (returnsEl) returnsEl.textContent = ((Number(data.total_returns)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const logisticsEl = document.getElementById('finLogisticsVal'); if (logisticsEl) logisticsEl.textContent = ((Number(data.total_logistics)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const storageEl = document.getElementById('finStorageVal'); if (storageEl) storageEl.textContent = ((Number(data.total_storage)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const acceptanceEl = document.getElementById('finAcceptanceVal'); if (acceptanceEl) acceptanceEl.textContent = ((Number(data.total_acceptance)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const acquiringEl = document.getElementById('finAcquiringVal'); if (acquiringEl) acquiringEl.textContent = ((Number(data.total_acquiring)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const otherDedEl = document.getElementById('finOtherDedVal'); if (otherDedEl) otherDedEl.textContent = ((Number(data.total_other_deductions)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const penaltiesEl = document.getElementById('finPenaltiesVal'); if (penaltiesEl) penaltiesEl.textContent = ((Number(data.total_penalties)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const addPayEl = document.getElementById('finAdditionalPayVal'); if (addPayEl) addPayEl.textContent = ((Number(data.total_additional_payment)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const defectCompEl = document.getElementById('finDefectCompVal'); if (defectCompEl) defectCompEl.textContent = ((Number(data.total_defect_compensation)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const damageCompEl = document.getElementById('finDamageCompVal'); if (damageCompEl) damageCompEl.textContent = ((Number(data.total_damage_compensation)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const paidDeliveryEl0 = document.getElementById('finPaidDeliveryVal'); if (paidDeliveryEl0) paidDeliveryEl0.textContent = ((Number(data.total_paid_delivery)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const commissionEl = document.getElementById('finCommissionVal'); if (commissionEl) commissionEl.textContent = ((Number(data.total_commission)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const wbRealEl = document.getElementById('finWbRealizedVal'); if (wbRealEl) wbRealEl.textContent = ((Number(data.total_wb_realized)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const wbDed = ((Number(data.total_commission)||0) + (Number(data.total_acquiring)||0) + (Number(data.total_logistics)||0) + (Number(data.total_storage)||0) + (Number(data.total_other_deductions)||0) + (Number(data.total_acceptance)||0) - (Number(data.total_defect_compensation)||0) - (Number(data.total_damage_compensation)||0) - (Number(data.total_paid_delivery)||0) + (Number(data.total_penalties)||0) + (Number(data.total_additional_payment)||0));
            const wbDedEl = document.getElementById('finWbDedTotal'); if (wbDedEl) wbDedEl.textContent = Number(wbDed).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            const forPayEl2 = document.getElementById('finForPayVal'); if (forPayEl2) forPayEl2.textContent = (Number(data.total_for_transfer || 0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
            const buyoutOps = new Set(['продажа','сторно возвратов','корректная продажа','коррекция продаж']);
            const buyoutsQty = rowsSrv.reduce((acc, r) => { const op = (r && r.supplier_oper_name ? String(r.supplier_oper_name).trim().toLowerCase() : ''); return acc + (buyoutOps.has(op) ? 1 : 0); }, 0);
            const buyoutsQtyEl = document.getElementById('finBuyoutsQty'); if (buyoutsQtyEl) buyoutsQtyEl.textContent = (Number(buyoutsQty).toLocaleString('ru-RU'));
            const returnOps = new Set(['возврат','сторно продаж','корректный возврат']);
            const returnsQty = rowsSrv.reduce((acc, r) => { const op = (r && r.supplier_oper_name ? String(r.supplier_oper_name).trim().toLowerCase() : ''); return acc + (returnOps.has(op) ? 1 : 0); }, 0);
            const returnsQtyEl = document.getElementById('finReturnsQty'); if (returnsQtyEl) returnsQtyEl.textContent = (Number(returnsQty).toLocaleString('ру-RU'));
            const revenueQtyEl = document.getElementById('finRevenueQty'); if (revenueQtyEl) revenueQtyEl.textContent = (Number(Math.max(0, buyoutsQty - returnsQty)).toLocaleString('ru-RU'));
            const resWrap = document.getElementById('finResults'); if (resWrap) resWrap.style.display = rowsSrv.length ? 'block' : 'none';
            if (exportBtn) exportBtn.disabled = !(rowsSrv && rowsSrv.length > 0);
          }
        }
      } catch(e){}
      form?.addEventListener('submit', async function(e){
        e.preventDefault();
        if (!loadBtn) return;
        if (!validateDates()) return; // stop if dates invalid
        try{
          loadBtn.disabled = true; const prev = loadBtn.textContent; loadBtn.textContent = 'Загрузка...';
          const params = new URLSearchParams(new FormData(form));
          const res = await fetch(`/api/report/finance?${params.toString()}`);
          const data = await res.json();
          // error handling
          if (data && data.error){
            const alertBox = document.getElementById('finAlert');
            if (alertBox){ alertBox.textContent = data.error; alertBox.style.display = 'block'; }
          } else {
            const alertBox = document.getElementById('finAlert');
            if (alertBox){ alertBox.style.display = 'none'; alertBox.textContent = ''; }
          }
          const rows = (data.rows || []);
          const revenueEl = document.getElementById('finRevenueVal');
          if (revenueEl) revenueEl.textContent = ((Number(data.revenue)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const buyoutsEl = document.getElementById('finBuyoutsVal');
          if (buyoutsEl) buyoutsEl.textContent = ((Number(data.total_buyouts)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const returnsEl = document.getElementById('finReturnsVal');
          if (returnsEl) returnsEl.textContent = ((Number(data.total_returns)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          // Кол-во возвратов: суммируем по операторам Возврат, Сторно продаж, Корректный возврат
          const returnOps = new Set(['возврат','сторно продаж','корректный возврат']);
          const returnsQty = rows.reduce((acc, r) => {
            const op = (r && r.supplier_oper_name ? String(r.supplier_oper_name).trim().toLowerCase() : '');
            return acc + (returnOps.has(op) ? 1 : 0);
          }, 0);
          const returnsQtyEl = document.getElementById('finReturnsQty');
          if (returnsQtyEl) returnsQtyEl.textContent = (Number(returnsQty).toLocaleString('ru-RU'));
          const wbRealEl = document.getElementById('finWbRealizedVal');
          if (wbRealEl) wbRealEl.textContent = ((Number(data.total_wb_realized)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const logisticsEl = document.getElementById('finLogisticsVal');
          if (logisticsEl) logisticsEl.textContent = ((Number(data.total_logistics)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const logisticsPctEl = document.getElementById('finLogisticsPct');
          if (logisticsPctEl){
            const revL = Number(data.revenue)||0; const vL = Number(data.total_logistics)||0;
            logisticsPctEl.textContent = (revL ? (vL/revL*100) : 0).toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' %';
          }
          const storageEl = document.getElementById('finStorageVal');
          if (storageEl) storageEl.textContent = ((Number(data.total_storage)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const storagePctEl = document.getElementById('finStoragePct');
          if (storagePctEl){
            const revS = Number(data.revenue)||0; const vS = Number(data.total_storage)||0;
            storagePctEl.textContent = (revS ? (vS/revS*100) : 0).toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' %';
          }
          const acceptanceEl = document.getElementById('finAcceptanceVal');
          if (acceptanceEl) acceptanceEl.textContent = ((Number(data.total_acceptance)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const acceptancePctEl = document.getElementById('finAcceptancePct');
          if (acceptancePctEl){
            const revA = Number(data.revenue)||0; const vA = Number(data.total_acceptance)||0;
            acceptancePctEl.textContent = (revA ? (vA/revA*100) : 0).toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' %';
          }
          const forPayEl = document.getElementById('finForPayVal');
          if (forPayEl) forPayEl.textContent = ((Number(data.total_for_transfer)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const acquiringEl = document.getElementById('finAcquiringVal');
          if (acquiringEl) acquiringEl.textContent = ((Number(data.total_acquiring)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const acquiringPctEl = document.getElementById('finAcquiringPct');
          if (acquiringPctEl){
            const rev = Number(data.revenue)||0;
            const acq = Number(data.total_acquiring)||0;
            const pctA = rev ? (acq / rev) * 100 : 0;
            acquiringPctEl.textContent = pctA.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' %';
          }
          const otherDedEl = document.getElementById('finOtherDedVal');
          if (otherDedEl) otherDedEl.textContent = ((Number(data.total_other_deductions)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const otherDedPctEl = document.getElementById('finOtherDedPct');
          if (otherDedPctEl){
            const revO = Number(data.revenue)||0; const vO = Number(data.total_other_deductions)||0;
            otherDedPctEl.textContent = (revO ? (vO/revO*100) : 0).toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' %';
          }
          const penaltiesEl = document.getElementById('finPenaltiesVal');
          if (penaltiesEl) penaltiesEl.textContent = ((Number(data.total_penalties)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const addPayEl = document.getElementById('finAdditionalPayVal');
          if (addPayEl) addPayEl.textContent = ((Number(data.total_additional_payment)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const defectCompEl = document.getElementById('finDefectCompVal');
          if (defectCompEl) defectCompEl.textContent = ((Number(data.total_defect_compensation)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const damageCompEl = document.getElementById('finDamageCompVal');
          if (damageCompEl) damageCompEl.textContent = ((Number(data.total_damage_compensation)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const paidDeliveryElS = document.getElementById('finPaidDeliveryVal');
          if (paidDeliveryElS) paidDeliveryElS.textContent = ((Number(data.total_paid_delivery)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const commissionEl = document.getElementById('finCommissionVal');
          if (commissionEl) commissionEl.textContent = ((Number(data.total_commission)||0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');
          const commissionPctEl = document.getElementById('finCommissionPct');
          if (commissionPctEl){
            const rev = Number(data.revenue)||0;
            const comm = Number(data.total_commission)||0;
            const pct = rev ? (comm / rev) * 100 : 0;
            commissionPctEl.textContent = pct.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' %';
          }
          // Итог по блоку Удержания и компенсации WB
          const wbDed = (
            (Number(data.total_commission)||0)
            + (Number(data.total_acquiring)||0)
            + (Number(data.total_logistics)||0)
            + (Number(data.total_storage)||0)
            + (Number(data.total_other_deductions)||0)
            + (Number(data.total_acceptance)||0)
            - (Number(data.total_defect_compensation)||0)
            - (Number(data.total_damage_compensation)||0)
            - (Number(data.total_paid_delivery)||0)
            + (Number(data.total_penalties)||0)
            + (Number(data.total_additional_payment)||0)
          );
          const wbDedEl = document.getElementById('finWbDedTotal');
          if (wbDedEl) wbDedEl.textContent = Number(wbDed).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
          const wbDedPctEl = document.getElementById('finWbDedPct');
          if (wbDedPctEl){
            const revW = Number(data.revenue)||0; const pW = revW ? (wbDed/revW*100) : 0;
            wbDedPctEl.textContent = pW.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' %';
          }
          // К перечислению = Выручка - Удержания + E3 (корректировка эквайринга)
          const forPayEl2 = document.getElementById('finForPayVal');
          if (forPayEl2) forPayEl2.textContent = (Number(data.total_for_transfer || 0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' руб.');

          // Кол-во выкупов (шт.) = количество строк с supplier_oper_name в нужных значениях
          const buyoutOps = new Set(['продажа','сторно возвратов','корректная продажа','коррекция продаж']);
          const buyoutsQty = rows.reduce((acc, r) => {
            const op = (r && r.supplier_oper_name ? String(r.supplier_oper_name).trim().toLowerCase() : '');
            return acc + (buyoutOps.has(op) ? 1 : 0);
          }, 0);
          const buyoutsQtyEl = document.getElementById('finBuyoutsQty');
          if (buyoutsQtyEl) buyoutsQtyEl.textContent = (Number(buyoutsQty).toLocaleString('ru-RU'));
          // Кол-во возвратов — уже посчитано выше как returnsQty
          const revenueQtyEl = document.getElementById('finRevenueQty');
          if (revenueQtyEl) revenueQtyEl.textContent = (Number(Math.max(0, buyoutsQty - (returnsQty || 0))).toLocaleString('ru-RU'));
          // Показываем блок результатов
          const resWrap = document.getElementById('finResults');
          if (resWrap) resWrap.style.display = rows.length ? 'block' : 'none';
          if (exportBtn) exportBtn.disabled = !(rows && rows.length > 0);
          loadBtn.textContent = prev; loadBtn.disabled = false;
        } catch(err){
          console.error(err);
          const alertBox = document.getElementById('finAlert');
          if (alertBox){ alertBox.textContent = 'Ошибка загрузки отчёта'; alertBox.style.display = 'block'; }
          if (loadBtn){ loadBtn.disabled = false; }
        }
      });
    });
  </script>
  <script type="application/json" id="finServerRows">{{ (rows or []) | tojson | safe }}</script>
  <script type="application/json" id="finServerMetrics">{{ (finance_metrics or {}) | tojson | safe }}</script>
  <script>
    function submitExport(){
      const form = document.getElementById('financeForm');
      if (!form) return;
      const a = document.createElement('a');
      const params = new URLSearchParams(new FormData(form));
      a.href = `/report/finance/export?${params.toString()}`;
      a.click();
    }
  </script>
  <style>
    /* Стили для квадратиков компенсаций */
    .compensation-card .text-muted {
      color: #009688 !important;
    }
    
    /* Стили для квадратиков удержаний */
    .deduction-card .text-muted {
      color: #ff574b !important;
    }
    
    /* Стили для квадратика "К перечислению" */
    .for-pay-card {
      background-color: #90ee9040;
    }
    
    .for-pay-card .text-muted {
      color: #337736 !important;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
  {% include '_navbar.html' %}
  <div class="container mt-3">
    <h1 class="mb-3" style="font-size:1.6rem;">Финансовый отчёт</h1>
    {% if error %}
      <div class="alert alert-warning">{{ error }}</div>
    {% endif %}

    <form class="row g-3 mb-3" id="financeForm" method="get" action="/report/finance">
      <div class="col-sm-3 col-md-3">
        <label class="form-label">Период отчета</label>
        <div class="position-relative" style="position: relative !important;">
          <input type="text" class="form-control" id="fDateRangeInput" placeholder="Выберите период" readonly style="cursor: pointer;" />
          <input type="hidden" name="date_from" id="fDateFrom" value="{{ date_from_val or '' }}" />
          <input type="hidden" name="date_to" id="fDateTo" value="{{ date_to_val or '' }}" />
          <span class="position-absolute top-50 end-0 translate-middle-y me-3" style="cursor: pointer;" id="fDateRangeBtn">📅</span>
          <div id="fDateRangeCalendar" class="calendar-dropdown" style="display: none;">
          <div class="calendar-header">
            <button type="button" class="calendar-nav" id="prevMonth">‹</button>
            <span id="currentMonthYear">Сентябрь 2025</span>
            <button type="button" class="calendar-nav" id="nextMonth">›</button>
          </div>
          <div class="calendar-grid" id="calendarGrid">
            <!-- Календарь будет генерироваться JavaScript -->
          </div>
          <div class="calendar-footer">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="resetDates">Сбросить</button>
            <button type="button" class="btn btn-sm btn-primary" id="applyDates">Применить</button>
          </div>
          </div>
        </div>
      </div>
      <div class="col-sm-2 col-md-2 d-flex align-items-end">
        <button id="financeLoadBtn" class="btn btn-primary w-100" type="submit">Загрузить</button>
      </div>
      <div class="col-sm-2 col-md-2 d-flex align-items-end">
        <button id="financeExportBtn" type="button" class="btn btn-success w-100" onclick="submitExport()" {% if not rows or not rows|length %}disabled{% endif %}>Скачать XLS</button>
      </div>
    </form>

    <div id="finDateWarn" class="alert alert-warning py-1" role="alert" style="display:none;"></div>

    <div id="finAlert" class="alert alert-warning" role="alert" style="display:none;"></div>
    <div id="finResults" {% if rows and rows|length %}style="display:block;"{% else %}style="display:none;"{% endif %}>
      <h5 class="mb-2">Продажи</h5>
      <div class="row g-3 mb-3">
        <div class="col-12 col-md-2">
          <div class="card h-100"><div class="card-body">
            <div class="text-muted">Выручка</div>
            <div class="fs-6"><strong id="finRevenueVal">0</strong></div>
            <div class="text-muted small">Кол-во: <span id="finRevenueQty">0</span> шт.</div>
          </div></div>
        </div>
        <div class="col-6 col-md-2">
          <div class="card h-100"><div class="card-body">
            <div class="text-muted">Выкупы</div>
            <div class="fs-6"><strong id="finBuyoutsVal">0</strong></div>
            <div class="text-muted small">Кол-во: <span id="finBuyoutsQty">0</span> шт.</div>
          </div></div>
        </div>
        <div class="col-6 col-md-2">
          <div class="card h-100"><div class="card-body">
            <div class="text-muted">Возвраты</div>
            <div class="fs-6"><strong id="finReturnsVal">0</strong></div>
            <div class="text-muted small">Кол-во: <span id="finReturnsQty">0</span> шт.</div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card h-100"><div class="card-body">
            <div class="text-muted">WB реализовал</div>
            <div class="fs-6"><strong id="finWbRealizedVal">0</strong></div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card h-100 for-pay-card"><div class="card-body">
            <div class="text-muted">К перечислению на р/с</div>
            <div class="fs-4" style="text-align: center;"><strong id="finForPayVal">0</strong></div>
          </div></div>
        </div>
      </div>
      <hr/>
      <h5 class="mb-2">Удержания и компенсации WB <span class="text-muted">(<span id="finWbDedTotal">0</span> руб., <span id="finWbDedPct">0,00 %</span> от выручки)</span></h5>
      <div class="row g-3">
        <div class="col-12 col-md-3">
          <div class="card h-100 compensation-card"><div class="card-body">
            <div class="text-muted">Компенсация брака</div>
            <div class="fs-6"><strong id="finDefectCompVal">0</strong></div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card h-100 compensation-card"><div class="card-body">
            <div class="text-muted">Компенсация ущерба</div>
            <div class="fs-6"><strong id="finDamageCompVal">0</strong></div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card h-100 compensation-card"><div class="card-body">
            <div class="text-muted">Платная доставка</div>
            <div class="fs-6"><strong id="finPaidDeliveryVal">0</strong></div>
          </div></div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">Комиссия</div>
            <div class="fs-6"><strong id="finCommissionVal">0</strong></div>
            <div class="small">От выручки: <span id="finCommissionPct">0,00 %</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">Логистика</div>
            <div class="fs-6"><strong id="finLogisticsVal">0</strong></div>
            <div class="small">От выручки: <span id="finLogisticsPct">0,00 %</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">Хранение</div>
            <div class="fs-6"><strong id="finStorageVal">0</strong></div>
            <div class="small">От выручки: <span id="finStoragePct">0,00 %</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">Приёмка</div>
            <div class="fs-6"><strong id="finAcceptanceVal">0</strong></div>
            <div class="small">От выручки: <span id="finAcceptancePct">0,00 %</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">Эквайринг</div>
            <div class="fs-6"><strong id="finAcquiringVal">0</strong></div>
            <div class="small">От выручки: <span id="finAcquiringPct">0,00 %</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">Прочие удержания</div>
            <div class="fs-6"><strong id="finOtherDedVal">0</strong></div>
            <div class="small">От выручки: <span id="finOtherDedPct">0,00 %</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">Штрафы</div>
            <div class="fs-6"><strong id="finPenaltiesVal">0</strong></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card h-100 deduction-card"><div class="card-body">
            <div class="text-muted">Доплата</div>
            <div class="fs-6"><strong id="finAdditionalPayVal">0</strong></div>
          </div></div>
        </div>
      </div>
    </div>
  </div>
  {% include '_footer.html' %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


