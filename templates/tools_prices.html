<!doctype html>
<html lang="ru">
<head>
  {% block title %}<title>Управление ценами — WB Dashboard</title>{% endblock %}
  {% include '_header.html' %}
  {% block bootstrap_icons %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
  {% endblock %}
  {% block extra_styles %}
  <style>
    h1 { font-size: 1.7rem; }
    input#productsSearch { padding: .5rem .5rem; }
    .mb-2 {margin-bottom: 1.1rem !important;}
    .price-input { width: 100px; }
    
    /* Вертикальные разделители для таблицы */
    #productsTable th:not(:last-child),
    #productsTable td:not(:last-child) {
      border-right: 1px solid #dee2e6;
    }
    
    /* Стили для ячеек таблицы */
    #productsTable td {
      border-right: 1px solid #dee2e6;
      padding: 8px;
    }
    
    #productsTable td:last-child {
      border-right: none;
    }
    
    /* Стили для выделения измененных инпутов */
    .input-changed {
      border: 2px solid #dc3545 !important;
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
      transition: all 0.15s ease-in-out;
    }
    
    /* Стили для отображения старых значений */
    .old-value {
      display: block;
      font-size: 0.75em;
      color: #6c757d;
      text-decoration: line-through;
      margin-top: 2px;
      font-style: italic;
    }
    
    /* Стили для индикатора загрузки */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 99999;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    /* Слой блюра только для фона */
    .loading-overlay::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(3px);
      z-index: 1;
    }
    
    /* Контент индикатора - четкий, поверх блюра */
    .loading-content {
      text-align: center;
      background: #ffffff;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
      border: 2px solid #007bff;
      position: relative;
      z-index: 2;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #666;
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    body {
      transition: all 0.3s ease;
    }
    
    body.loaded {
      filter: none;
      opacity: 1;
    }
    
    .content-blurred {
      filter: blur(1px);
      opacity: 0.6;
      transition: all 0.3s ease;
    }
    
    
    /* Прилипающая шапка с поиском */
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 11;
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      padding: 10px 0;
      margin-bottom: 0;
    }
    
    /* Прилипающая шапка таблицы */
    #productsTable thead {
      position: sticky;
      top: 60px; /* Высота прилипающей шапки с поиском */
      z-index: 10;
      background: #fff;
    }
    
    /* Выравнивание заголовков по центру */
    #productsTable th {
      text-align: center !important;
      vertical-align: middle !important;
    }
    #productsTable { font-size: .875em; }
    /* Цветовые акценты заголовков */
    #productsTable th.header-purchase { background-color: #dff0d8; }           /* мягкий зелёный */
    #productsTable th.header-price { background-color: #e7f1ff; }              /* светло-голубой */
    #productsTable th.header-commission { background-color: #fff3cd; }         /* мягкий жёлтый */
    #productsTable th.header-total { background-color: #ffe08a; }              /* более насыщенный жёлтый */
    #productsTable th.header-receive { background-color: #e7f1ff; }            /* светло-голубой */
    #productsTable th.header-profit { background-color: #d4edda; }             /* зелёный (прибыль) */
    /* Негативная прибыль */
    #productsTable td.profit-bad { background-color: #fde2e1; color: #a30000; font-weight: 600; }
    
    /* Убираем ограничения контейнера для sticky */
    .table-responsive {
      overflow: visible;
    }
    
    /* Стили для сортировки */
    .sortable {
      position: relative;
      user-select: none;
      padding-right: 18px; /* место под иконку справа */
    }
    
    .sortable:hover {
      background-color: #f8f9fa !important;
    }
    
    .sort-icon {
      position: absolute;
      right: 6px;
      bottom: 4px;
      font-size: 0.9em;
      opacity: 0.6;
      transition: opacity 0.2s;
      pointer-events: none; /* не перехватывать клики */
      margin: 0;
    }
    
    .sortable:hover .sort-icon {
      opacity: 1;
    }
    
    .sortable.sort-asc .sort-icon::before {
      content: "\f0de"; /* bi-arrow-up */
      opacity: 1;
    }
    
    .sortable.sort-desc .sort-icon::before {
      content: "\f0dd"; /* bi-arrow-down */
      opacity: 1;
    }
    
    .sortable.sort-asc .sort-icon,
    .sortable.sort-desc .sort-icon {
      opacity: 1;
    }
  </style>
  {% endblock %}
</head>
<body>
  <!-- Индикатор загрузки (аккуратный дизайн) -->
  <div id="loadingOverlay" class="loading-overlay" style="display: flex !important;">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Загрузка страницы...</div>
    </div>
  </div>
  
  {% include '_navbar.html' %}
  <div class="container mt-3">
    <div class="d-flex align-items-center justify-content-between mb-2 gap-2 flex-wrap">
      <div class="d-flex align-items-center gap-3 flex-wrap">
        <h1 class="mb-0">Управление ценами{% if products|length %} ({{ products|length }} шт.){% endif %}</h1>
        <div class="text-muted">Обновлено: {{ prices_last_updated }}</div>
      </div>
      <div class="d-flex gap-2">
        <button id="refreshProducts" class="btn btn-primary btn-sm">Обновить список товаров</button>
        <div class="btn-group">
          <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            Действия с Excel
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" id="actionExportExcel"><i class="fas fa-file-excel me-1"></i> Экспорт в Excel</a></li>
            <li><a class="dropdown-item" href="#" id="actionUploadPrices"><i class="bi bi-cloud-upload me-1"></i> Загрузить закупочные цены</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="/tools/prices/template"><i class="bi bi-download me-1"></i> Скачать шаблон</a></li>
          </ul>
        </div>
        <button id="columnsSettingsBtn" class="btn btn-outline-secondary btn-sm" title="Настройка колонок">
          <i class="bi bi-gear"></i>
        </button>
        <button id="savePrices" class="btn btn-success btn-sm" style="display: none;">Сохранить изменения</button>
      </div>
    </div>
    
    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    
    
    <!-- Загрузка закупочных цен: только скрытый input и статус -->
    <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;">
    <div id="uploadStatus" class="mb-3" style="display: none;"></div>
    
    <!-- Блок переменных маржинальности -->
    <div class="card mb-2">
      <div class="card-body py-2">
        <div class="row g-2 align-items-center">
          <div class="col-auto"><strong>Параметры для расчета маржинальности:</strong></div>
          <div class="col-auto">
            <label class="form-label mb-0 small">Налог, % <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" title="Ваша налоговая ставка (указать вручную)"></i></label>
            <input type="number" step="0.1" min="0" id="varTax" class="form-control form-control-sm" style="width:90px" value="{{ margin_settings.tax }}">
          </div>
          <div class="col-auto">
            <label class="form-label mb-0 small">Хранение, % <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" title="Процент от выручки. Среднее значение можно посмотреть в еженедельном финансовом отчете (указать вручную)"></i></label>
            <input type="number" step="0.1" min="0" id="varStorage" class="form-control form-control-sm" style="width:90px" value="{{ margin_settings.storage }}">
          </div>
          <div class="col-auto">
            <label class="form-label mb-0 small">Приёмка, % <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" title="Процент от выручки. Среднее значение можно посмотреть в еженедельном финансовом отчете (указать вручную)"></i></label>
            <input type="number" step="0.1" min="0" id="varReceiving" class="form-control form-control-sm" style="width:90px" value="{{ margin_settings.receiving }}">
          </div>
          <div class="col-auto">
            <label class="form-label mb-0 small">Эквайринг, % <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" title="Процент от выручки. Среднее значение можно посмотреть в еженедельном финансовом отчете (указать вручную)"></i></label>
            <input type="number" step="0.1" min="0" id="varAcquiring" class="form-control form-control-sm" style="width:90px" value="{{ margin_settings.acquiring }}">
          </div>
          <div class="col-auto">
            <label class="form-label mb-0 small">Индекс локализации <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" title="Ваш персональный индекс, узнать его можно в личном кабинете селлера в разделе &quot;Поставки и заказы&quot; - &quot;Тарифы&quot; (если у вас его нет, оставить значение 1)"></i></label>
            <input type="number" step="0.1" min="0.1" max="10" id="varLocalizationIndex" class="form-control form-control-sm" style="width:90px" value="{{ margin_settings.localization_index or 1.0 }}">
          </div>
          <div class="col-auto">
            <label class="form-label mb-0 small">Схема WB <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" title="Выберите схему работы с маркетплейсом для рассчета комиссии"></i></label>
            <select id="varScheme" class="form-select form-select-sm" style="width:140px">
              {% set s = margin_settings.scheme or 'FBW' %}
              <option value="FBW" {% if s=='FBW' %}selected{% endif %}>FBW</option>
              <option value="FBS" {% if s=='FBS' %}selected{% endif %}>FBS</option>
              <option value="C&C" {% if s=='C&C' %}selected{% endif %}>C&C</option>
              <option value="DBS/DBW" {% if s=='DBS/DBW' %}selected{% endif %}>DBS/DBW</option>
              <option value="EDBS" {% if s=='EDBS' %}selected{% endif %}>EDBS</option>
            </select>
          </div>
          <div class="col-auto">
            <label class="form-label mb-0 small">Склад поставки <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" title="выберите склад чтобы получить значение коэфф. логистики, влияет на стоимость логистики."></i></label>
            <div class="position-relative">
              <input type="text" id="warehouseSearch" class="form-control form-control-sm" style="width:200px; padding-right:30px;" placeholder="Выберите склад..." autocomplete="off">
              <button type="button" id="clearWarehouse" class="btn btn-sm position-absolute" style="right:5px; top:50%; transform:translateY(-50%); padding:2px 6px; border:none; background:none; color:#dc3545; font-size:14px; line-height:1;" title="Очистить выбор">✕</button>
              <div id="warehouseDropdown" class="dropdown-menu" style="max-height:200px; overflow-y:auto; display:none;">
                {% for warehouse in warehouses_data %}
                <a class="dropdown-item warehouse-option" href="#" data-name="{{ warehouse.name }}" data-coef="{{ warehouse.coefficient }}">{{ warehouse.name }}</a>
                {% endfor %}
              </div>
            </div>
          </div>
          <div class="col-auto">
            <label for="varWarehouseCoef" class="form-label mb-0 small">Коэфф. логистики склада % <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" title="Коэффициент логистики выбранного склада (по тарифу на остаток, не на новую поставку!), влияет на стоимость логистики вашего товара к конечному потребителю"></i></label>
            <input type="number" step="1" min="0" id="varWarehouseCoef" class="form-control form-control-sm" style="width:120px" value="{{ margin_settings.warehouse_coef }}" readonly>
          </div>
          <div class="col-auto text-muted small" id="marginSaveStatus" style="display:none"></div>
        </div>
      </div>
    </div>

    <!-- Переключатель фильтрации по остаткам -->
    <div class="card mb-2">
      <div class="card-body py-2">
        <div class="row g-2 align-items-center">
          <div class="col-auto">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="stocksFilterToggle" style="transform: scale(1.2); cursor: pointer;">
              <label class="form-check-label" for="stocksFilterToggle" style="cursor: pointer;">
                <strong>Только с остатками</strong>
              </label>
            </div>
          </div>
          <div class="col-auto text-muted small" id="stocksFilterStatus">
            (Показаны все товары)
          </div>
        </div>
      </div>
    </div>

    <!-- Прилипающая шапка с поиском -->
    <div class="sticky-header">
      <div class="row">
        <div class="col-12">
          <input id="productsSearch" type="search" class="form-control form-control-sm" placeholder="Поиск товара" />
        </div>
      </div>
    </div>
    
    <!-- Таблица товаров с ценами -->
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0" id="productsTable" style="border-collapse: separate; border-spacing: 0;">
            <thead class="table-light text-center">
              <tr>
            <th style="width:56px; border-right: 1px solid #dee2e6;">#</th>
            <th style="width:72px; border-right: 1px solid #dee2e6;">Фото</th>
            <th style="border-right: 1px solid #dee2e6;">Наименование</th>
            <th class="sortable" data-column="stocks" style="width:100px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Остатки <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-purchase sortable" data-column="purchase" style="width:120px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Закупочная цена <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-price sortable" data-column="price_before" style="width:120px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Цена до скидки <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-price sortable" data-column="seller_discount" style="width:120px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Скидка продавца <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-price sortable" data-column="price_discount" style="width:120px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Цена со скидкой <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-price sortable" data-column="price_wallet" style="width:120px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Цена со скидкой (WB клуб) <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="sortable" data-column="category" style="width:150px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Категория <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="sortable" data-column="volume" style="width:100px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Объём л. <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-commission sortable" data-column="commission_pct" style="width:120px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Комиссия WB, % <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-commission sortable" data-column="commission_rub" style="width:120px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Комиссия WB руб. <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-commission sortable" data-column="tax_rub" style="width:120px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Налог руб. <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-commission sortable" data-column="logistics_rub" style="width:120px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Логистика руб. <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-commission sortable" data-column="storage_rub" style="width:120px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Хранение руб. <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-commission sortable" data-column="receiving_rub" style="width:120px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Приёмка руб. <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-commission sortable" data-column="acquiring_rub" style="width:120px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Эквайринг руб. <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-total sortable" data-column="total_expenses" style="width:140px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Итого расходов: руб. <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-commission sortable" data-column="expenses_pct" style="width:120px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Расходов в % <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-receive sortable" data-column="price_to_receive" style="width:150px; border-right: 1px solid #dee2e6; cursor: pointer;">
              Цена к получению руб. <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-profit sortable" data-column="profit_net" style="width:140px; cursor: pointer;">
              Прибыль чистая руб. <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
            <th class="header-profit sortable" data-column="profit_pct" style="width:120px; cursor: pointer;">
              Прибыль % <i class="bi bi-arrow-down-up sort-icon"></i>
            </th>
              </tr>
            </thead>
            <tbody>
              {% for product in products %}
              <tr data-nm-id="{{ product.nm_id }}" data-barcode="{{ product.barcode }}">
                <td class="text-center">{{ loop.index }}</td>
                <td>
                  {% if product.photo %}
                    <img src="{{ product.photo }}" data-src="{{ product.photo }}" class="product-thumb" alt="photo" style="width:45px;height:65px;object-fit:cover;cursor: zoom-in;" />
                  {% else %}
                    <span class="text-muted">нет фото</span>
                  {% endif %}
                </td>
                <td>
                  <div>
                    {% if product.nm_id %}
                      <a href="/product/{{ product.nm_id }}" class="text-decoration-none">{{ product.supplier_article or '' }}</a>
                      <a href="https://www.wildberries.ru/catalog/{{ product.nm_id }}/detail.aspx" target="_blank" rel="noopener" class="ms-1 text-muted">
                        <i class="fas fa-external-link-alt"></i>
                      </a>
                    {% else %}
                      {{ product.supplier_article or '' }}
                    {% endif %}
                  </div>
                  {% if product.nm_id or product.barcode %}
                    <div class="small text-muted mt-1">
                      {% if product.nm_id %}Артикул WB: {{ product.nm_id }}{% endif %}
                      {% if product.nm_id and product.barcode %} | {% endif %}
                      {% if product.barcode %}Баркод: {{ product.barcode }}{% endif %}
                    </div>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% set product_barcode = product.barcode %}
                  {% set fbw = (stocks_data[product_barcode] if stocks_data and product_barcode in stocks_data else None) %}
                  {% set fbs = (fbs_stocks_data[product_barcode] if fbs_stocks_data and product_barcode in fbs_stocks_data else None) %}
                  {% if fbw is not none or fbs is not none %}
                    <span class="badge {{ 'bg-success' if (fbw or 0) > 0 else 'bg-secondary' }}" data-bs-toggle="tooltip" title="FBW">{{ fbw if fbw is not none else 0 }}</span>
                    <span>/</span>
                    <span class="badge {{ 'bg-primary' if (fbs or 0) > 0 else 'bg-secondary' }}" data-bs-toggle="tooltip" title="FBS, DBS">{{ fbs if fbs is not none else 0 }}</span>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  <input type="number" 
                         class="form-control form-control-sm price-input purchase-price" 
                         placeholder="0.00" 
                         step="0.01" 
                         min="0"
                         data-barcode="{{ product.barcode }}"
                         value="{% if purchase_prices and product.barcode in purchase_prices %}{{ purchase_prices[product.barcode] }}{% endif %}"
                         style="display: inline-block; width: 100px;">
                </td>
                <td class="text-center">
                  {% set nm_id = product.nm_id %}
                  <input type="number" class="form-control form-control-sm text-end price-edit price-before-input"
                         data-nm-id="{{ nm_id }}" step="0.01" min="0"
                         value="{% if prices_data and nm_id in prices_data %}{{ '%.2f'|format(prices_data[nm_id].price) }}{% else %}{% endif %}" style="width:110px;display:inline-block;">
                </td>
                <td class="text-center">
                  {% set nm_id = product.nm_id %}
                  <input type="number" class="form-control form-control-sm text-end seller-discount-input" 
                         data-nm-id="{{ nm_id }}" step="0.1" min="0" max="100"
                         value="{% if prices_data and nm_id in prices_data and prices_data[nm_id].seller_discount_percent %}{{ prices_data[nm_id].seller_discount_percent|round|int }}{% else %}{% endif %}" 
                         style="width:90px;display:inline-block;" placeholder="0.0">
                </td>
                <td class="text-center">
                  {% set nm_id = product.nm_id %}
                  <input type="number" class="form-control form-control-sm text-end price-edit price-discount-input"
                         data-nm-id="{{ nm_id }}" step="0.01" min="0"
                         value="{% if prices_data and nm_id in prices_data %}{{ '%.2f'|format(prices_data[nm_id].discount_price) }}{% else %}{% endif %}" style="width:110px;display:inline-block;">
                </td>
                <td class="text-center">
                  {% set nm_id = product.nm_id %}
                  <input type="number" class="form-control form-control-sm text-end price-edit price-wallet-input"
                         data-nm-id="{{ nm_id }}" step="0.01" min="0"
                         value="{% if prices_data and nm_id in prices_data %}{{ '%.2f'|format(prices_data[nm_id].club_discount_price) }}{% else %}{% endif %}" style="width:110px;display:inline-block;">
                </td>
                <td class="text-center">
                  {% set subject_id = product.subject_id %}
                  {% if commission_data and subject_id in commission_data %}
                    <span class="small">{{ commission_data[subject_id].subject_name }}</span>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% set nm_id = product.nm_id %}
                  {% set product_dimensions = product.dimensions %}
                  {% if product_dimensions and product_dimensions.volume > 0 %}
                    <span class="small">{{ "%.2f"|format(product_dimensions.volume) }}</span>
                  {% elif dimensions_data and nm_id in dimensions_data %}
                    <span class="small">{{ "%.2f"|format(dimensions_data[nm_id].volume) }}</span>
                  {% else %}
                    <span class="text-muted" title="nm_id: {{ nm_id }}, product_dimensions: {{ product_dimensions }}, dimensions_data keys: {{ dimensions_data.keys()|list|slice(5)|list }}">—</span>
                  {% endif %}
                </td>
                <td class="text-center commission-percent" data-subject-id="{{ product.subject_id }}">—</td>
                <td class="text-center commission-rub">—</td>
                <td class="text-center tax-rub">—</td>
                <td class="text-center logistics-rub">—</td>
                <td class="text-center storage-rub">—</td>
                <td class="text-center receiving-rub">—</td>
                <td class="text-center acquiring-rub">—</td>
                <td class="text-center total-expenses-rub">—</td>
                <td class="text-center expenses-percent">—</td>
                <td class="text-center price-to-receive-rub">—</td>
                <td class="text-center profit-net-rub">
                  <input type="number" class="form-control form-control-sm text-end profit-net-input" step="0.01" placeholder="0.00" style="width:110px;display:inline-block;">
                </td>
                <td class="text-center profit-percent">
                  <input type="number" class="form-control form-control-sm text-end profit-pct-input" step="0.01" placeholder="0.00" style="width:90px;display:inline-block;">
                </td>
              </tr>
              {% endfor %}
              {% if not products %}
                <tr><td colspan="12" class="text-muted">Нет данных</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
  </div>
  
  <div id="imgPreview" style="display:none; position:fixed; left:50%; top:50%; transform: translate(-50%, -50%); z-index:1060; padding:4px; background:#fff; border:1px solid rgba(0,0,0,.15); box-shadow:0 .5rem 1rem rgba(0,0,0,.15); pointer-events: none;">
    <img id="imgPreviewImg" src="" alt="preview" style="max-width:420px; max-height:560px; display:block;" />
  </div>
  
  <script id="productsDataJson" type="application/json">{{ products|tojson|safe }}</script>
  <script id="pricesDataJson" type="application/json">{{ prices_data|tojson|safe }}</script>
  <script id="commissionDataJson" type="application/json">{{ commission_data|tojson|safe }}</script>
  <script id="dimensionsDataJson" type="application/json">{{ dimensions_data|tojson|safe }}</script>
  <script id="warehousesDataJson" type="application/json">{{ warehouses_data|tojson|safe }}</script>
  <script id="stocksDataJson" type="application/json">{{ stocks_data|tojson|safe }}</script>
  <script id="fbsStocksDataJson" type="application/json">{{ fbs_stocks_data|tojson|safe }}</script>
  <script id="purchasePricesDataJson" type="application/json">{{ purchase_prices|tojson|safe }}</script>
  
  <!-- Модальное окно настройки колонок -->
  <div class="modal fade" id="columnsSettingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Отображение колонок</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-12" id="columnsChecklist"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
          <button type="button" class="btn btn-primary" id="columnsSaveBtn">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Функции для управления индикатором загрузки
    function showLoading(text = 'Загрузка данных...') {
      const overlay = document.getElementById('loadingOverlay');
      console.log('showLoading вызвана, overlay:', overlay);
      if (!overlay) {
        console.log('Overlay не найден!');
        return; // Проверяем существование элемента
      }
      const loadingText = overlay.querySelector('.loading-text');
      if (loadingText) {
        loadingText.textContent = text;
      }
      overlay.style.display = 'flex';
      console.log('Индикатор загрузки показан');
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (!overlay) return; // Проверяем существование элемента
      overlay.style.display = 'none';
      document.body.classList.add('loaded');
    }

    // Индикатор загрузки уже виден по умолчанию в HTML
    console.log('Индикатор загрузки уже виден по умолчанию');

    // Данные для экспорта (парсим из JSON-скриптов, чтобы не ломать линтер)
    const productsData = JSON.parse(document.getElementById('productsDataJson').textContent || '[]');
    const pricesData = JSON.parse(document.getElementById('pricesDataJson').textContent || '{}');
    const commissionData = JSON.parse(document.getElementById('commissionDataJson').textContent || '{}');
    const dimensionsData = JSON.parse(document.getElementById('dimensionsDataJson').textContent || '{}');
    const warehousesData = JSON.parse(document.getElementById('warehousesDataJson').textContent || '[]');
    const stocksData = JSON.parse(document.getElementById('stocksDataJson').textContent || '{}');
    const purchasePricesData = JSON.parse(document.getElementById('purchasePricesDataJson').textContent || '{}');
    
    // Отладочная информация
    console.log('Dimensions data loaded:', dimensionsData);
    console.log('Dimensions data keys:', Object.keys(dimensionsData));
    console.log('Warehouses data loaded:', warehousesData);
    console.log('First few products:', productsData.slice(0, 3).map(p => ({ 
      nm_id: p.nm_id, 
      supplier_article: p.supplier_article,
      dimensions: p.dimensions 
    })));
    
    // Проверяем, есть ли размеры в самих продуктах
    const productsWithDimensions = productsData.filter(p => p.dimensions && p.dimensions.volume > 0);
    console.log(`Products with dimensions: ${productsWithDimensions.length} out of ${productsData.length}`);
    if (productsWithDimensions.length > 0) {
      console.log('First product with dimensions:', productsWithDimensions[0]);
    }
    
    // Проверяем данные о складах
    console.log(`Warehouses loaded: ${warehousesData.length}`);
    console.log('Warehouses data:', warehousesData);
    if (warehousesData.length > 0) {
      console.log('First few warehouses:', warehousesData.slice(0, 3));
    } else {
      console.log('Warehouses data is empty or not loaded!');
    }
    
    (function(){
      // ---- Настройки маржи: автосохранение с дебаунсом ----
      const inputs = {
        tax: document.getElementById('varTax'),
        storage: document.getElementById('varStorage'),
        receiving: document.getElementById('varReceiving'),
        acquiring: document.getElementById('varAcquiring'),
        localizationIndex: document.getElementById('varLocalizationIndex'),
        scheme: document.getElementById('varScheme'),
        warehouse: document.getElementById('warehouseSearch'),
        warehouseCoef: document.getElementById('varWarehouseCoef'),
      };
      const saveStatus = document.getElementById('marginSaveStatus');
      let saveTimer = null;
      function scheduleSave(){
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(doSave, 600);
      }
      function doSave(){
        const payload = {
          tax: parseFloat(inputs.tax.value || 0) || 0,
          storage: parseFloat(inputs.storage.value || 0) || 0,
          receiving: parseFloat(inputs.receiving.value || 0) || 0,
          acquiring: parseFloat(inputs.acquiring.value || 0) || 0,
          localization_index: parseFloat(inputs.localizationIndex.value || 1) || 1,
          scheme: (inputs.scheme && inputs.scheme.value) || 'FBW',
          warehouse: (inputs.warehouse && inputs.warehouse.value) || '',
          warehouse_coef: parseFloat(inputs.warehouseCoef.value || 0) || 0,
        };
        
        console.log('Saving margin settings:', {
          warehouse: payload.warehouse,
          warehouse_coef: payload.warehouse_coef,
          inputsWarehouse: inputs.warehouse ? inputs.warehouse.value : 'undefined',
          inputsWarehouseCoef: inputs.warehouseCoef ? inputs.warehouseCoef.value : 'undefined'
        });
        saveStatus.style.display = 'inline';
        saveStatus.textContent = 'Сохранение…';
        fetch('/api/tools/prices/margin-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(r=>r.json()).then(data=>{
          if (data && data.success){
            saveStatus.textContent = 'Сохранено';
          } else {
            saveStatus.textContent = 'Ошибка сохранения';
          }
          setTimeout(()=>{ saveStatus.style.display = 'none'; }, 1200);
        }).catch(()=>{
          saveStatus.textContent = 'Ошибка сохранения';
          setTimeout(()=>{ saveStatus.style.display = 'none'; }, 1500);
        });
      }
      Object.values(inputs).forEach(inp=>{
        if (inp){ inp.addEventListener('input', scheduleSave); }
      });

      // ---- Заполнение колонки Комиссия WB, % по выбранной схеме ----
      function getCommissionPercent(subjectId){
        if (!commissionData || !subjectId || !commissionData[subjectId]) return null;
        const item = commissionData[subjectId];
        const scheme = (inputs.scheme && inputs.scheme.value) || 'FBW';
        switch(scheme){
          case 'FBS': return item.fbs_commission ?? null;
          case 'C&C': return item.cc_commission ?? null;
          case 'DBS/DBW': return item.dbs_dbw_commission ?? null;
          case 'EDBS': return item.edbs_commission ?? null;
          case 'FBW':
          default: return item.fbw_commission ?? null;
        }
      }

      function getDiscountPriceByRow(row){
        const directInput = row.querySelector('.price-discount-input');
        if (directInput){
          const v = Number(directInput.value);
          if (!isNaN(v)) return v;
        }
        const nmId = row.getAttribute('data-nm-id');
        if (!nmId) return 0;
        const key = String(nmId);
        const item = pricesData ? pricesData[key] : null;
        if (!item) return 0;
        const v = Number(item.discount_price);
        return isNaN(v) ? 0 : v;
      }

      function updateCommissionColumn(){
        const rows = document.querySelectorAll('#productsTable tbody tr');
        rows.forEach(row => {
          const cellPercent = row.querySelector('.commission-percent');
          const subjectId = cellPercent ? cellPercent.getAttribute('data-subject-id') : null;
          const val = subjectId ? getCommissionPercent(subjectId) : null;
          if (cellPercent){ cellPercent.textContent = (val !== null && val !== undefined) ? (Number(val).toFixed(1) + '%') : '—'; }

          // Комиссия WB руб. = Цена со скидкой * (Комиссия WB, % / 100)
          const cellRub = row.querySelector('.commission-rub');
          if (cellRub){
            if (val === null || val === undefined){
              cellRub.textContent = '—';
            } else {
              const discountPrice = getDiscountPriceByRow(row);
              const commissionRub = discountPrice * (Number(val) / 100);
              cellRub.textContent = isNaN(commissionRub) ? '—' : commissionRub.toFixed(2);
            }
          }

          // Налог руб. = Цена со скидкой * (Налог, % / 100)
          const taxCell = row.querySelector('.tax-rub');
          if (taxCell){
            const taxPercent = inputs.tax ? Number(inputs.tax.value) : 0;
            const discountPrice = getDiscountPriceByRow(row);
            const taxRub = discountPrice * (taxPercent / 100);
            taxCell.textContent = isNaN(taxRub) ? '—' : taxRub.toFixed(2);
          }

          // Логистика руб. - новая схема на основе объёма
          const logisticsCell = row.querySelector('.logistics-rub');
          if (logisticsCell){
            const volumeCell = row.querySelector('td:nth-child(11)'); // Колонка объёма
            let logisticsValue = 0;
            
            if (volumeCell) {
              const volumeText = volumeCell.textContent.trim();
              if (volumeText && volumeText !== '—') {
                const volume = parseFloat(volumeText);
                if (!isNaN(volume)) {
                  if (volume < 1) {
                    // Для товаров до 1 литра
                    if (volume >= 0.001 && volume <= 0.200) {
                      logisticsValue = 23;
                    } else if (volume >= 0.201 && volume <= 0.400) {
                      logisticsValue = 26;
                    } else if (volume >= 0.401 && volume <= 0.600) {
                      logisticsValue = 29;
                    } else if (volume >= 0.601 && volume <= 0.800) {
                      logisticsValue = 30;
                    } else if (volume >= 0.801 && volume <= 0.999) {
                      logisticsValue = 32;
                    }
                  } else {
                    // Для товаров от 1 литра и выше
                    const firstLiter = 46; // Стоимость первого литра
                    const additionalLiters = Math.max(0, volume - 1) * 14; // Дополнительные литры
                    logisticsValue = firstLiter + additionalLiters;
                  }
                }
              }
            }
            
            // Применяем коэффициент склада, если он выбран
            const warehouseCoef = parseFloat(inputs.warehouseCoef.value) || 0;
            if (warehouseCoef > 0 && logisticsValue > 0) {
              logisticsValue = logisticsValue * warehouseCoef / 100;
            }
            
            // Применяем индекс локализации
            const localizationIndex = parseFloat(inputs.localizationIndex.value) || 1;
            if (localizationIndex > 0 && logisticsValue > 0) {
              logisticsValue = logisticsValue * localizationIndex;
            }
            
            logisticsCell.textContent = logisticsValue > 0 ? logisticsValue.toFixed(2) : '—';
          }

          // Хранение руб. = Цена со скидкой * (Хранение, % / 100)
          const storageCell = row.querySelector('.storage-rub');
          if (storageCell){
            const p = inputs.storage ? Number(inputs.storage.value) : 0;
            const d = getDiscountPriceByRow(row);
            const v = d * (p / 100);
            storageCell.textContent = isNaN(v) ? '—' : v.toFixed(2);
          }

          // Приёмка руб. = Цена со скидкой * (Приёмка, % / 100)
          const receivingCell = row.querySelector('.receiving-rub');
          if (receivingCell){
            const p = inputs.receiving ? Number(inputs.receiving.value) : 0;
            const d = getDiscountPriceByRow(row);
            const v = d * (p / 100);
            receivingCell.textContent = isNaN(v) ? '—' : v.toFixed(2);
          }

          // Эквайринг руб. = Цена со скидкой * (Эквайринг, % / 100)
          const acquiringCell = row.querySelector('.acquiring-rub');
          if (acquiringCell){
            const p = inputs.acquiring ? Number(inputs.acquiring.value) : 0;
            const d = getDiscountPriceByRow(row);
            const v = d * (p / 100);
            acquiringCell.textContent = isNaN(v) ? '—' : v.toFixed(2);
          }

          // -------- Производные показатели --------
          const discountPrice = getDiscountPriceByRow(row);

          // Считываем значения ячеек как числа
          function parseCell(selector){
            const c = row.querySelector(selector);
            if (!c) return 0;
            const t = (c.textContent || '').replace('%','').replace('\u00A0',' ').replace('₽','').trim();
            const n = Number(t);
            return isNaN(n) ? 0 : n;
          }

          const commissionRub = parseCell('.commission-rub');
          const taxRub = parseCell('.tax-rub');
          const logisticsRub = parseCell('.logistics-rub');
          const storageRub = parseCell('.storage-rub');
          const receivingRub = parseCell('.receiving-rub');
          const acquiringRub = parseCell('.acquiring-rub');

          // Итого расходов: руб. = Комиссия WB руб. + Налог руб. + Логистика руб. + Хранение руб. + Приёмка руб. + Эквайринг руб.
          const totalExpenses = commissionRub + taxRub + logisticsRub + storageRub + receivingRub + acquiringRub;
          const totalCell = row.querySelector('.total-expenses-rub');
          if (totalCell){ totalCell.textContent = isNaN(totalExpenses) ? '—' : totalExpenses.toFixed(2); }

          // Расходов в % = Итого расходов / Цена со скидкой
          const expensesPctCell = row.querySelector('.expenses-percent');
          if (expensesPctCell){
            const pct = discountPrice > 0 ? (totalExpenses / discountPrice) * 100 : 0;
            expensesPctCell.textContent = isNaN(pct) ? '—' : pct.toFixed(2) + '%';
          }

          // Цена к получению руб. = Цена со скидкой - Итого расходов
          const priceToReceive = discountPrice - totalExpenses;
          const ptrCell = row.querySelector('.price-to-receive-rub');
          if (ptrCell){ ptrCell.textContent = isNaN(priceToReceive) ? '—' : priceToReceive.toFixed(2); }

          // Прибыль чистая руб. = Цена со скидкой - Итого расходов - Закупочная цена
          const purchaseInput = row.querySelector('.purchase-price');
          const purchaseVal = purchaseInput ? Number(purchaseInput.value) : 0;
          const profitNet = discountPrice - totalExpenses - (isNaN(purchaseVal) ? 0 : purchaseVal);
          const profitNetInput = row.querySelector('.profit-net-input');
          if (profitNetInput){
            profitNetInput.value = isNaN(profitNet) ? '' : profitNet.toFixed(2);
            // Не обновляем baseline здесь, чтобы отображалось исходное значение
            const profitNetTd = profitNetInput.closest('td');
            if (profitNetTd){
              profitNetTd.classList.toggle('profit-bad', !isNaN(profitNet) && profitNet <= 0);
            }
          }

          // Прибыль % = Прибыль чистая руб. / Закупочная цена
          const profitPct = (purchaseVal > 0) ? (profitNet / purchaseVal) * 100 : 0;
          const profitPctInput = row.querySelector('.profit-pct-input');
          if (profitPctInput){
            profitPctInput.value = isNaN(profitPct) ? '' : profitPct.toFixed(2);
            // Не обновляем baseline здесь, чтобы отображалось исходное значение
            const profitPctTd = profitPctInput.closest('td');
            if (profitPctTd){
              profitPctTd.classList.toggle('profit-bad', !isNaN(profitPct) && profitPct <= 0);
            }
          }
        });
        
        // Автоматически обновляем подсветку для всех полей после пересчета
        rows.forEach(row => {
          const priceBeforeInput = row.querySelector('.price-before-input');
          const sellerDiscountInput = row.querySelector('.seller-discount-input');
          const priceDiscountInput = row.querySelector('.price-discount-input');
          const priceWalletInput = row.querySelector('.price-wallet-input');
          const profitNetInput = row.querySelector('.profit-net-input');
          const profitPctInput = row.querySelector('.profit-pct-input');
          
          const allInputs = [priceBeforeInput, sellerDiscountInput, priceDiscountInput, priceWalletInput, profitNetInput, profitPctInput].filter(Boolean);
          if (allInputs.length > 0) {
            markInputsChanged(allInputs);
          }
        });
      }

      if (inputs.scheme){
        inputs.scheme.addEventListener('change', () => { scheduleSave(); updateCommissionColumn(); });
      }
      if (inputs.tax){ inputs.tax.addEventListener('input', () => { updateCommissionColumn(); }); }
      if (inputs.storage){ inputs.storage.addEventListener('input', () => { updateCommissionColumn(); }); }
      if (inputs.receiving){ inputs.receiving.addEventListener('input', () => { updateCommissionColumn(); }); }
      if (inputs.acquiring){ inputs.acquiring.addEventListener('input', () => { updateCommissionColumn(); }); }
      if (inputs.localizationIndex){ inputs.localizationIndex.addEventListener('input', () => { updateCommissionColumn(); }); }

      // ---- Поиск складов с живым поиском ----
      const warehouseSearch = document.getElementById('warehouseSearch');
      const warehouseDropdown = document.getElementById('warehouseDropdown');
      const warehouseCoefField = document.getElementById('varWarehouseCoef');
      const warehouseCoefLabel = document.querySelector('label[for="varWarehouseCoef"]');
      
      if (warehouseSearch && warehouseDropdown) {
        console.log('Warehouse search elements found:', { warehouseSearch, warehouseDropdown });
        console.log('Warehouse options count:', document.querySelectorAll('.warehouse-option').length);
        
        // Скрываем поле коэффициента по умолчанию
        if (warehouseCoefField && warehouseCoefLabel) {
          warehouseCoefField.style.display = 'none';
          warehouseCoefLabel.style.display = 'none';
        }
        
        // Показываем выпадающий список при клике/фокусе
        warehouseSearch.addEventListener('click', () => {
          filterWarehouses();
          warehouseDropdown.style.display = 'block';
        });
        
        warehouseSearch.addEventListener('focus', () => {
          filterWarehouses();
          warehouseDropdown.style.display = 'block';
        });
        
        warehouseSearch.addEventListener('blur', (e) => {
          // Задержка, чтобы клик по опции успел сработать
          setTimeout(() => {
            warehouseDropdown.style.display = 'none';
          }, 200);
        });
        
        // Поиск при вводе + подгрузка с сервера, если список пуст
        warehouseSearch.addEventListener('input', async () => {
          // если нет опций, попробуем подтянуть с сервера
          if (document.querySelectorAll('.warehouse-option').length === 0) {
            try {
              const r = await fetch('/api/tools/prices/warehouses');
              const j = await r.json();
              if (j && j.success && Array.isArray(j.warehouses)) {
                const dd = document.getElementById('warehouseDropdown');
                dd.innerHTML = j.warehouses.map(w => `<a class="dropdown-item warehouse-option" href="#" data-name="${w.name}" data-coef="${w.coefficient}">${w.name}</a>`).join('');
              }
            } catch (e) { console.warn('Не удалось загрузить склады', e); }
          }
          filterWarehouses();
          warehouseDropdown.style.display = 'block';
        });
        
        // Фильтрация складов
        function filterWarehouses() {
          const searchTerm = warehouseSearch.value.toLowerCase();
          const warehouseOptions = document.querySelectorAll('.warehouse-option');
          
          console.log('Filtering warehouses with term:', searchTerm);
          console.log('Found warehouse options:', warehouseOptions.length);
          
          warehouseOptions.forEach(option => {
            const warehouseName = option.textContent.toLowerCase();
            if (warehouseName.includes(searchTerm)) {
              option.style.display = 'block';
            } else {
              option.style.display = 'none';
            }
          });
        }
        
        // Выбор склада
        document.addEventListener('click', (e) => {
          if (e.target.classList.contains('warehouse-option')) {
            e.preventDefault();
            const warehouseName = e.target.getAttribute('data-name');
            const warehouseCoef = e.target.getAttribute('data-coef');
            
            warehouseSearch.value = warehouseName;
            inputs.warehouseCoef.value = warehouseCoef;
            
            warehouseDropdown.style.display = 'none';
            
            // Обновляем UI
            updateWarehouseUI();
            
            // Пересчитываем все строки с новым коэффициентом склада
            updateCommissionColumn();
            
            // Сохраняем настройки
            scheduleSave();
          }
        });
        
        // Кнопка очистки склада
        const clearWarehouseBtn = document.getElementById('clearWarehouse');
        if (clearWarehouseBtn) {
          clearWarehouseBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Очищаем поля
            warehouseSearch.value = '';
            inputs.warehouseCoef.value = '0';
            
            warehouseDropdown.style.display = 'none';
            
            // Обновляем UI
            updateWarehouseUI();
            
            // Пересчитываем все строки с новым коэффициентом склада
            updateCommissionColumn();
            
            // Сохраняем настройки
            scheduleSave();
          });
        }
        
        // Показываем поле коэффициента и кнопку очистки, если склад уже выбран при загрузке
        function updateWarehouseUI() {
          const hasWarehouse = warehouseSearch.value.trim();
          console.log('updateWarehouseUI called:', {
            warehouseValue: warehouseSearch.value,
            hasWarehouse: hasWarehouse,
            warehouseCoef: inputs.warehouseCoef.value
          });
          
          if (warehouseCoefField && warehouseCoefLabel) {
            if (hasWarehouse) {
              warehouseCoefField.style.display = 'block';
              warehouseCoefLabel.style.display = 'block';
            } else {
              warehouseCoefField.style.display = 'none';
              warehouseCoefLabel.style.display = 'none';
            }
          }
          if (clearWarehouseBtn) {
            clearWarehouseBtn.style.display = hasWarehouse ? 'block' : 'none';
          }
          
          // Пересчитываем логистику при изменении склада
          // Пересчет происходит автоматически при изменении параметров
        }
        
        // Инициализация при загрузке
        // Явно устанавливаем значение склада из сохраненных настроек
        const savedWarehouse = '{{ margin_settings.warehouse or "" }}';
        console.log('Debug warehouse restoration:', {
          savedWarehouse: savedWarehouse,
          warehouseSearchExists: !!warehouseSearch,
          savedWarehouseLength: savedWarehouse.length
        });
        
        if (warehouseSearch && savedWarehouse && savedWarehouse.trim()) {
          warehouseSearch.value = savedWarehouse;
          console.log('Restored warehouse from settings:', savedWarehouse);
        } else {
          console.log('Warehouse not restored - conditions not met');
        }
        updateWarehouseUI();
        
        // Инициализация фильтрации по остаткам
        const stocksFilterToggle = document.getElementById('stocksFilterToggle');
        const stocksFilterStatus = document.getElementById('stocksFilterStatus');
        
        function applyStocksFilter() {
          const isEnabled = stocksFilterToggle.checked;
          const tableRows = document.querySelectorAll('#productsTable tbody tr');
          let visibleCount = 0;
          let totalCount = tableRows.length;
          
          tableRows.forEach(row => {
            const barcode = row.getAttribute('data-barcode'); // Barcode хранится в атрибуте строки
            const stocks = barcode ? (stocksData[barcode] || 0) : 0;
            
            if (isEnabled) {
              // Показываем только товары с остатками >= 1
              if (stocks >= 1) {
                row.style.display = '';
                visibleCount++;
              } else {
                row.style.display = 'none';
              }
            } else {
              // Показываем все товары
              row.style.display = '';
              visibleCount++;
            }
          });
          
          // Обновляем статус
          if (isEnabled) {
            stocksFilterStatus.textContent = `(Показаны товары с остатками (${visibleCount} из ${totalCount}))`;
          } else {
            stocksFilterStatus.textContent = `(Показаны все товары (${visibleCount}))`;
          }
        }
        
        // Обработчик изменения переключателя
        if (stocksFilterToggle) {
          stocksFilterToggle.addEventListener('change', applyStocksFilter);
        }
      }

      // Изменение закупочной цены — пересчитывать прибыль и АВТОСОХРАНЯТЬ в БД (дебаунс)
      const pendingPricesToSave = {};
      let saveTimerSingle = null;
      function scheduleSaveSinglePrice(barcode, value){
        if (!barcode) return;
        const v = Number(value);
        if (isNaN(v) || v <= 0) return; // игнорируем пустые/некорректные
        pendingPricesToSave[barcode] = v;
        if (saveTimerSingle) clearTimeout(saveTimerSingle);
        saveTimerSingle = setTimeout(()=>{
          const batch = { ...pendingPricesToSave };
          for (const k in pendingPricesToSave) delete pendingPricesToSave[k];
          savePricesToDatabase(batch);
        }, 700);
      }

      document.querySelectorAll('.purchase-price').forEach(inp => {
        inp.addEventListener('input', (e) => {
          updateCommissionColumn();
          const barcode = e.target.getAttribute('data-barcode');
          scheduleSaveSinglePrice(barcode, e.target.value);
        });
        inp.addEventListener('change', (e) => {
          const barcode = e.target.getAttribute('data-barcode');
          scheduleSaveSinglePrice(barcode, e.target.value);
        });
        inp.addEventListener('blur', (e) => {
          const barcode = e.target.getAttribute('data-barcode');
          scheduleSaveSinglePrice(barcode, e.target.value);
        });
      });

      // Базовые значения для сравнения, чтобы понимать что реально изменилось
      const originalValues = new WeakMap();

      function ensureOriginalValue(input) {
        if (!input) return;
        if (!originalValues.has(input)) {
          // Нормализуем значение при установке baseline (заменяем запятые на точки)
          const normalizedValue = String(input.value ?? '').replace(',', '.');
          originalValues.set(input, normalizedValue);
        }
      }

      function markInputsChanged(inputs) {
        inputs.forEach(input => {
          if (!input) return;
          ensureOriginalValue(input);
          // Сравниваем текущее значение с исходным
          const orig = originalValues.get(input);
          const now = String(input.value ?? '').replace(',', '.');
          
          // Для числовых полей используем сравнение с допуском
          const isNumericInput = input.classList.contains('price-before-input') ||
                                 input.classList.contains('seller-discount-input') ||
                                 input.classList.contains('price-discount-input') ||
                                 input.classList.contains('price-wallet-input') ||
                                 input.classList.contains('profit-net-input') ||
                                 input.classList.contains('profit-pct-input');
          
          let changed = false;
          if (isNumericInput) {
            const numOrig = parseFloat(orig);
            const numNow = parseFloat(now);
            // Сравниваем с небольшой погрешностью для чисел с плавающей запятой
            changed = Math.abs(numNow - numOrig) > 0.1; // Допуск 0.1 (10 копеек)
          } else {
            changed = now !== orig;
          }
          
          if (changed) {
            input.classList.add('input-changed');
            // Показываем старое значение
            showOldValue(input, orig);
          } else {
            input.classList.remove('input-changed');
            // Скрываем старое значение
            hideOldValue(input);
          }
        });
      }

      // Обновляет baseline для программно измененных полей
      function updateBaselineForInputs(inputs) {
        inputs.forEach(input => {
          if (input) {
            originalValues.set(input, String(input.value ?? ''));
          }
        });
      }

      // Показывает старое значение под input'ом
      function showOldValue(input, oldValue) {
        if (!input || !oldValue) return;
        
        // Убираем старое отображение если есть
        hideOldValue(input);
        
        // Создаем элемент для старого значения и вставляем после input'а
        const oldValueElement = document.createElement('span');
        oldValueElement.className = 'old-value';
        oldValueElement.textContent = oldValue;
        input.parentElement.insertBefore(oldValueElement, input.nextSibling);
      }

      // Скрывает старое значение
      function hideOldValue(input) {
        if (!input) return;
        const parent = input.parentElement;
        if (parent) {
          const oldValueElement = parent.querySelector('.old-value');
          if (oldValueElement) {
            oldValueElement.remove();
          }
        }
      }

      // Редактирование цен: обновляем локальный объект и пересчитываем
      function bindPriceInputs(){
        document.querySelectorAll('.price-edit').forEach(inp => {
          inp.addEventListener('input', (e) => {
            const input = e.target;
            const nmId = input.getAttribute('data-nm-id');
            if (!nmId) return;
            const key = String(nmId);
            pricesData[key] = pricesData[key] || {};
            if (input.classList.contains('price-before-input')){
              const newPrice = Number(input.value) || 0;
              pricesData[key].price = newPrice;
              
              // Обновляем скидку продавца при изменении базовой цены
              const sellerDiscountInput = input.closest('tr').querySelector('.seller-discount-input');
              const discountInput = input.closest('tr').querySelector('.price-discount-input');
              const profitNetInput = input.closest('tr').querySelector('.profit-net-input');
              const profitPctInput = input.closest('tr').querySelector('.profit-pct-input');
              
              if (sellerDiscountInput && sellerDiscountInput.value) {
                const discountPercent = Number(sellerDiscountInput.value) || 0;
                const newDiscountPrice = newPrice * (1 - discountPercent / 100);
                pricesData[key].discount_price = newDiscountPrice;
                
                // Обновляем поле "Цена со скидкой"
                if (discountInput) {
                  discountInput.value = newDiscountPrice.toFixed(2);
                }
              }
              
              // Обновляем подсветку связанных инпутов
              markInputsChanged([input, discountInput, profitNetInput, profitPctInput]);
            } else if (input.classList.contains('price-discount-input')){
              const newDiscountPrice = Number(input.value) || 0;
              pricesData[key].discount_price = newDiscountPrice;
              
              // Пересчитываем скидку продавца при изменении цены со скидкой
              const basePrice = pricesData[key].price || 0;
              const sellerDiscountInput = input.closest('tr').querySelector('.seller-discount-input');
              const profitNetInput = input.closest('tr').querySelector('.profit-net-input');
              const profitPctInput = input.closest('tr').querySelector('.profit-pct-input');
              
              if (basePrice > 0) {
                const newSellerDiscountPercent = ((basePrice - newDiscountPrice) / basePrice) * 100;
                pricesData[key].seller_discount_percent = newSellerDiscountPercent;
                
                // Обновляем поле "Скидка продавца"
                if (sellerDiscountInput) {
                  sellerDiscountInput.value = Math.round(newSellerDiscountPercent);
                }
              }
              
              // Обновляем подсветку связанных инпутов
              markInputsChanged([input, sellerDiscountInput, profitNetInput, profitPctInput]);
            } else if (input.classList.contains('price-wallet-input')){
              pricesData[key].club_discount_price = Number(input.value) || 0;
              
              // Обновляем подсветку (WB клуб влияет только на себя)
              markInputsChanged([input]);
            }
            updateCommissionColumn();
          });
        });
        
        // Обработчик для скидки продавца
        document.querySelectorAll('.seller-discount-input').forEach(inp => {
          inp.addEventListener('input', (e) => {
            const input = e.target;
            const nmId = input.getAttribute('data-nm-id');
            if (!nmId) return;
            const key = String(nmId);
            pricesData[key] = pricesData[key] || {};
            
            const sellerDiscountPercent = Number(input.value) || 0;
            const basePrice = pricesData[key].price || 0;
            
            // Вычисляем новую цену со скидкой
            const newDiscountPrice = basePrice * (1 - sellerDiscountPercent / 100);
            
            // Обновляем данные
            pricesData[key].seller_discount_percent = sellerDiscountPercent;
            pricesData[key].discount_price = newDiscountPrice;
            
            // Обновляем поле "Цена со скидкой"
            const discountInput = input.closest('tr').querySelector('.price-discount-input');
            const profitNetInput = input.closest('tr').querySelector('.profit-net-input');
            const profitPctInput = input.closest('tr').querySelector('.profit-pct-input');
            
            if (discountInput) {
              discountInput.value = newDiscountPrice.toFixed(2);
            }
            
            // Обновляем подсветку связанных инпутов
            markInputsChanged([input, discountInput, profitNetInput, profitPctInput]);
            
            updateCommissionColumn();
          });
        });
      }
      bindPriceInputs();
      
      // Обратный расчет цены со скидкой по целевой прибыли (руб. или %)
      function bindProfitInputs(){
        document.querySelectorAll('#productsTable tbody tr').forEach(row => {
          const profitNetInput = row.querySelector('.profit-net-input');
          const profitPctInput = row.querySelector('.profit-pct-input');
          const purchaseInput = row.querySelector('.purchase-price');
          const nmId = row.getAttribute('data-nm-id');
          const key = nmId ? String(nmId) : null;

          function getExpensesForDiscount(discount){
            // Временная подстановка: проставим в DOM значения на основе discount, чтобы переиспользовать логику
            const tmpDirectInput = row.querySelector('.price-discount-input');
            if (tmpDirectInput){ tmpDirectInput.value = isNaN(discount) ? '' : Number(discount).toFixed(2); }
            if (key){
              pricesData[key] = pricesData[key] || {};
              pricesData[key].discount_price = Number(discount) || 0;
            }
            // Обновляем вычисляемые ячейки для строки
            updateCommissionColumn();
            // Считываем обратно приведенные значения расходов
            const parseCell = (sel)=>{
              const c = row.querySelector(sel);
              if (!c) return 0;
              const t = (c.textContent || '').replace('%','').replace('\u00A0',' ').replace('₽','').trim();
              const n = Number(t);
              return isNaN(n) ? 0 : n;
            };
            const commissionRub = parseCell('.commission-rub');
            const taxRub = parseCell('.tax-rub');
            const logisticsRub = parseCell('.logistics-rub');
            const storageRub = parseCell('.storage-rub');
            const receivingRub = parseCell('.receiving-rub');
            const acquiringRub = parseCell('.acquiring-rub');
            return commissionRub + taxRub + logisticsRub + storageRub + receivingRub + acquiringRub;
          }

          function setDiscountPrice(newDiscount){
            const discountInput = row.querySelector('.price-discount-input');
            const sellerDiscountInput = row.querySelector('.seller-discount-input');
            const profitNetInput = row.querySelector('.profit-net-input');
            const profitPctInput = row.querySelector('.profit-pct-input');
            
            if (discountInput){
              discountInput.value = isNaN(newDiscount) ? '' : Number(newDiscount).toFixed(2);
              // Обновить локальное хранилище
              if (key){
                pricesData[key] = pricesData[key] || {};
                pricesData[key].discount_price = Number(newDiscount) || 0;
                
                // Пересчитываем скидку продавца при изменении цены со скидкой
                const basePrice = pricesData[key].price || 0;
                if (basePrice > 0) {
                  const newSellerDiscountPercent = ((basePrice - newDiscount) / basePrice) * 100;
                  pricesData[key].seller_discount_percent = newSellerDiscountPercent;
                  
                  // Обновляем поле "Скидка продавца"
                  if (sellerDiscountInput) {
                    sellerDiscountInput.value = Math.round(newSellerDiscountPercent);
                  }
                }
              }
              
              // Обновляем подсветку связанных инпутов
              markInputsChanged([discountInput, sellerDiscountInput, profitNetInput, profitPctInput]);
            }
            updateCommissionColumn();
          }

          if (profitNetInput){
            const handler = ()=>{
              const targetProfitNet = Number(profitNetInput.value);
              const purchase = purchaseInput ? Number(purchaseInput.value) : 0;
              if (isNaN(targetProfitNet)) return;
              
              // Ищем discountPrice численным методом, т.к. расходы зависят от discount
              // Целевая функция: f(d) = d - expenses(d) - purchase - targetProfitNet = 0
              let left = 0;
              let right = 1_000_000; // верхняя оценка
              for (let i=0;i<25;i++){
                const mid = (left + right) / 2;
                const expenses = getExpensesForDiscount(mid);
                const f = mid - expenses - purchase - targetProfitNet;
                if (f >= 0) right = mid; else left = mid;
              }
              setDiscountPrice((left + right) / 2);
            };
            profitNetInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') handler(); });
            profitNetInput.addEventListener('change', handler);
            profitNetInput.addEventListener('blur', handler);
          }

          if (profitPctInput){
            const handler = ()=>{
              const targetPct = Number(profitPctInput.value);
              const purchase = purchaseInput ? Number(purchaseInput.value) : 0;
              if (isNaN(targetPct) || purchase <= 0) return;
              const targetProfitNet = purchase * (targetPct / 100);
              // Ищем discountPrice по той же схеме
              let left = 0;
              let right = 1_000_000;
              for (let i=0;i<25;i++){
                const mid = (left + right) / 2;
                const expenses = getExpensesForDiscount(mid);
                const f = mid - expenses - purchase - targetProfitNet;
                if (f >= 0) right = mid; else left = mid;
              }
              setDiscountPrice((left + right) / 2);
            };
            profitPctInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') handler(); });
            profitPctInput.addEventListener('change', handler);
            profitPctInput.addEventListener('blur', handler);
          }
        });
      }
      bindProfitInputs();
      // первичная отрисовка после загрузки
      updateCommissionColumn();
      
      // Зафиксируем исходные значения для всех контролов после первичного пересчета
      // Добавляем небольшую задержку, чтобы дать время всем вычислениям завершиться
      setTimeout(() => {
        document.querySelectorAll('.price-before-input, .seller-discount-input, .price-discount-input, .price-wallet-input, .profit-net-input, .profit-pct-input').forEach(inp=>{
          if (inp) {
            // Инициализируем baseline
            if (!originalValues.has(inp)) originalValues.set(inp, String(inp.value ?? '').replace(',', '.'));
          }
        });
        
        // Обновляем подсветку для всех полей после установки baseline
        document.querySelectorAll('.price-before-input, .seller-discount-input, .price-discount-input, .price-wallet-input, .profit-net-input, .profit-pct-input').forEach(inp=>{
          if (inp) {
            markInputsChanged([inp]);
          }
        });
      }, 100); // Задержка 100мс

      // ---- Видимость колонок (по аналогии с /fbw/planning) ----
      const columnsMap = [
        { key: 'idx', label: '#', selector: 'th:nth-child(1), td:nth-child(1)', exportKey: 'index' },
        { key: 'photo', label: 'Фото', selector: 'th:nth-child(2), td:nth-child(2)', exportKey: 'photo' },
        { key: 'name', label: 'Наименование', selector: 'th:nth-child(3), td:nth-child(3)', exportKey: 'name' },
        { key: 'nm_id', label: 'Артикул WB', selector: 'th:nth-child(3), td:nth-child(3)', exportKey: 'nm_id' },
        { key: 'barcode', label: 'Баркод', selector: 'th:nth-child(3), td:nth-child(3)', exportKey: 'barcode' },
        { key: 'stocks', label: 'Остатки', selector: 'th:nth-child(4), td:nth-child(4)', exportKey: 'stocks' },
        { key: 'purchase', label: 'Закупочная цена', selector: 'th:nth-child(5), td:nth-child(5)', exportKey: 'purchase' },
        { key: 'price_before', label: 'Цена до скидки', selector: 'th:nth-child(6), td:nth-child(6)', exportKey: 'price_before' },
        { key: 'seller_discount', label: 'Скидка продавца', selector: 'th:nth-child(7), td:nth-child(7)', exportKey: 'seller_discount' },
        { key: 'price_discount', label: 'Цена со скидкой', selector: 'th:nth-child(8), td:nth-child(8)', exportKey: 'price_discount' },
        { key: 'price_wallet', label: 'Цена со скидкой (WB клуб)', selector: 'th:nth-child(9), td:nth-child(9)', exportKey: 'price_wallet' },
        { key: 'category', label: 'Категория', selector: 'th:nth-child(10), td:nth-child(10)', exportKey: 'category' },
        { key: 'volume', label: 'Объём', selector: 'th:nth-child(11), td:nth-child(11)', exportKey: 'volume' },
        { key: 'commission_pct', label: 'Комиссия WB, %', selector: 'th:nth-child(12), td:nth-child(12)', exportKey: 'commission_pct' },
        { key: 'commission_rub', label: 'Комиссия WB руб.', selector: 'th:nth-child(13), td:nth-child(13)', exportKey: 'commission_rub' },
        { key: 'tax_rub', label: 'Налог руб.', selector: 'th:nth-child(14), td:nth-child(14)', exportKey: 'tax_rub' },
        { key: 'logistics_rub', label: 'Логистика руб.', selector: 'th:nth-child(15), td:nth-child(15)', exportKey: 'logistics_rub' },
        { key: 'storage_rub', label: 'Хранение руб.', selector: 'th:nth-child(16), td:nth-child(16)', exportKey: 'storage_rub' },
        { key: 'receiving_rub', label: 'Приёмка руб.', selector: 'th:nth-child(17), td:nth-child(17)', exportKey: 'receiving_rub' },
        { key: 'acquiring_rub', label: 'Эквайринг руб.', selector: 'th:nth-child(18), td:nth-child(18)', exportKey: 'acquiring_rub' },
        { key: 'total_expenses', label: 'Итого расходов: руб.', selector: 'th:nth-child(19), td:nth-child(19)', exportKey: 'total_expenses' },
        { key: 'expenses_pct', label: 'Расходов в %', selector: 'th:nth-child(20), td:nth-child(20)', exportKey: 'expenses_pct' },
        { key: 'price_to_receive', label: 'Цена к получению руб.', selector: 'th:nth-child(21), td:nth-child(21)', exportKey: 'price_to_receive' },
        { key: 'profit_net', label: 'Прибыль чистая руб.', selector: 'th:nth-child(22), td:nth-child(22)', exportKey: 'profit_net' },
        { key: 'profit_pct', label: 'Прибыль %', selector: 'th:nth-child(23), td:nth-child(23)', exportKey: 'profit_pct' },
      ];

      const COLUMNS_STORAGE_KEY = 'tools_prices_columns_visibility_v1';
      function loadColumnsVisibility(){
        try { return JSON.parse(localStorage.getItem(COLUMNS_STORAGE_KEY) || '{}'); } catch { return {}; }
      }
      function saveColumnsVisibility(map){
        localStorage.setItem(COLUMNS_STORAGE_KEY, JSON.stringify(map || {}));
      }
      function applyColumnsVisibility(map){
        columnsMap.forEach(c => {
          const visible = map[c.key] !== false; // по умолчанию показываем
          document.querySelectorAll(c.selector).forEach(el => {
            el.style.display = visible ? '' : 'none';
          });
        });
      }
      function renderColumnsChecklist(map){
        const wrap = document.getElementById('columnsChecklist');
        wrap.innerHTML = '';
        columnsMap.forEach(c => {
          const id = 'colchk_' + c.key;
          const visible = map[c.key] !== false;
          const div = document.createElement('div');
          div.className = 'form-check';
          div.innerHTML = `<input class="form-check-input" type="checkbox" id="${id}" ${visible ? 'checked' : ''}>`+
                          `<label class="form-check-label" for="${id}">${c.label}</label>`;
          wrap.appendChild(div);
        });
      }

      const columnsBtn = document.getElementById('columnsSettingsBtn');
      const columnsModalEl = document.getElementById('columnsSettingsModal');
      const columnsSaveBtn = document.getElementById('columnsSaveBtn');

      if (columnsBtn && columnsModalEl){
        columnsBtn.addEventListener('click', () => {
          const map = loadColumnsVisibility();
          renderColumnsChecklist(map);
          // Лениво создаем инстанс модалки, когда Bootstrap уже загружен
          const modal = (window.bootstrap && window.bootstrap.Modal)
            ? new window.bootstrap.Modal(columnsModalEl)
            : null;
          if (modal) modal.show();
        });
      }
      if (columnsSaveBtn){
        columnsSaveBtn.addEventListener('click', () => {
          const map = loadColumnsVisibility();
          columnsMap.forEach(c => {
            const id = 'colchk_' + c.key;
            const el = document.getElementById(id);
            if (el){ map[c.key] = !!el.checked; }
          });
          saveColumnsVisibility(map);
          applyColumnsVisibility(map);
          if (window.bootstrap && window.bootstrap.Modal){
            const modal = window.bootstrap.Modal.getInstance(columnsModalEl) || new window.bootstrap.Modal(columnsModalEl);
            modal.hide();
          }
        });
      }
      // Применяем сохраненную видимость при загрузке
      applyColumnsVisibility(loadColumnsVisibility());

      // Обновление списка товаров
      const refreshBtn = document.getElementById('refreshProducts');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', async function(){
          refreshBtn.disabled = true; 
          const prev = refreshBtn.textContent; 
          refreshBtn.textContent = 'Обновление...';
          try {
            const res = await fetch('/api/products/refresh', { method: 'POST' });
            const data = await res.json().catch(()=>({}));
            if (!res.ok) throw new Error(data.error || 'Ошибка обновления');
            location.reload();
          } catch (e) {
            console.error(e);
            refreshBtn.textContent = 'Ошибка';
            setTimeout(()=>{ refreshBtn.textContent = prev; refreshBtn.disabled = false; }, 1500);
            return;
          }
        });
      }
      
      // Поиск по товарам
      const search = document.getElementById('productsSearch');
      const tbody = document.querySelector('#productsTable tbody');
      if (search && tbody) {
        search.addEventListener('input', function(){
          const q = (this.value || '').toLowerCase().trim();
          const rows = tbody.querySelectorAll('tr');
          rows.forEach(r => {
            const txt = r.textContent.toLowerCase();
            r.style.display = q === '' || txt.indexOf(q) !== -1 ? '' : 'none';
          });
        });
      }

      // Предпросмотр изображений
      const preview = document.getElementById('imgPreview');
      const previewImg = document.getElementById('imgPreviewImg');
      document.addEventListener('mouseover', function(e){
        const t = e.target;
        if (t && t.classList && t.classList.contains('product-thumb')){
          const src = t.getAttribute('data-src') || t.getAttribute('src');
          previewImg.src = src;
          preview.style.display = 'block';
        }
      });
      document.addEventListener('mouseout', function(e){
        const t = e.target;
        if (t && t.classList && t.classList.contains('product-thumb')){
          preview.style.display = 'none';
          previewImg.src = '';
        }
      });
      
      // Загрузка Excel файла
      const uploadBtn = document.getElementById('actionUploadPrices');
      const fileInput = document.getElementById('excelFile');
      const uploadStatus = document.getElementById('uploadStatus');
      
      // Обработка клика по кнопке загрузки
      uploadBtn.addEventListener('click', () => fileInput.click());
      
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileUpload(e.target.files[0]);
        }
      });
      
      function handleFileUpload(file) {
        if (!file.name.match(/\.(xlsx|xls)$/i)) {
          showUploadStatus('Пожалуйста, выберите Excel файл (.xlsx или .xls)', 'danger');
          return;
        }
        
        showUploadStatus('Загрузка файла...', 'info');
        
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/api/prices/upload', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showUploadStatus(`Успешно загружено ${data.updated_count} цен`, 'success');
            // Обновляем поля закупочных цен
            updatePurchasePrices(data.prices);
          } else {
            showUploadStatus(data.error || 'Ошибка загрузки', 'danger');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showUploadStatus('Ошибка загрузки файла', 'danger');
        });
      }
      
      function showUploadStatus(message, type) {
        uploadStatus.innerHTML = `<div class="alert alert-${type} mb-0">${message}</div>`;
        uploadStatus.style.display = 'block';
        setTimeout(() => {
          uploadStatus.style.display = 'none';
        }, 5000);
      }
      
      function updatePurchasePrices(prices) {
        const priceInputs = document.querySelectorAll('.purchase-price');
        priceInputs.forEach(input => {
          const barcode = input.getAttribute('data-barcode');
          if (prices[barcode]) {
            input.value = prices[barcode];
            input.classList.add('table-success');
          }
        });
        
        // Автоматически сохраняем цены в базу данных
        savePricesToDatabase(prices);
      }
      
      function savePricesToDatabase(prices) {
        if (Object.keys(prices).length === 0) {
          return;
        }
        
        fetch('/api/prices/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ prices: prices })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('Цены автоматически сохранены:', data.message);
            // Убираем кнопку сохранения, так как уже сохранили
            const saveBtn = document.getElementById('savePrices');
            if (saveBtn) {
              saveBtn.style.display = 'none';
            }
          } else {
            console.error('Ошибка автоматического сохранения:', data.error);
            // Показываем кнопку сохранения для ручного сохранения
            const saveBtn = document.getElementById('savePrices');
            if (saveBtn) {
              saveBtn.style.display = 'inline-block';
            }
          }
        })
        .catch(error => {
          console.error('Ошибка при сохранении цен:', error);
          // Показываем кнопку сохранения для ручного сохранения
          const saveBtn = document.getElementById('savePrices');
          if (saveBtn) {
            saveBtn.style.display = 'inline-block';
          }
        });
      }
      
      // Сохранение изменений
      const saveBtn = document.getElementById('savePrices');
      if (saveBtn) {
        saveBtn.addEventListener('click', function() {
          const prices = {};
          const priceInputs = document.querySelectorAll('.purchase-price');
          priceInputs.forEach(input => {
            const barcode = input.getAttribute('data-barcode');
            const value = parseFloat(input.value);
            if (barcode && !isNaN(value) && value > 0) {
              prices[barcode] = value;
            }
          });
          
          if (Object.keys(prices).length === 0) {
            alert('Нет данных для сохранения');
            return;
          }
          
          saveBtn.disabled = true;
          saveBtn.textContent = 'Сохранение...';
          
          fetch('/api/prices/save', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ prices: prices })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showUploadStatus(`Сохранено ${data.saved_count} цен`, 'success');
              saveBtn.style.display = 'none';
            } else {
              showUploadStatus(data.error || 'Ошибка сохранения', 'danger');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showUploadStatus('Ошибка сохранения', 'danger');
          })
          .finally(() => {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Сохранить изменения';
          });
        });
      }
      
      // Экспорт в Excel
      const exportBtn = document.getElementById('actionExportExcel');
      if (exportBtn) {
        exportBtn.addEventListener('click', function(e) {
          e.preventDefault();
          exportBtn.classList.add('disabled');
          
          // Собираем данные для экспорта с учетом видимости колонок и актуальных значений
          const visibilityMap = loadColumnsVisibility();
          const visibleColumns = columnsMap.filter(col => visibilityMap[col.key] !== false);
          
          // Собираем актуальные данные из видимых строк таблицы
          const currentTableData = [];
          const visibleRows = document.querySelectorAll('#productsTable tbody tr:not([style*="display: none"])');
          
          visibleRows.forEach((row, index) => {
            const rowData = {
              index: index + 1,
              nm_id: row.getAttribute('data-nm-id'),
              barcode: row.getAttribute('data-barcode')
            };
            
            // Собираем данные из видимых колонок
            visibleColumns.forEach(col => {
              let value = '';
              
              switch(col.key) {
                case 'photo':
                  const img = row.querySelector('.product-thumb');
                  value = img ? img.src : '';
                  break;
                case 'name':
                  // Извлекаем только название товара (первый div в 3-й колонке)
                  const nameCell = row.querySelector('td:nth-child(3) div:first-child');
                  value = nameCell ? nameCell.textContent.trim() : '';
                  break;
                case 'nm_id':
                  // Извлекаем nm_id из data-атрибута строки
                  value = row.getAttribute('data-nm-id') || '';
                  break;
                case 'barcode':
                  // Извлекаем barcode из data-атрибута строки
                  value = row.getAttribute('data-barcode') || '';
                  break;
                case 'purchase':
                  const purchaseInput = row.querySelector('.purchase-price');
                  value = purchaseInput ? (purchaseInput.value || '') : '';
                  break;
                case 'price_before':
                  const priceBeforeInput = row.querySelector('.price-before-input');
                  value = priceBeforeInput ? (priceBeforeInput.value || '') : '';
                  break;
                case 'seller_discount':
                  const sellerDiscountInput = row.querySelector('.seller-discount-input');
                  value = sellerDiscountInput ? (sellerDiscountInput.value || '') : '';
                  break;
                case 'price_discount':
                  const priceDiscountInput = row.querySelector('.price-discount-input');
                  value = priceDiscountInput ? (priceDiscountInput.value || '') : '';
                  break;
                case 'price_wallet':
                  const priceWalletInput = row.querySelector('.price-wallet-input');
                  value = priceWalletInput ? (priceWalletInput.value || '') : '';
                  break;
                case 'stocks':
                  const stocksCell = row.querySelector('td:nth-child(4)');
                  value = stocksCell ? stocksCell.textContent.trim() : '';
                  break;
                case 'category':
                  const categoryCell = row.querySelector('td:nth-child(10)');
                  value = categoryCell ? categoryCell.textContent.trim() : '';
                  break;
                case 'volume':
                  const volumeCell = row.querySelector('td:nth-child(11)');
                  value = volumeCell ? volumeCell.textContent.trim() : '';
                  break;
                case 'commission_pct':
                  const commissionPctCell = row.querySelector('.commission-percent');
                  value = commissionPctCell ? commissionPctCell.textContent.trim() : '';
                  break;
                case 'commission_rub':
                  const commissionRubCell = row.querySelector('.commission-rub');
                  value = commissionRubCell ? commissionRubCell.textContent.trim() : '';
                  break;
                case 'tax_rub':
                  const taxCell = row.querySelector('.tax-rub');
                  value = taxCell ? taxCell.textContent.trim() : '';
                  break;
                case 'logistics_rub':
                  const logisticsCell = row.querySelector('.logistics-rub');
                  value = logisticsCell ? logisticsCell.textContent.trim() : '';
                  break;
                case 'storage_rub':
                  const storageCell = row.querySelector('.storage-rub');
                  value = storageCell ? storageCell.textContent.trim() : '';
                  break;
                case 'receiving_rub':
                  const receivingCell = row.querySelector('.receiving-rub');
                  value = receivingCell ? receivingCell.textContent.trim() : '';
                  break;
                case 'acquiring_rub':
                  const acquiringCell = row.querySelector('.acquiring-rub');
                  value = acquiringCell ? acquiringCell.textContent.trim() : '';
                  break;
                case 'total_expenses':
                  const totalCell = row.querySelector('.total-expenses-rub');
                  value = totalCell ? totalCell.textContent.trim() : '';
                  break;
                case 'expenses_pct':
                  const expensesPctCell = row.querySelector('.expenses-percent');
                  value = expensesPctCell ? expensesPctCell.textContent.trim() : '';
                  break;
                case 'price_to_receive':
                  const priceToReceiveCell = row.querySelector('.price-to-receive-rub');
                  value = priceToReceiveCell ? priceToReceiveCell.textContent.trim() : '';
                  break;
                case 'profit_net':
                  const profitNetInput = row.querySelector('.profit-net-input');
                  value = profitNetInput ? (profitNetInput.value || '') : '';
                  break;
                case 'profit_pct':
                  const profitPctInput = row.querySelector('.profit-pct-input');
                  value = profitPctInput ? (profitPctInput.value || '') : '';
                  break;
              }
              
              rowData[col.exportKey] = value;
            });
            
            currentTableData.push(rowData);
          });
          
          const exportData = {
            table_data: currentTableData,
            visible_columns: visibleColumns.map(col => col.exportKey),
            margin_settings: {
              tax: inputs.tax ? Number(inputs.tax.value) : 6,
              storage: inputs.storage ? Number(inputs.storage.value) : 0.5,
              receiving: inputs.receiving ? Number(inputs.receiving.value) : 1,
              acquiring: inputs.acquiring ? Number(inputs.acquiring.value) : 1.7,
              scheme: inputs.scheme ? inputs.scheme.value : 'FBW'
            }
          };
          
          console.log('Export data:', exportData);
          
          fetch('/api/prices/export-excel', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(exportData)
          })
          .then(response => {
            if (response.ok) {
              return response.blob();
            } else {
              return response.json().then(data => {
                throw new Error(data.error || 'Ошибка экспорта');
              });
            }
          })
          .then(blob => {
            // Создаем ссылку для скачивания
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Управление_ценами_${new Date().toISOString().slice(0, 10)}.xls`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
          })
          .catch(error => {
            console.error('Export error:', error);
            alert('Ошибка экспорта: ' + error.message);
          })
          .finally(() => {
            exportBtn.classList.remove('disabled');
          });
        });
      }
      
      // ---- Сортировка таблицы ----
      let currentSortColumn = null;
      let currentSortDirection = 'asc';
      
      function initSorting() {
        const sortableHeaders = document.querySelectorAll('.sortable');
        sortableHeaders.forEach(header => {
          header.addEventListener('click', function() {
            const column = this.getAttribute('data-column');
            if (!column) return;
            
            // Определяем направление сортировки
            if (currentSortColumn === column) {
              currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
              currentSortDirection = 'asc';
            }
            currentSortColumn = column;
            
            // Обновляем визуальные индикаторы
            updateSortIndicators(column, currentSortDirection);
            
            // Выполняем сортировку
            sortTable(column, currentSortDirection);
          });
        });
      }
      
      function updateSortIndicators(column, direction) {
        // Сбрасываем все индикаторы
        document.querySelectorAll('.sortable').forEach(header => {
          header.classList.remove('sort-asc', 'sort-desc');
        });
        
        // Устанавливаем индикатор для текущей колонки
        const currentHeader = document.querySelector(`[data-column="${column}"]`);
        if (currentHeader) {
          currentHeader.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      }
      
      function sortTable(column, direction) {
        const tbody = document.querySelector('#productsTable tbody');
        if (!tbody) return;
        
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
          let aValue, bValue;
          
          // Получаем значения в зависимости от колонки
          switch(column) {
            case 'purchase':
              const aPurchaseInput = a.querySelector('.purchase-price');
              const bPurchaseInput = b.querySelector('.purchase-price');
              aValue = aPurchaseInput ? parseFloat(aPurchaseInput.value) || 0 : 0;
              bValue = bPurchaseInput ? parseFloat(bPurchaseInput.value) || 0 : 0;
              break;
              
            case 'price_before':
              const aPriceBeforeInput = a.querySelector('.price-before-input');
              const bPriceBeforeInput = b.querySelector('.price-before-input');
              aValue = aPriceBeforeInput ? parseFloat(aPriceBeforeInput.value) || 0 : 0;
              bValue = bPriceBeforeInput ? parseFloat(bPriceBeforeInput.value) || 0 : 0;
              break;
              
            case 'price_discount':
              const aPriceDiscountInput = a.querySelector('.price-discount-input');
              const bPriceDiscountInput = b.querySelector('.price-discount-input');
              aValue = aPriceDiscountInput ? parseFloat(aPriceDiscountInput.value) || 0 : 0;
              bValue = bPriceDiscountInput ? parseFloat(bPriceDiscountInput.value) || 0 : 0;
              break;
              
            case 'price_wallet':
              const aPriceWalletInput = a.querySelector('.price-wallet-input');
              const bPriceWalletInput = b.querySelector('.price-wallet-input');
              aValue = aPriceWalletInput ? parseFloat(aPriceWalletInput.value) || 0 : 0;
              bValue = bPriceWalletInput ? parseFloat(bPriceWalletInput.value) || 0 : 0;
              break;
              
            case 'stocks':
              const aStocksCell = a.querySelector('td:nth-child(4)');
              const bStocksCell = b.querySelector('td:nth-child(4)');
              aValue = aStocksCell ? parseFloat(aStocksCell.textContent.trim()) || 0 : 0;
              bValue = bStocksCell ? parseFloat(bStocksCell.textContent.trim()) || 0 : 0;
              break;
              
            case 'category':
              const aCategoryCell = a.querySelector('td:nth-child(10)');
              const bCategoryCell = b.querySelector('td:nth-child(10)');
              aValue = aCategoryCell ? aCategoryCell.textContent.trim() : '';
              bValue = bCategoryCell ? bCategoryCell.textContent.trim() : '';
              break;
              
            case 'volume':
              const aVolumeCell = a.querySelector('td:nth-child(11)');
              const bVolumeCell = b.querySelector('td:nth-child(11)');
              aValue = aVolumeCell ? parseFloat(aVolumeCell.textContent.trim()) || 0 : 0;
              bValue = bVolumeCell ? parseFloat(bVolumeCell.textContent.trim()) || 0 : 0;
              break;
              
            case 'commission_pct':
              const aCommissionPctCell = a.querySelector('.commission-percent');
              const bCommissionPctCell = b.querySelector('.commission-percent');
              aValue = aCommissionPctCell ? parseFloat(aCommissionPctCell.textContent.replace('%', '')) || 0 : 0;
              bValue = bCommissionPctCell ? parseFloat(bCommissionPctCell.textContent.replace('%', '')) || 0 : 0;
              break;
              
            case 'commission_rub':
              const aCommissionRubCell = a.querySelector('.commission-rub');
              const bCommissionRubCell = b.querySelector('.commission-rub');
              aValue = aCommissionRubCell ? parseFloat(aCommissionRubCell.textContent) || 0 : 0;
              bValue = bCommissionRubCell ? parseFloat(bCommissionRubCell.textContent) || 0 : 0;
              break;
              
            case 'tax_rub':
              const aTaxCell = a.querySelector('.tax-rub');
              const bTaxCell = b.querySelector('.tax-rub');
              aValue = aTaxCell ? parseFloat(aTaxCell.textContent) || 0 : 0;
              bValue = bTaxCell ? parseFloat(bTaxCell.textContent) || 0 : 0;
              break;
              
            case 'logistics_rub':
              const aLogisticsCell = a.querySelector('.logistics-rub');
              const bLogisticsCell = b.querySelector('.logistics-rub');
              aValue = aLogisticsCell ? parseFloat(aLogisticsCell.textContent) || 0 : 0;
              bValue = bLogisticsCell ? parseFloat(bLogisticsCell.textContent) || 0 : 0;
              break;
              
            case 'storage_rub':
              const aStorageCell = a.querySelector('.storage-rub');
              const bStorageCell = b.querySelector('.storage-rub');
              aValue = aStorageCell ? parseFloat(aStorageCell.textContent) || 0 : 0;
              bValue = bStorageCell ? parseFloat(bStorageCell.textContent) || 0 : 0;
              break;
              
            case 'receiving_rub':
              const aReceivingCell = a.querySelector('.receiving-rub');
              const bReceivingCell = b.querySelector('.receiving-rub');
              aValue = aReceivingCell ? parseFloat(aReceivingCell.textContent) || 0 : 0;
              bValue = bReceivingCell ? parseFloat(bReceivingCell.textContent) || 0 : 0;
              break;
              
            case 'acquiring_rub':
              const aAcquiringCell = a.querySelector('.acquiring-rub');
              const bAcquiringCell = b.querySelector('.acquiring-rub');
              aValue = aAcquiringCell ? parseFloat(aAcquiringCell.textContent) || 0 : 0;
              bValue = bAcquiringCell ? parseFloat(bAcquiringCell.textContent) || 0 : 0;
              break;
              
            case 'total_expenses':
              const aTotalCell = a.querySelector('.total-expenses-rub');
              const bTotalCell = b.querySelector('.total-expenses-rub');
              aValue = aTotalCell ? parseFloat(aTotalCell.textContent) || 0 : 0;
              bValue = bTotalCell ? parseFloat(bTotalCell.textContent) || 0 : 0;
              break;
              
            case 'expenses_pct':
              const aExpensesPctCell = a.querySelector('.expenses-percent');
              const bExpensesPctCell = b.querySelector('.expenses-percent');
              aValue = aExpensesPctCell ? parseFloat(aExpensesPctCell.textContent.replace('%', '')) || 0 : 0;
              bValue = bExpensesPctCell ? parseFloat(bExpensesPctCell.textContent.replace('%', '')) || 0 : 0;
              break;
              
            case 'price_to_receive':
              const aPriceToReceiveCell = a.querySelector('.price-to-receive-rub');
              const bPriceToReceiveCell = b.querySelector('.price-to-receive-rub');
              aValue = aPriceToReceiveCell ? parseFloat(aPriceToReceiveCell.textContent) || 0 : 0;
              bValue = bPriceToReceiveCell ? parseFloat(bPriceToReceiveCell.textContent) || 0 : 0;
              break;
              
            case 'profit_net':
              const aProfitNetInput = a.querySelector('.profit-net-input');
              const bProfitNetInput = b.querySelector('.profit-net-input');
              aValue = aProfitNetInput ? parseFloat(aProfitNetInput.value) || 0 : 0;
              bValue = bProfitNetInput ? parseFloat(bProfitNetInput.value) || 0 : 0;
              break;
              
            case 'profit_pct':
              const aProfitPctInput = a.querySelector('.profit-pct-input');
              const bProfitPctInput = b.querySelector('.profit-pct-input');
              aValue = aProfitPctInput ? parseFloat(aProfitPctInput.value) || 0 : 0;
              bValue = bProfitPctInput ? parseFloat(bProfitPctInput.value) || 0 : 0;
              break;
              
            default:
              return 0;
          }
          
          // Сравниваем значения
          if (typeof aValue === 'string' && typeof bValue === 'string') {
            // Для строк используем лексикографическое сравнение
            const comparison = aValue.localeCompare(bValue, 'ru');
            return direction === 'asc' ? comparison : -comparison;
          } else {
            // Для чисел используем численное сравнение
            const comparison = aValue - bValue;
            return direction === 'asc' ? comparison : -comparison;
          }
        });
        
        // Очищаем tbody и добавляем отсортированные строки
        tbody.innerHTML = '';
        rows.forEach(row => {
          tbody.appendChild(row);
        });
        
        // Обновляем номера строк
        updateRowNumbers();
      }
      
      function updateRowNumbers() {
        const rows = document.querySelectorAll('#productsTable tbody tr');
        rows.forEach((row, index) => {
          const numberCell = row.querySelector('td:first-child');
          if (numberCell) {
            numberCell.textContent = index + 1;
          }
        });
      }
      
      // Инициализируем сортировку
      initSorting();

      // Скрываем индикатор загрузки после полной инициализации с небольшой задержкой
      setTimeout(() => {
        console.log('Скрываем индикатор загрузки...');
        hideLoading();
      }, 2000); // Увеличиваем задержку до 2 секунд чтобы точно увидеть индикатор
    })();
    
    // Инициализация Bootstrap tooltips после загрузки Bootstrap
    document.addEventListener('DOMContentLoaded', function() {
      // Ждем немного, чтобы Bootstrap точно загрузился
      setTimeout(() => {
        if (typeof bootstrap !== 'undefined') {
          const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
          });
        }
      }, 100);
    });
  </script>
  
  {% include '_footer.html' %}
</body>
</html>
