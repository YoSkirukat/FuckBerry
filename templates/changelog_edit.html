<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Редактор ченджлога — FuckBerry {{ app_version }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
</head>
<body>
  {% include '_navbar.html' %}
  <div class="container mt-3">
    <h1 class="mb-3" style="font-size:1.7rem;">Редактор ченджлога</h1>
    {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}
    {% if message %}<div class="alert alert-success">{{ message }}</div>{% endif %}
    <ul class="nav nav-tabs" id="clTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-wys" data-bs-toggle="tab" data-bs-target="#pane-wys" type="button" role="tab">Визуально</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-json" data-bs-toggle="tab" data-bs-target="#pane-json" type="button" role="tab">JSON</button>
      </li>
    </ul>
    <div class="tab-content border border-top-0 rounded-bottom p-3">
      <div class="tab-pane fade show active" id="pane-wys" role="tabpanel" aria-labelledby="tab-wys">
        <form method="post" action="/changelog/edit" class="row g-3" id="wysForm">
          <div class="col-12 col-md-3">
            <label class="form-label">Текущая версия</label>
            <input type="text" class="form-control" name="version" value="{{ app_version }}" />
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Дата</label>
            <input type="text" class="form-control" id="wysDate" name="date" placeholder="ДД.ММ.ГГГГ" value="{{ default_date }}" />
          </div>
          <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary" type="submit">Добавить</button>
            <a href="/changelog" class="btn btn-outline-secondary">Отмена</a>
          </div>
          <div class="col-12">
            <label class="form-label">Содержимое (HTML)</label>
            <div id="editor" class="form-control" style="min-height:260px; height:260px; overflow:auto;"></div>
            <div class="form-text">Можно форматировать текст, вставлять списки и ссылки</div>
          </div>
          <input type="hidden" name="html_content" id="htmlHidden" />
        </form>
      </div>
      <div class="tab-pane fade" id="pane-json" role="tabpanel" aria-labelledby="tab-json">
        <form method="post" action="/changelog/edit" class="row g-3">
          <div class="col-12 col-md-3">
            <label class="form-label">Текущая версия</label>
            <input type="text" class="form-control" name="version" value="{{ app_version }}" />
          </div>
          <div class="col-12">
            <label class="form-label">JSON записей ченджлога</label>
            <textarea name="entries_json" class="form-control" rows="18" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">{{ entries_json }}</textarea>
          </div>
          <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary" type="submit">Сохранить</button>
            <a href="/changelog" class="btn btn-outline-secondary">Отмена</a>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% include '_footer.html' %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet" />
  <script>
    (function(){
      const container = document.getElementById('editor');
      if (!container) return;
      const quill = new Quill(container, { theme: 'snow' });
      // preload latest entry html if present
      try {
        const entries = JSON.parse({{ entries_json|tojson|safe }});
        if (Array.isArray(entries) && entries.length) {
          const latest = entries[0];
          if (latest) {
            if (latest.html) {
              quill.root.innerHTML = latest.html;
            } else if (Array.isArray(latest.notes) && latest.notes.length) {
              const list = '<ul>' + latest.notes.map(n => `<li>${String(n)}</li>`).join('') + '</ul>';
              quill.root.innerHTML = list;
            }
          }
          if (latest && latest.date) {
            const d = document.getElementById('wysDate');
            if (d) d.value = latest.date;
          }
        }
      } catch(e) {}
      document.getElementById('wysForm')?.addEventListener('submit', function(){
        try{
          const html = quill.root.innerHTML;
          document.getElementById('htmlHidden').value = html;
        }catch(e){ console.error(e); }
      });
    })();
  </script>

</body>
</html>


