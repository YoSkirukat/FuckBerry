{% if subscription_banner.show %}
<div class="alert alert-warning rounded-0 mb-0 position-relative text-center fw-semibold py-1" role="alert" style="border:0;">
  –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç {{ subscription_banner.end_date }} (–æ—Å—Ç–∞–ª–æ—Å—å {{ subscription_banner.days_left }} –¥–Ω.).
  <button id="hideSubBanner" type="button" class="btn-close" aria-label="Close" style="position:absolute; right:8px; top:50%; transform: translateY(-50%);"></button>
</div>
<script>
  document.getElementById('hideSubBanner')?.addEventListener('click', function(){
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    const val = `${yyyy}-${mm}-${dd}`;
    document.cookie = `hide_sub_banner_until=${val}; Max-Age=86400; path=/`;
    this.closest('.alert').remove();
  });
</script>
{% endif %}
<style>
@keyframes slideInFromRight {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes pulse {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.2);
  }
  100% {
    transform: scale(1);
  }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-2px); }
  75% { transform: translateX(2px); }
}

.new-notification {
  animation: slideInFromRight 0.3s ease-out;
}

.notification-badge-pulse {
  animation: pulse 0.5s ease-in-out;
}

.notification-badge-shake {
  animation: shake 0.5s ease-in-out;
}

.notification-item {
  transition: all 0.2s ease;
}

.notification-item:hover {
  background-color: #f8f9fa;
}

/* Mobile notification icon styles */
@media (max-width: 991.98px) {
  .d-lg-none .nav-link {
    padding: 0.25rem;
    color: #6c757d;
    text-decoration: none;
  }
  
  .d-lg-none .nav-link:hover {
    color: #495057;
  }
  
  .d-lg-none .nav-link:focus {
    color: #495057;
    box-shadow: none;
  }
  
  .d-lg-none .dropdown-menu {
    margin-top: 0.5rem;
    border: 1px solid rgba(0,0,0,.15);
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,.175);
    width: 100vw !important;
    max-width: 100vw !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    position: fixed !important;
    top: 60px !important;
    margin: 0 !important;
    border-radius: 0 !important;
    z-index: 1050 !important;
  }
  
  /* Mobile notification items styling */
  .d-lg-none .dropdown-menu .notification-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .d-lg-none .dropdown-menu .notification-item:last-child {
    border-bottom: none;
  }
  
  .d-lg-none .dropdown-menu .dropdown-header {
    padding: 1rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
  }
  
  /* Reduce spacing between notification icon and menu button */
  .d-lg-none.d-flex {
    gap: 0.5rem;
  }
}
</style>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="/orders" style="font-weight: bold;"><img src="/logo.png" alt="logo" width="40" height="40"/> FuckBerry</a>
    
    <!-- Mobile notification icon - visible only on mobile -->
    {% if current_user.is_authenticated %}
    <div class="d-lg-none d-flex align-items-center" style="margin-left: 60px;">
      <a class="nav-link position-relative" href="#" id="mobileNotificationsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        üîî
        <span id="mobileNotificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none; top: 5px !important;">
          0
        </span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="mobileNotificationsDropdown" style="max-height: 70vh; overflow-y: auto;">
        <li><h6 class="dropdown-header d-flex justify-content-between align-items-center">
          <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
          <div class="d-flex gap-3">
            <a href="#" id="mobileMarkAllReadBtn" class="text-decoration-none" style="display: none; font-size: 12px; color: #28a745;" onclick="markAllNotificationsAsRead(); return false;" title="–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ">
              –ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ
            </a>
            <a href="#" id="mobileDeleteAllBtn" class="text-decoration-none" style="display: none; font-size: 12px; color: #dc3545;" onclick="deleteAllNotifications(); return false;" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
              –£–¥–∞–ª–∏—Ç—å –≤—Å–µ
            </a>
          </div>
        </h6></li>
        <li><hr class="dropdown-divider"></li>
        <div id="mobileNotificationsList">
          <li class="dropdown-item-text text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</li>
        </div>
      </ul>
    </div>
    {% endif %}
    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link {% if request.path.startswith('/orders') %}active{% endif %}" href="/orders" {% if request.path.startswith('/orders') %}aria-current="page"{% endif %}>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤</a>
        </li>
        
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle {% if request.path.startswith('/fbs') or request.path.startswith('/fbs-stock') %}active{% endif %}" href="#" id="fbsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å FBS</a>
          <ul class="dropdown-menu" aria-labelledby="fbsDropdown">
            <li><a class="dropdown-item {% if request.path == '/fbs' %}active{% endif %}" href="/fbs">–ó–∞–∫–∞–∑—ã FBS</a></li>
            <li><a class="dropdown-item {% if request.path.startswith('/fbs-stock') %}active{% endif %}" href="/fbs-stock">–û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ FBS</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle {% if request.path.startswith('/fbw') or request.path.startswith('/coefficients') %}active{% endif %}" href="#" id="fbwDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">–ü–æ—Å—Ç–∞–≤–∫–∏ FBW</a>
          <ul class="dropdown-menu" aria-labelledby="fbwDropdown">
            <li><a class="dropdown-item {% if request.path == '/fbw' %}active{% endif %}" href="/fbw">–°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–∞–≤–æ–∫ FBW</a></li>
            <li><a class="dropdown-item {% if request.path.startswith('/fbw/planning') %}active{% endif %}" href="/fbw/planning">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤–∫–∏</a></li>
            <li><a class="dropdown-item {% if request.path.startswith('/coefficients') %}active{% endif %}" href="/coefficients">–ö–æ—ç—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø—Ä–∏—ë–º–∫–∏</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if request.path.startswith('/products') %}active{% endif %}" href="/products" {% if request.path.startswith('/products') %}aria-current="page"{% endif %}>–¢–æ–≤–∞—Ä—ã</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle {% if request.path.startswith('/report') %}active{% endif %}" href="#" id="repDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            –û—Ç—á—ë—Ç—ã
          </a>
          <ul class="dropdown-menu" aria-labelledby="repDropdown">
            <li><a class="dropdown-item {% if request.path.startswith('/report/sales') %}active{% endif %}" href="/report/sales">–û—Ç—á—ë—Ç –ø–æ –∑–∞–∫–∞–∑–∞–º —Å–æ —Å–∫–ª–∞–¥–æ–≤</a></li>
            <li><a class="dropdown-item {% if request.path.startswith('/report/finance') %}active{% endif %}" href="/report/finance">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç</a></li>
            <li><a class="dropdown-item {% if request.path.startswith('/stocks') %}active{% endif %}" href="/stocks">–û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle {% if request.path.startswith('/tools') %}active{% endif %}" href="#" id="toolsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</a>
          <ul class="dropdown-menu" aria-labelledby="toolsDropdown">
            <li><a class="dropdown-item {% if request.path == '/tools/labels' %}active{% endif %}" href="/tools/labels">–≠—Ç–∏–∫–µ—Ç–∫–∏ –¥–ª—è –∫–æ—Ä–æ–±–æ–≤</a></li>
          </ul>
        </li>
      </ul>
      <ul class="navbar-nav ms-auto">
        {% if current_user.is_authenticated %}
          {% if current_user.is_admin %}
            <li class="nav-item"><a class="nav-link {% if request.path.startswith('/admin/users') %}active{% endif %}" href="/admin/users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a></li>
          {% endif %}
          
          <!-- Notifications Bell -->
          <li class="nav-item dropdown d-none d-lg-block">
            <a class="nav-link position-relative" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              üîî
              <span id="notificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none; top: 5px !important;">
                0
              </span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationsDropdown" style="min-width: 350px; max-height: 400px; overflow-y: auto;">
              <li><h6 class="dropdown-header d-flex justify-content-between align-items-center">
                <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                <div class="d-flex gap-3">
                  <a href="#" id="markAllReadBtn" class="text-decoration-none" style="display: none; font-size: 12px; color: #28a745;" onclick="markAllNotificationsAsRead(); return false;" title="–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ">
                    –ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ
                  </a>
                  <a href="#" id="deleteAllBtn" class="text-decoration-none" style="display: none; font-size: 12px; color: #dc3545;" onclick="deleteAllNotifications(); return false;" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
                    –£–¥–∞–ª–∏—Ç—å –≤—Å–µ
                  </a>
                </div>
              </h6></li>
              <li><hr class="dropdown-divider"></li>
              <div id="notificationsList">
                <li class="dropdown-item-text text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</li>
              </div>
            </ul>
          </li>
          
          <li class="nav-item"><a class="nav-link {% if request.path.startswith('/profile') %}active{% endif %}" href="/profile">{{ current_user.username }}</a></li>
          <li class="nav-item"><a class="nav-link" href="/logout">–í—ã–π—Ç–∏</a></li>
        {% else %}
          <li class="nav-item"><a class="nav-link {% if request.path.startswith('/login') %}active{% endif %}" href="/login">–í–æ–π—Ç–∏</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<script>
// Notification system
let notificationCheckInterval;
let lastNotificationCount = 0;
let lastNotifications = [];
let shownNotificationIds = new Set(); // Track which notifications have been shown

// Function to check for new notifications and update UI
function checkForNewNotifications() {
    // First get the count to check for new notifications
    fetch('/api/notifications/count')
        .then(response => response.json())
        .then(data => {
            const currentCount = data.count || 0;
            
            console.log('Checking notifications count:', {
                current: currentCount,
                last: lastNotificationCount
            });
            
            // Check if count increased (new notifications)
            if (currentCount > lastNotificationCount && lastNotificationCount >= 0) {
                console.log('New notifications detected! Count increased from', lastNotificationCount, 'to', currentCount);
                
                // Only show alerts if this is not the first load
                if (lastNotificationCount > 0) {
                    // Play notification sound
                    playNotificationSound();
                    
                    // Show browser notification
                    if (Notification.permission === 'granted') {
                        new Notification('–ù–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ', {
                            body: `–£ –≤–∞—Å ${currentCount - lastNotificationCount} –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ`,
                            icon: '/logo.png'
                        });
                    }
                    
                    // Add pulse and shake animation to badge
                    const badge = document.getElementById('notificationBadge');
                    const mobileBadge = document.getElementById('mobileNotificationBadge');
                    
                    if (badge) {
                        badge.classList.add('notification-badge-pulse', 'notification-badge-shake');
                        setTimeout(() => {
                            badge.classList.remove('notification-badge-pulse', 'notification-badge-shake');
                        }, 500);
                    }
                    if (mobileBadge) {
                        mobileBadge.classList.add('notification-badge-pulse', 'notification-badge-shake');
                        setTimeout(() => {
                            mobileBadge.classList.remove('notification-badge-pulse', 'notification-badge-shake');
                        }, 500);
                    }
                } else {
                    console.log('First load - not showing notification alerts');
                }
            }
            
            // Update last notification count
            lastNotificationCount = currentCount;
            
            // Update the UI if dropdown is open
            const dropdown = document.getElementById('notificationsDropdown');
            const mobileDropdown = document.getElementById('mobileNotificationsDropdown');
            
            if ((dropdown && dropdown.classList.contains('show')) || 
                (mobileDropdown && mobileDropdown.classList.contains('show'))) {
                loadNotifications();
            }
        })
        .catch(error => {
            console.error('Error checking notifications count:', error);
            console.error('Error details:', error.message, error.stack);
        });
}

// Function to play notification sound
function playNotificationSound() {
    try {
        // Create a simple beep sound using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
    } catch (e) {
        // Fallback: try to play a system sound if available
        console.log('Audio notification not available');
    }
}

function updateNotificationBadge() {
    fetch('/api/notifications/count')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('notificationBadge');
            const mobileBadge = document.getElementById('mobileNotificationBadge');
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            const mobileDeleteAllBtn = document.getElementById('mobileDeleteAllBtn');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const mobileMarkAllReadBtn = document.getElementById('mobileMarkAllReadBtn');
            
            // Check if count increased (new notifications)
            if (data.count > lastNotificationCount && lastNotificationCount >= 0) {
                console.log('Badge count increased from', lastNotificationCount, 'to', data.count);
                
                // Only show alerts if this is not the first load (lastNotificationCount > 0)
                if (lastNotificationCount > 0) {
                    // Play notification sound
                    playNotificationSound();
                    
                    // Show browser notification
                    if (Notification.permission === 'granted') {
                        new Notification('–ù–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ', {
                            body: `–£ –≤–∞—Å ${data.count - lastNotificationCount} –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ`,
                            icon: '/logo.png'
                        });
                    }
                    
                    // Add pulse and shake animation to both badges
                    if (badge) {
                        badge.classList.add('notification-badge-pulse', 'notification-badge-shake');
                        setTimeout(() => {
                            badge.classList.remove('notification-badge-pulse', 'notification-badge-shake');
                        }, 500);
                    }
                    if (mobileBadge) {
                        mobileBadge.classList.add('notification-badge-pulse', 'notification-badge-shake');
                        setTimeout(() => {
                            mobileBadge.classList.remove('notification-badge-pulse', 'notification-badge-shake');
                        }, 500);
                    }
                } else {
                    console.log('First load - not showing notification alerts');
                }
            }
            
            if (data.count > 0) {
                // Update desktop badge
                if (badge) {
                    badge.textContent = data.count;
                    badge.style.display = 'inline-block';
                }
                // Update mobile badge
                if (mobileBadge) {
                    mobileBadge.textContent = data.count;
                    mobileBadge.style.display = 'inline-block';
                }
                
                // Show buttons
                if (deleteAllBtn) deleteAllBtn.style.display = 'inline-block';
                if (mobileDeleteAllBtn) mobileDeleteAllBtn.style.display = 'inline-block';
                if (markAllReadBtn) markAllReadBtn.style.display = 'inline-block';
                if (mobileMarkAllReadBtn) mobileMarkAllReadBtn.style.display = 'inline-block';
            } else {
                // Hide badges
                if (badge) badge.style.display = 'none';
                if (mobileBadge) mobileBadge.style.display = 'none';
                
                // Show delete buttons but hide read buttons
                if (deleteAllBtn) deleteAllBtn.style.display = 'inline-block';
                if (mobileDeleteAllBtn) mobileDeleteAllBtn.style.display = 'inline-block';
                if (markAllReadBtn) markAllReadBtn.style.display = 'none';
                if (mobileMarkAllReadBtn) mobileMarkAllReadBtn.style.display = 'none';
            }
            
            lastNotificationCount = data.count;
        })
        .catch(error => {
            console.error('Error fetching notification count:', error);
            console.error('Error details:', error.message, error.stack);
        });
}

function loadNotifications() {
    fetch('/api/notifications?limit=10')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('notificationsList');
            const mobileContainer = document.getElementById('mobileNotificationsList');
            
            // Initialize lastNotifications and shownNotificationIds if empty
            if (lastNotifications.length === 0) {
                lastNotifications = data.notifications || [];
                // Mark all existing notifications as shown to prevent alerts on first load
                if (data.notifications && data.notifications.length > 0) {
                    data.notifications.forEach(notification => {
                        shownNotificationIds.add(notification.id);
                    });
                }
                console.log('Initial notifications loaded:', lastNotifications.length, lastNotifications.map(n => n.id));
            }
            
            // Function to create notification item HTML
            function createNotificationItem(notif, index) {
                const item = document.createElement('li');
                item.className = `dropdown-item notification-item ${notif.is_read ? '' : 'bg-primary bg-opacity-10'}`;
                item.style.cursor = 'pointer';
               
               // Add animation for new notifications (first few items)
               if (index < 3 && !notif.is_read) {
                   item.classList.add('new-notification');
               }
               
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥–∞—Ç—É –∏–∑ API
                const timeAgo = notif.created_at;
               
               // Get icon based on notification type
               let icon = 'üîî';
               if (notif.type === 'fbs_new_order') {
                   icon = 'üì¶';
               } else if (notif.type === 'version_update') {
                   icon = 'üîÑ';
               } else if (notif.type === 'system') {
                   icon = '‚ÑπÔ∏è';
               }
               
               item.innerHTML = `
                   <div class="d-flex align-items-center" style="position: relative;" onmouseover="this.querySelector('.delete-btn').style.opacity='1';" onmouseout="this.querySelector('.delete-btn').style.opacity='0.3';">
                       <div class="flex-grow-1" style="cursor: pointer; padding-right: 40px;">
                            <div class="fw-bold d-flex align-items-center gap-2">
                                <span>${icon}</span>
                                <span>${notif.title}</span>
                            </div>
                            <div class="small text-muted" style="word-wrap: break-word;">${notif.message.replace(/<a[^>]*href="([^"]*)"[^>]*>([^<]*)<\/a>/g, '$2')}</div>
                            ${notif.type === 'version_update' ? '<div class="mt-1"><a href="/changelog" class="btn btn-sm btn-outline-primary" style="font-size: 10px; padding: 2px 8px;">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a></div>' : ''}
                            ${notif.type === 'fbs_new_order' ? '<div class="mt-1"><a href="/fbs" class="btn btn-sm btn-outline-primary" style="font-size: 10px; padding: 2px 8px;">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a></div>' : ''}
                           <div class="small text-muted" style="font-size: 11px; color: gray !important; margin-top: 5px;">${timeAgo}</div>
                       </div>
                       <div class="d-flex align-items-center gap-2" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%);">
                           <button class="delete-btn btn btn-sm btn-outline-danger p-1" onclick="deleteNotification(${notif.id}, event)" title="–£–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ" style="width: 20px; height: 20px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #dc3545; background: #fff; transition: all 0.2s ease; opacity: 0.3;" onmouseover="this.style.opacity='1'; this.style.background='#dc3545'; this.style.color='#fff';" onmouseout="this.style.opacity='0.3'; this.style.background='#fff'; this.style.color='#dc3545';">
                               ‚úï
                           </button>
                       </div>
                   </div>
               `;
               
               // Add click handler to the content area (not the delete button)
               const contentArea = item.querySelector('.flex-grow-1');
               contentArea.addEventListener('click', (e) => {
                   // Don't handle click if it's on the "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" button
                   if (e.target.tagName === 'A' || e.target.closest('a')) {
                       return;
                   }
                   
                   // Prevent dropdown from closing
                   e.stopPropagation();
                   
                   if (!notif.is_read) {
                       markNotificationAsRead(notif.id);
                   }
               });
               
               // Set message with innerHTML to support HTML links
               const messageDiv = item.querySelector('.small.text-muted');
               if (messageDiv && notif.message) {
                   messageDiv.innerHTML = notif.message;
               }
               
               return item;
            }
            
            // Clear containers
            if (container) container.innerHTML = '';
            if (mobileContainer) mobileContainer.innerHTML = '';
            
            if (!data.notifications || data.notifications.length === 0) {
                const emptyMessage = '<li class="dropdown-item-text text-center text-muted">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</li>';
                if (container) container.innerHTML = emptyMessage;
                if (mobileContainer) mobileContainer.innerHTML = emptyMessage;
                return;
            }
            
            // Populate containers
            data.notifications.forEach((notif, index) => {
                const item = createNotificationItem(notif, index);
                if (container) {
                    container.appendChild(item.cloneNode(true));
                }
                if (mobileContainer) {
                    mobileContainer.appendChild(item);
                }
            });
        })
        .catch(error => {
            console.error('Error loading notifications:', error);
            console.error('Error details:', error.message, error.stack);
            const errorMessage = '<li class="dropdown-item-text text-center text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</li>';
            if (document.getElementById('notificationsList')) {
                document.getElementById('notificationsList').innerHTML = errorMessage;
            }
            if (document.getElementById('mobileNotificationsList')) {
                document.getElementById('mobileNotificationsList').innerHTML = errorMessage;
            }
        });
}

 function markNotificationAsRead(notificationId) {
     fetch(`/api/notifications/${notificationId}/read`, {
         method: 'POST',
         headers: {
             'Content-Type': 'application/json',
         }
     })
     .then(response => response.json())
     .then(data => {
         if (data.success) {
             // Find the notification item and update its background in both lists
             const notificationItems = document.querySelectorAll('.notification-item');
             notificationItems.forEach(item => {
                 const deleteBtn = item.querySelector(`[onclick*="${notificationId}"]`);
                 if (deleteBtn) {
                     // Remove the blue background and make it standard
                     item.classList.remove('bg-primary', 'bg-opacity-10');
                     item.classList.add('bg-light');
                 }
             });
             
             updateNotificationBadge();
             loadNotifications();
         }
     })
     .catch(error => console.error('Error marking notification as read:', error));
 }


function deleteNotification(notificationId, event) {
    // Prevent event bubbling to avoid triggering the notification click
    event.stopPropagation();
    
    // Find the notification item and add fade out animation
    const notificationItem = event.target.closest('.dropdown-item');
    if (notificationItem) {
        notificationItem.style.transition = 'opacity 0.2s ease-out, transform 0.2s ease-out';
        notificationItem.style.opacity = '0.3';
        notificationItem.style.transform = 'translateX(10px)';
    }
    
    fetch(`/api/notifications/${notificationId}/delete`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateNotificationBadge();
            loadNotifications();
        } else {
            // Restore opacity if deletion failed
            if (notificationItem) {
                notificationItem.style.opacity = '1';
                notificationItem.style.transform = 'translateX(0)';
            }
        }
    })
    .catch(error => {
        console.error('Error deleting notification:', error);
        // Restore opacity if deletion failed
        if (notificationItem) {
            notificationItem.style.opacity = '1';
            notificationItem.style.transform = 'translateX(0)';
        }
    });
}

function markAllNotificationsAsRead() {
    fetch('/api/notifications/read-all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateNotificationBadge();
            loadNotifications();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö');
        }
    })
    .catch(error => {
        console.error('Error marking all notifications as read:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö');
    });
}

function deleteAllNotifications() {
    fetch('/api/notifications/delete-all', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateNotificationBadge();
            loadNotifications();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π');
        }
    })
    .catch(error => {
        console.error('Error deleting all notifications:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π');
    });
}


// Initialize notification system
document.addEventListener('DOMContentLoaded', function() {
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    // Load initial data
    updateNotificationBadge();
    loadNotifications();
    
    // Set up event listeners
    // Note: markAllReadBtn was removed from UI
    
    // Set up dropdown event listeners
    const dropdown = document.getElementById('notificationsDropdown');
    const mobileDropdown = document.getElementById('mobileNotificationsDropdown');
    
    if (dropdown) {
        dropdown.addEventListener('show.bs.dropdown', function() {
            loadNotifications();
        });
    }
    
    if (mobileDropdown) {
        mobileDropdown.addEventListener('show.bs.dropdown', function() {
            loadNotifications();
        });
        
        // Close mobile dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const mobileDropdownMenu = document.querySelector('#mobileNotificationsDropdown + .dropdown-menu');
            if (mobileDropdownMenu && 
                !mobileDropdown.contains(event.target) && 
                !mobileDropdownMenu.contains(event.target)) {
                const bsDropdown = new bootstrap.Dropdown(mobileDropdown);
                bsDropdown.hide();
            }
        });
    }
    
    // Check for new notifications every 1 minute
    notificationCheckInterval = setInterval(function() {
        console.log('Interval check - updating badge and checking notifications');
        updateNotificationBadge();
        checkForNewNotifications();
    }, 60000);
    
    // Also check when user returns to the tab
    window.addEventListener('focus', function() {
        updateNotificationBadge();
        checkForNewNotifications();
    });
});

// Clean up interval when page unloads
window.addEventListener('beforeunload', function() {
    if (notificationCheckInterval) {
        clearInterval(notificationCheckInterval);
    }
});

// Test function for debugging - can be called from browser console
window.testNotifications = function() {
    console.log('Testing notifications...');
    console.log('Last notifications:', lastNotifications);
    updateNotificationBadge();
    checkForNewNotifications();
};

// Function to create test notification
function createTestNotification() {
    fetch('/api/notifications/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Test notification created');
            // Force update after a short delay to allow server to process
            setTimeout(() => {
                updateNotificationBadge();
                checkForNewNotifications();
            }, 1000);
        } else {
            console.error('Error creating test notification:', data.error);
        }
    })
    .catch(error => {
        console.error('Error creating test notification:', error);
    });
}
</script> 