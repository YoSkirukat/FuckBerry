<!doctype html>
<html lang="ru">
<head>
  {% block title %}<title>Профиль — WB Dashboard</title>{% endblock %}
  {% include '_header.html' %}
</head>
<body>
  {% include '_navbar.html' %}
  <div class="container mt-3">
    <h1 class="mb-4" style="font-size:1.6rem;">Профиль</h1>

    {% if current_user.display_name %}
    <div class="card mb-3"><div class="card-body">
      <h6 class="mb-2">Имя пользователя</h6>
      <div>{{ current_user.display_name }}</div>
    </div></div>
    {% endif %}

    <div class="row g-3">
      <div class="col-md-6">
        <div class="card h-100"><div class="card-body">
          <h6 class="mb-3">API токен Wildberries</h6>
          <form method="post" action="/profile/token" class="row g-3">
            <div class="col-12">
              <input name="token" type="password" class="form-control" value="{{ token }}" placeholder="Вставьте ваш WB токен" />
            </div>
            <div class="col-12 d-flex gap-2 align-items-center">
              <button class="btn btn-primary" type="submit">Сохранить</button>
              <button class="btn btn-outline-danger" type="submit" onclick="document.querySelector('[name=token]').value='';">Очистить</button>
              {% with msgs = get_flashed_messages() %}
                {% if msgs and 'Токен успешно добавлен' in msgs[-1] %}
                  <span class="text-success ms-2">Токен успешно добавлен</span>
                {% elif msgs and 'Токен удален' in msgs[-1] %}
                  <span class="text-success ms-2">Токен удален</span>
                {% elif msgs and 'Ошибка' in msgs[-1] %}
                  <span class="text-danger ms-2">{{ msgs[-1] }}</span>
                {% endif %}
              {% endwith %}
            </div>
          </form>

          {% if seller_info %}
            <div class="mt-3">
              <div class="text-muted">Наименование продавца</div>
              <div>{{ seller_info.name or seller_info.companyName or seller_info.supplierName }}</div>
            </div>
          {% endif %}

          {% if token_info %}
            <div class="mt-3">
              <h6 class="mb-2">Информация о токене</h6>
              <div class="row g-2">
                {% if token_info.created_at %}
                  <div class="col-12">
                    <div class="text-muted small">Дата создания</div>
                    <div>{{ token_info.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
                  </div>
                {% endif %}
                {% if token_info.expires_at %}
                  <div class="col-12">
                    <div class="text-muted small">Срок действия до</div>
                    <div class="{% if token_info.is_expired %}text-danger{% elif token_info.days_until_expiry <= 7 %}text-warning{% else %}text-success{% endif %}">
                      {{ token_info.expires_at.strftime('%d.%m.%Y %H:%M') }}
                      {% if token_info.days_until_expiry is defined %}
                        <span class="badge bg-{% if token_info.is_expired %}danger{% elif token_info.days_until_expiry <= 7 %}warning{% else %}success{% endif %} ms-2">
                          {% if token_info.is_expired %}
                            Истёк
                          {% elif token_info.days_until_expiry == 0 %}
                            Истекает сегодня
                          {% elif token_info.days_until_expiry == 1 %}
                            Истекает завтра
                          {% else %}
                            {{ token_info.days_until_expiry }} дн.
                          {% endif %}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
                {% if token_info.subject %}
                  <div class="col-12">
                    <div class="text-muted small">ID токена</div>
                    <div class="font-monospace small">{{ token_info.subject[:20] }}...</div>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div></div>
      </div>

      <div class="col-md-6">
        <div class="card h-100"><div class="card-body">
          <h6 class="mb-3">Смена пароля</h6>
          <form method="post" action="/profile/password" class="row g-3">
            <div class="col-12">
              <input name="old_password" type="password" class="form-control" placeholder="Текущий пароль" required />
            </div>
            <div class="col-12">
              <input name="new_password" type="password" class="form-control" placeholder="Новый пароль" required />
            </div>
            <div class="col-12 d-grid">
              <button class="btn btn-secondary" type="submit">Обновить пароль</button>
            </div>
          </form>
          {% with msgs = get_flashed_messages() %}
            {% if msgs %}
              <div class="mt-2">
                {% set m = msgs[-1] %}
                <div class="{{ 'text-success' if 'Пароль обновлён' in m else 'text-danger' }}">{{ m }}</div>
              </div>
            {% endif %}
          {% endwith %}
        </div></div>
      </div>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md-12">
        <div class="card"><div class="card-body">
          <h6 class="mb-3">Реквизиты для этикеток</h6>
          <form method="post" action="/profile/shipping" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Наименование отправителя</label>
              <input name="shipper_name" type="text" class="form-control" value="{{ current_user.shipper_name or '' }}" placeholder="ООО Ромашка / ИП Иванов..." />
            </div>
            <div class="col-md-6">
              <label class="form-label">Контактное лицо</label>
              <input name="contact_person" type="text" class="form-control" value="{{ current_user.contact_person or '' }}" placeholder="ФИО" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Телефон</label>
              <input name="phone" type="text" class="form-control" value="{{ current_user.phone or '' }}" placeholder="+7..." />
            </div>
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input name="email" type="email" class="form-control" value="{{ current_user.email or '' }}" placeholder="you@example.com" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Адрес склада отгрузки</label>
              <input name="shipper_address" type="text" class="form-control" value="{{ current_user.shipper_address or '' }}" placeholder="г. ..., ул. ..., склад ..." />
            </div>
            <div class="col-12 d-grid d-md-block">
              <button class="btn btn-primary" type="submit">Сохранить реквизиты</button>
            </div>
          </form>
        </div></div>
      </div>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md-12">
        <div class="card"><div class="card-body">
          <h6 class="mb-3">Кэширование данных о поставках для аналитики товаров</h6>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="text-muted small">Статус кэша</div>
              {% if supplies_cache_info %}
                <div class="d-flex align-items-center gap-2">
                  <span class="badge bg-{{ 'success' if supplies_cache_info.is_fresh else 'warning' }}">
                    {{ 'Актуален' if supplies_cache_info.is_fresh else 'Устарел' }}
                  </span>
                  <span class="text-muted small">(обновляется автоматически раз в сутки)</span>
                </div>
              {% else %}
                <div class="text-muted">Кэш не создан</div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <div class="text-muted small">Последнее обновление</div>
              {% if supplies_cache_info and supplies_cache_info.last_updated %}
                <div>{{ supplies_cache_info.last_updated[:19].replace('T', ' ') }}</div>
              {% else %}
                <div class="text-muted">—</div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <div class="text-muted small">Период кэша</div>
              {% if supplies_cache_info and supplies_cache_info.cache_period_from and supplies_cache_info.cache_period_to %}
                <div>{{ supplies_cache_info.cache_period_from }} — {{ supplies_cache_info.cache_period_to }}</div>
              {% else %}
                <div class="text-muted">—</div>
              {% endif %}
              
            </div>
            <div class="col-md-6">
              <div class="text-muted small">Обработано поставок</div>
              <div>{{ supplies_cache_info.total_supplies if supplies_cache_info else 0 }}</div>
            </div>
            <div class="col-12">
              <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-outline-primary" type="button" onclick="refreshSuppliesCache()">
                  <span class="spinner-border spinner-border-sm d-none" id="cacheSpinner"></span>
                  <span id="cacheButtonText">Обновить кэш вручную</span>
                </button>
                <div class="text-muted small">
                  Кэш содержит данные о поставках за последние 6 месяцев для быстрой аналитики товаров
                </div>
              </div>
              <div id="cacheMessage" class="mt-2"></div>
            </div>
          </div>
        </div></div>
      </div>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md-12">
        <div class="card"><div class="card-body">
          <h6 class="mb-3">Кэширование данных о заказах (за 6 месяцев)</h6>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="text-muted small">Статус кэша</div>
              {% set orders_meta = orders_cache_info %}
              {% if orders_meta %}
                <div class="d-flex align-items-center gap-2">
                  <span class="badge bg-{{ 'success' if orders_meta.is_fresh else 'warning' }}">
                    {{ 'Актуален' if orders_meta.is_fresh else 'Устарел' }}
                  </span>
                  <span class="text-muted small">(обновляется автоматически раз в сутки)</span>
                </div>
              {% else %}
                <div class="text-muted">Кэш не создан</div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <div class="text-muted small">Последнее обновление</div>
              {% if orders_meta and orders_meta.last_updated %}
                <div>{{ orders_meta.last_updated[:19].replace('T', ' ') }}</div>
              {% else %}
                <div class="text-muted">—</div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <div class="text-muted small">Период кэша</div>
              <div>
                {{ orders_meta.date_from if orders_meta else '—' }} — {{ orders_meta.date_to if orders_meta else '—' }}
              </div>
            </div>
            <div class="col-md-6">
              <div class="text-muted small">Заказов в кэше</div>
              <div>{{ orders_meta.total_orders_cached if orders_meta else 0 }}</div>
            </div>
            <div class="col-12">
              <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-outline-primary" type="button" onclick="refreshOrdersCache()">
                  <span class="spinner-border spinner-border-sm d-none" id="ordersCacheSpinner"></span>
                  <span id="ordersCacheButtonText">Обновить кэш заказов вручную</span>
                </button>
                <div class="text-muted small">
                  Подогрев кэша ускоряет построение аналитики заказов и товаров
                </div>
              </div>
              <div id="ordersCacheMessage" class="mt-2"></div>
            </div>
          </div>
        </div></div>
      </div>
    </div>

    <div class="card mt-4"><div class="card-body">
      <h6 class="mb-2">Срок действия учётной записи</h6>
      <div>Действует с: <strong>{{ valid_from or '-' }}</strong></div>
      <div>Действует по: <strong>{{ valid_to or '-' }}</strong></div>
      {% if validity_status %}
        <div class="mt-2"><span class="badge bg-{{ 'success' if validity_status=='active' else 'danger' }}">{{ 'Активна' if validity_status=='active' else 'Неактивна' }}</span></div>
      {% endif %}
    </div></div>
  </div>
  {% include '_footer.html' %}
  <script>
    async function refreshSuppliesCache() {
      const button = document.querySelector('button[onclick="refreshSuppliesCache()"]');
      const spinner = document.getElementById('cacheSpinner');
      const buttonText = document.getElementById('cacheButtonText');
      const messageDiv = document.getElementById('cacheMessage');
      
      // Показываем спиннер
      button.disabled = true;
      spinner.classList.remove('d-none');
      buttonText.textContent = 'Обновление...';
      messageDiv.innerHTML = '';
      
      try {
        const response = await fetch('/api/supplies/refresh-cache', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          messageDiv.innerHTML = `
            <div class="alert alert-info alert-dismissible fade show" role="alert">
              <strong>Запущено!</strong> ${result.message}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
          // Запускаем мониторинг статуса обновления
          monitorCacheStatus('supplies');
        } else if (response.status === 409) {
          // Кэш уже обновляется
          messageDiv.innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              <strong>Внимание!</strong> ${result.error}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
          // Запускаем мониторинг статуса обновления
          monitorCacheStatus('supplies');
        } else {
          messageDiv.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <strong>Ошибка!</strong> ${result.error || 'Неизвестная ошибка'}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
        }
      } catch (error) {
        messageDiv.innerHTML = `
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Ошибка!</strong> Не удалось обновить кэш: ${error.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `;
      } finally {
        // Скрываем спиннер
        button.disabled = false;
        spinner.classList.add('d-none');
        buttonText.textContent = 'Обновить кэш вручную';
      }
    }
  </script>
  <script>
    async function refreshOrdersCache(){
      const button = document.querySelector('button[onclick="refreshOrdersCache()"]');
      const spinner = document.getElementById('ordersCacheSpinner');
      const buttonText = document.getElementById('ordersCacheButtonText');
      const msg = document.getElementById('ordersCacheMessage');
      button.disabled=true; spinner.classList.remove('d-none'); buttonText.textContent='Обновление...'; msg.innerHTML='';
      try{
        const r = await fetch('/api/orders/refresh-cache',{method:'POST', headers:{'Content-Type':'application/json'}});
        const j = await r.json();
        if(r.ok && j.success){
          msg.innerHTML = `<div class="alert alert-info alert-dismissible fade show" role="alert">${j.message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
          // Запускаем мониторинг статуса обновления
          monitorCacheStatus('orders');
        } else if (r.status === 409) {
          // Кэш уже обновляется
          msg.innerHTML = `<div class="alert alert-warning alert-dismissible fade show" role="alert">Внимание: ${j.error}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
          // Запускаем мониторинг статуса обновления
          monitorCacheStatus('orders');
        } else {
          msg.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">Ошибка: ${j.error || 'Неизвестная ошибка'}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
        }
      } catch(e){
        msg.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">Ошибка: ${e.message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
      } finally {
        button.disabled=false; spinner.classList.add('d-none'); buttonText.textContent='Обновить кэш заказов вручную';
      }
    }

    // Функция мониторинга статуса обновления кэша
    async function monitorCacheStatus(cacheType) {
      const maxAttempts = 60; // Максимум 5 минут (60 * 5 секунд)
      let attempts = 0;
      
      const checkStatus = async () => {
        try {
          const response = await fetch('/api/cache/status');
          const status = await response.json();
          
          const isUpdating = cacheType === 'supplies' ? 
            status.supplies_cache_updating : 
            status.orders_cache_updating;
          
          if (!isUpdating) {
            // Обновление завершено, перезагружаем страницу
            window.location.reload();
            return;
          }
          
          attempts++;
          if (attempts < maxAttempts) {
            // Продолжаем мониторинг через 5 секунд
            setTimeout(checkStatus, 5000);
          } else {
            // Таймаут - перезагружаем страницу
            window.location.reload();
          }
        } catch (error) {
          console.error('Ошибка мониторинга статуса кэша:', error);
          // В случае ошибки перезагружаем страницу через 30 секунд
          setTimeout(() => window.location.reload(), 30000);
        }
      };
      
      // Начинаем мониторинг через 5 секунд
      setTimeout(checkStatus, 5000);
    }
  </script>
</body>
</html> 