<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ FBS ‚Äî WB Dashboard</title>
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <style>
    h1 { font-size: 1.7rem; }
    .thumb { width: 45px; height: 65px; object-fit: cover; cursor: zoom-in; }
    th, td { vertical-align: middle; }
    #imgPreview { display:none; position:fixed; left:50%; top:50%; transform: translate(-50%, -50%); z-index:1060; padding:4px; background:#fff; border:1px solid rgba(0,0,0,.15); box-shadow:0 .5rem 1rem rgba(0,0,0,.15); pointer-events: none; }
    #imgPreview img { max-width:420px; max-height:560px; display:block; }
    #stockSearch { padding: .5rem .5rem; }
    .warehouse-row { cursor: pointer; }
  </style>
</head>
<body>
  {% include '_navbar.html' %}

  <div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">–û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ FBS <span id="totalSpan"></span></h1>
      <div class="d-flex align-items-center gap-3">
        <div class="text-muted">–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="lastUpdated">{{ updated_at }}</span></div>
        <button id="refreshBtn" class="btn btn-outline-primary btn-sm" type="button">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </div>

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <div class="card">
      <div class="card-body">
        <div class="table-responsive" style="max-height:70vh;">
          <table class="table table-sm align-middle mb-0" id="stockTable">
            <thead class="table-light text-center" style="position: sticky; top: 0; z-index: 2; background: #fff;">
              <tr>
                <th style="width:64px;">#</th>
                <th>–°–∫–ª–∞–¥</th>
                <th>–¢–∏–ø —Ç–æ–≤–∞—Ä–∞</th>
                <th>–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏</th>
                <th>–í—Å–µ–≥–æ, —à—Ç.</th>
              </tr>
            </thead>
            <tbody id="stockBody">
              {% for w in warehouses %}
              <tr class="warehouse-row" data-wid="{{ w.id }}" data-wname="{{ w.name }}">
                <td class="text-center">{{ loop.index }}</td>
                <td class="text-start fw-semibold">{{ w.name }}</td>
                <td class="text-center">{{ w.cargoType }}</td>
                <td class="text-center">{{ w.deliveryType }}</td>
                <td class="text-center">{{ w.total_amount }}</td>
              </tr>
              {% endfor %}
              {% if not warehouses %}
              <tr><td colspan="5" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">–¢–æ–≤–∞—Ä—ã —Å–∫–ª–∞–¥–∞: <span id="whTitle" class="text-muted">–Ω–µ –≤—ã–±—Ä–∞–Ω</span></div>
          <div class="d-flex align-items-center gap-2" style="min-width:400px;">
            <input id="goodsSearch" type="search" class="form-control form-control-sm" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞" />
            <div class="dropdown">
              <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="excelActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                –î–µ–π—Å—Ç–≤–∏—è —Å Excel
              </button>
              <ul class="dropdown-menu" aria-labelledby="excelActionsDropdown">
                <li><a class="dropdown-item" href="#" id="exportCurrentStocksBtn">üì§ –í—ã–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å —Ç–µ–∫—É—â–∏–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" id="importStocksBtn">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏</a></li>
                <li><a class="dropdown-item" href="#" id="downloadTemplateBtn">üìÑ –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" id="autoUpdateSettingsBtn">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</a></li>
              </ul>
            </div>
            <button id="applyStocksBtn" class="btn btn-success btn-sm text-nowrap" type="button" disabled>–û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏</button>
          </div>
        </div>
        <div id="noticeContainer" class="mt-2" style="display:none;"></div>
        <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none;" />
        <div class="table-responsive" style="max-height:60vh;">
          <table class="table table-sm align-middle mb-0" id="goodsTable">
            <thead class="table-light text-center" style="position: sticky; top: 0; z-index: 1; background:#fff;">
              <tr>
                <th class="text-center" style="width:56px;">#</th>
                <th style="width:72px;">–§–æ—Ç–æ</th>
                <th>–ê—Ä—Ç–∏–∫—É–ª –ø—Ä–æ–¥–∞–≤—Ü–∞</th>
                <th>–ê—Ä—Ç–∏–∫—É–ª WB</th>
                <th>–ë–∞—Ä–∫–æ–¥</th>
                <th>–û—Å—Ç–∞—Ç–æ–∫</th>
              </tr>
            </thead>
            <tbody id="goodsBody">
              <tr><td colspan="6" class="text-center text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="imgPreview"><img id="imgPreviewImg" src="" alt="preview" /></div>

  <!-- Auto Update Settings Modal -->
  <div class="modal fade" id="autoUpdateModal" tabindex="-1" aria-labelledby="autoUpdateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="autoUpdateModalLabel">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="remoteFileUrl" class="form-label">URL —Ñ–∞–π–ª–∞ —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏</label>
            <input type="url" class="form-control" id="remoteFileUrl" placeholder="https://example.com/path/to/stocks.xlsx">
            <div class="form-text">–°—Å—ã–ª–∫–∞ –Ω–∞ Excel —Ñ–∞–π–ª —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏ "–ë–∞—Ä–∫–æ–¥" –∏ "–ö–æ–ª-–≤–æ"</div>
          </div>
          
          <div class="mb-3">
            <label for="checkInterval" class="form-label">–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (–º–∏–Ω—É—Ç—ã)</label>
            <select class="form-select" id="checkInterval">
              <option value="5">5 –º–∏–Ω—É—Ç</option>
              <option value="10">10 –º–∏–Ω—É—Ç</option>
              <option value="15">15 –º–∏–Ω—É—Ç</option>
              <option value="30">30 –º–∏–Ω—É—Ç</option>
              <option value="60" selected>1 —á–∞—Å</option>
              <option value="120">2 —á–∞—Å–∞</option>
              <option value="240">4 —á–∞—Å–∞</option>
              <option value="480">8 —á–∞—Å–æ–≤</option>
            </select>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="autoUpdateEnabled">
              <label class="form-check-label" for="autoUpdateEnabled">
                –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
              </label>
            </div>
          </div>

          <div class="mb-3" id="warehouseSettingsContainer" style="display:none;">
            <label class="form-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —Å–∫–ª–∞–¥–∞–º</label>
            <div id="warehouseSettings" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
              <div class="text-muted small">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–ª–∞–¥–æ–≤...</div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
            <div id="autoUpdateStatus" class="alert alert-info">
              <div id="statusText">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ</div>
              <div id="lastCheckTime" class="text-muted small mt-1"></div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</label>
            <div id="updateHistory" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
              <div class="text-muted small">–ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—É—Å—Ç–∞</div>
            </div>
          </div>
          
          <div id="modalNoticeContainer" class="mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button type="button" class="btn btn-success" id="manualUpdateBtn">–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞</button>
          <button type="button" class="btn btn-primary" id="saveAutoUpdateSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          <button type="button" class="btn btn-outline-danger" id="testConnectionBtn">–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
        </div>
      </div>
    </div>
  </div>

  {% include '_footer.html' %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // Hover preview like on /products
    const preview = document.getElementById('imgPreview');
    const previewImg = document.getElementById('imgPreviewImg');
    function bindPreview(){
      document.querySelectorAll('.thumb').forEach(img=>{
        img.addEventListener('mouseover', ()=>{ const src = img.getAttribute('data-src') || img.getAttribute('src'); if(src){ previewImg.src = src; preview.style.display='block'; }});
        img.addEventListener('mouseout', ()=>{ preview.style.display='none'; previewImg.src=''; });
      });
    }
    function setTotal(val){
      const s = document.getElementById('totalSpan');
      if (typeof val === 'number' && !isNaN(val)) s.textContent = `(${val} —à—Ç.)`; else s.textContent = '';
    }
    // initial from server rows
    (function(){
      try {
        const cells = Array.from(document.querySelectorAll('#stockBody tr td:last-child'));
        const total = cells.reduce((sum, td)=> sum + (parseInt(td.textContent.trim(), 10) || 0), 0);
        setTotal(total);
        bindPreview();
      } catch(_) { setTotal(0); }
    })();

    document.getElementById('refreshBtn')?.addEventListener('click', async ()=>{
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true; btn.textContent = '–û–±–Ω–æ–≤–ª—è–µ–º...';
      try{
        const res = await fetch('/api/fbs-stock/refresh', {method:'POST'});
        const data = await res.json();
        if(!res.ok) throw new Error(data.error||'–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
        const tbody = document.getElementById('stockBody');
        tbody.innerHTML = '';
        (data.warehouses||[]).forEach((w, idx)=>{
          const tr = document.createElement('tr');
          tr.className = 'warehouse-row'; tr.setAttribute('data-wid', w.id); tr.setAttribute('data-wname', w.name||'');
          tr.innerHTML = `
            <td class="text-center">${idx+1}</td>
            <td class="text-start fw-semibold">${w.name||''}</td>
            <td class="text-center">${w.cargoType||'-'}</td>
            <td class="text-center">${w.deliveryType||'-'}</td>
            <td class="text-center">${w.total_amount??0}</td>
          `;
          tbody.appendChild(tr);
        });
        document.getElementById('lastUpdated').textContent = data.updated_at||'';
      }catch(e){ console.error(e); }
      finally{ btn.disabled = false; btn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å'; }
    });

    // warehouse open/close and load goods
    let currentWarehouseId = null;
    let currentWarehouseName = '';
    document.getElementById('stockBody')?.addEventListener('click', async (e)=>{
      const row = e.target.closest('.warehouse-row');
      if (!row) return;
      const wid = row.getAttribute('data-wid');
      const wname = row.getAttribute('data-wname')||'';
      const title = document.getElementById('whTitle'); if (title) title.textContent = wname || `ID ${wid}`;
      const body = document.getElementById('goodsBody');
      try{
        body.innerHTML = '<tr><td colspan="6" class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
        const res = await fetch(`/api/fbs-stock/warehouse/${encodeURIComponent(wid)}`);
        const data = await res.json();
        if(!res.ok) throw new Error(data.error||'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        body.innerHTML = '';
        (data.rows||[]).forEach((r, idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="text-center">${idx+1}</td>
            <td class="text-center">${r.photo?`<img class=\"thumb\" src=\"${r.photo}\" data-src=\"${r.photo}\"/>`:'-'}</td>
            <td class="text-start">${r.nm_id?`<a href=\"https://www.wildberries.ru/catalog/${r.nm_id}/detail.aspx\" target=\"_blank\" rel=\"noopener\">${r.vendor_code||''}</a>`:(r.vendor_code||'')}</td>
            <td class="text-center">${r.nm_id||''}</td>
            <td class="text-center">${r.barcode||''}</td>
            <td class="text-center"><input type=\"number\" class=\"form-control form-control-sm stock-input\" value=\"${r.amount??0}\" data-sku=\"${r.barcode||''}\" style=\"width: 100px; margin: 0 auto;\"/></td>
          `;
          body.appendChild(tr);
        });
        bindPreview();
        // remember selected warehouse and reset edits
        currentWarehouseId = wid;
        currentWarehouseName = wname;
        edited.clear(); if (applyBtn) applyBtn.disabled = true;
        bindEditTracking();
      }catch(err){ body.innerHTML = '<tr><td colspan="6" class="text-center text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>'; }
    });

    // Track edits and enable apply button
    const applyBtn = document.getElementById('applyStocksBtn');
    if (applyBtn) applyBtn.disabled = true; // disabled by default
    let edited = new Map(); // sku -> amount
    function bindEditTracking(){
      document.querySelectorAll('.stock-input').forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const sku = inp.getAttribute('data-sku');
          const val = parseInt(inp.value, 10);
          if (!isNaN(val)) edited.set(sku, val); else edited.delete(sku);
          applyBtn.disabled = (edited.size === 0) || !currentWarehouseId;
        });
      });
    }
    bindEditTracking();

    // Notifications
    function showNotice(message, kind){
      const container = document.getElementById('noticeContainer');
      const isError = (kind === 'danger' || kind === 'error');
      const cls = isError ? 'alert-danger' : 'alert-success';
      const id = 'n' + String(Date.now());
      container.innerHTML = `
        <div id="${id}" class="alert ${cls} alert-dismissible fade show d-flex align-items-center" role="alert" style="position:relative;">
          <div class="me-2" aria-hidden="true">${isError ? '‚ö†Ô∏è' : '‚úÖ'}</div>
          <div class="flex-grow-1">${message}</div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          <div class="progress" style="position:absolute; left:0; right:0; bottom:-2px; height:2px; background:transparent;">
            <div class="progress-bar ${isError ? 'bg-danger' : 'bg-success'}" style="width:100%"></div>
          </div>
        </div>`;
      container.style.display = '';
      const alertEl = document.getElementById(id);
      const bar = alertEl.querySelector('.progress-bar');
      let left = 5000; const step = 100; // 5s
      const timer = setInterval(()=>{
        left -= step; if (left <= 0) { clearInterval(timer); const bsAlert = bootstrap.Alert.getOrCreateInstance(alertEl); bsAlert.close(); return; }
        const pct = Math.max(0, Math.round((left/5000)*100));
        bar.style.width = pct + '%';
      }, step);
      alertEl.addEventListener('closed.bs.alert', ()=>{ clearInterval(timer); container.style.display = 'none'; container.innerHTML=''; });
    }

    applyBtn?.addEventListener('click', async ()=>{
      if (edited.size === 0) return;
      applyBtn.disabled = true; const prev = applyBtn.textContent; applyBtn.textContent = '–û–±–Ω–æ–≤–ª—è–µ–º...';
      try{
        const stocks = Array.from(edited.entries()).map(([sku, amount])=>({sku, amount}));
        const res = await fetch('/api/fbs-stock/update', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({warehouseId: currentWarehouseId, stocks})});
        const data = await res.json().catch(()=>({}));
        if(!res.ok) throw new Error(data.detail || data.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤');
        edited.clear(); applyBtn.disabled = true; applyBtn.textContent = prev;
        showNotice('–û—Å—Ç–∞—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
      }catch(e){
        console.error(e);
        showNotice('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + (e.message||e), 'danger');
        applyBtn.textContent = prev; applyBtn.disabled = false;
      }
    });

    // Live search like /products
    (function(){
      const search = document.getElementById('stockSearch');
      const tbody = document.querySelector('#stockTable tbody');
      if (search && tbody) {
        search.addEventListener('input', function(){
          const q = (this.value || '').toLowerCase().trim();
          const rows = tbody.querySelectorAll('tr');
          rows.forEach(r => {
            const txt = r.textContent.toLowerCase();
            r.style.display = q === '' || txt.indexOf(q) !== -1 ? '' : 'none';
          });
        });
      }
    })();
    // Goods search within selected warehouse table
    (function(){
      const gSearch = document.getElementById('goodsSearch');
      const gBody = document.getElementById('goodsBody');
      if (gSearch && gBody) {
        gSearch.addEventListener('input', function(){
          const q = (this.value || '').toLowerCase().trim();
          const rows = gBody.querySelectorAll('tr');
          rows.forEach(r => {
            const txt = r.textContent.toLowerCase();
            r.style.display = q === '' || txt.indexOf(q) !== -1 ? '' : 'none';
          });
        });
      }
    })();

    // Excel actions dropdown functionality
    document.getElementById('downloadTemplateBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      downloadTemplateFile();
    });

    document.getElementById('exportCurrentStocksBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      exportCurrentStocks();
    });

    document.getElementById('importStocksBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('fileInput').click();
    });

    document.getElementById('autoUpdateSettingsBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      loadAutoUpdateSettings();
      new bootstrap.Modal(document.getElementById('autoUpdateModal')).show();
    });

    document.getElementById('autoUpdateEnabled')?.addEventListener('change', async (e) => {
      if (e.target.checked) {
        await loadWarehousesForSettings({});
      } else {
        document.getElementById('warehouseSettingsContainer').style.display = 'none';
      }
    });

    document.getElementById('fileInput')?.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const importBtn = document.getElementById('importStocksBtn');
      const originalText = importBtn.textContent;
      importBtn.style.pointerEvents = 'none';
      importBtn.textContent = '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª...';

      try {
        const data = await readExcelFile(file);
        const result = updateStocksFromFile(data);
        showNotice(result.message, result.success ? 'success' : 'danger');
      } catch (error) {
        console.error('Error processing file:', error);
        showNotice('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message, 'danger');
      } finally {
        importBtn.style.pointerEvents = '';
        importBtn.textContent = originalText;
        e.target.value = ''; // Clear file input
      }
    });

    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            resolve(jsonData);
          } catch (error) {
            reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å Excel —Ñ–∞–π–ª'));
          }
        };
        reader.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'));
        reader.readAsArrayBuffer(file);
      });
    }

    function updateStocksFromFile(data) {
      if (!data || data.length < 2) {
        return { success: false, message: '–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö' };
      }

      // Find column indices
      const headerRow = data[0];
      const barcodeCol = findColumnIndex(headerRow, ['–ë–∞—Ä–∫–æ–¥', 'barcode', 'Barcode', '–ë–ê–†–ö–û–î']);
      const quantityCol = findColumnIndex(headerRow, ['–ö–æ–ª-–≤–æ', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'quantity', 'Quantity', '–ö–û–õ-–í–û', '–ö–û–õ–ò–ß–ï–°–¢–í–û']);

      if (barcodeCol === -1 || quantityCol === -1) {
        return { 
          success: false, 
          message: '–ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏. –û–∂–∏–¥–∞—é—Ç—Å—è –∫–æ–ª–æ–Ω–∫–∏ "–ë–∞—Ä–∫–æ–¥" –∏ "–ö–æ–ª-–≤–æ"' 
        };
      }

      // Get current warehouse goods
      const stockInputs = document.querySelectorAll('.stock-input');
      if (stockInputs.length === 0) {
        return { success: false, message: '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥' };
      }

      let updated = 0;
      let notFound = 0;
      const fileData = new Map();

      // Parse file data
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (!row || row.length <= Math.max(barcodeCol, quantityCol)) continue;
        
        const barcode = String(row[barcodeCol] || '').trim();
        const quantity = parseInt(row[quantityCol], 10);
        
        if (barcode && !isNaN(quantity)) {
          fileData.set(barcode, quantity);
        }
      }

      // Update stock inputs
      stockInputs.forEach(input => {
        const sku = input.getAttribute('data-sku');
        if (fileData.has(sku)) {
          const newValue = fileData.get(sku);
          input.value = newValue;
          // Trigger input event to update edited map
          input.dispatchEvent(new Event('input', { bubbles: true }));
          updated++;
        } else {
          notFound++;
        }
      });

      const total = updated + notFound;
      return {
        success: true,
        message: `–û–±–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞—Ç–∫–∞ —É ${updated} —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ ${total}, –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ —É ${notFound} —Ç–æ–≤–∞—Ä–æ–≤`
      };
    }

    function findColumnIndex(headerRow, possibleNames) {
      for (let i = 0; i < headerRow.length; i++) {
        const cellValue = String(headerRow[i] || '').trim();
        if (possibleNames.some(name => cellValue.toLowerCase() === name.toLowerCase())) {
          return i;
        }
      }
      return -1;
    }

    function downloadTemplateFile() {
      // Create template data
      const templateData = [
        ['–ë–∞—Ä–∫–æ–¥', '–ö–æ–ª-–≤–æ'],
        ['1234567890123', '10'],
        ['2345678901234', '25'],
        ['3456789012345', '0'],
        ['4567890123456', '100']
      ];

      // Create workbook and worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(templateData);
      
      // Set column widths
      ws['!cols'] = [
        { wch: 15 }, // –ë–∞—Ä–∫–æ–¥
        { wch: 10 }  // –ö–æ–ª-–≤–æ
      ];

      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, '–û—Å—Ç–∞—Ç–∫–∏');

      // Generate filename with current date
      const now = new Date();
      const dateStr = now.toISOString().slice(0, 10);
      const filename = `—à–∞–±–ª–æ–Ω_–æ—Å—Ç–∞—Ç–∫–æ–≤_${dateStr}.xlsx`;

      // Download file
      XLSX.writeFile(wb, filename);
    }

    function exportCurrentStocks() {
      // Check if warehouse is selected
      const stockInputs = document.querySelectorAll('.stock-input');
      if (stockInputs.length === 0) {
        showNotice('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥', 'danger');
        return;
      }

      // Get current warehouse name
      const warehouseName = document.getElementById('whTitle').textContent || '—Å–∫–ª–∞–¥';
      
      // Prepare data
      const exportData = [
        ['–ê—Ä—Ç–∏–∫—É–ª –ø—Ä–æ–¥–∞–≤—Ü–∞', '–ê—Ä—Ç–∏–∫—É–ª WB', '–ë–∞—Ä–∫–æ–¥', '–û—Å—Ç–∞—Ç–æ–∫']
      ];

      // Collect data from table rows
      const tableRows = document.querySelectorAll('#goodsBody tr');
      tableRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 6) {
          const vendorCode = cells[2].textContent.trim();
          const nmId = cells[3].textContent.trim();
          const barcode = cells[4].textContent.trim();
          const stockInput = cells[5].querySelector('.stock-input');
          const stock = stockInput ? stockInput.value : '0';
          
          exportData.push([vendorCode, nmId, barcode, stock]);
        }
      });

      // Create workbook and worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(exportData);
      
      // Set column widths
      ws['!cols'] = [
        { wch: 20 }, // –ê—Ä—Ç–∏–∫—É–ª –ø—Ä–æ–¥–∞–≤—Ü–∞
        { wch: 15 }, // –ê—Ä—Ç–∏–∫—É–ª WB
        { wch: 15 }, // –ë–∞—Ä–∫–æ–¥
        { wch: 10 }  // –û—Å—Ç–∞—Ç–æ–∫
      ];

      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, '–û—Å—Ç–∞—Ç–∫–∏');

      // Generate filename with current date and warehouse
      const now = new Date();
      const dateStr = now.toISOString().slice(0, 10);
      const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-');
      const filename = `–æ—Å—Ç–∞—Ç–∫–∏_${warehouseName.replace(/[^a-zA-Z0-9]/g, '_')}_${dateStr}_${timeStr}.xlsx`;

      // Download file
      XLSX.writeFile(wb, filename);
      
      showNotice(`–§–∞–π–ª —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏ —Å–∫–∞—á–∞–Ω: ${filename}`, 'success');
    }

    // Auto Update Settings Functions
    function showModalNotice(message, kind) {
      const container = document.getElementById('modalNoticeContainer');
      const isError = (kind === 'danger' || kind === 'error');
      const cls = isError ? 'alert-danger' : 'alert-success';
      const id = 'modal-n' + String(Date.now());
      container.innerHTML = `
        <div id="${id}" class="alert ${cls} alert-dismissible fade show d-flex align-items-center" role="alert" style="position:relative;">
          <div class="me-2" aria-hidden="true">${isError ? '‚ö†Ô∏è' : '‚úÖ'}</div>
          <div class="flex-grow-1">${message}</div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          <div class="progress" style="position:absolute; left:0; right:0; bottom:-2px; height:2px; background:transparent;">
            <div class="progress-bar ${isError ? 'bg-danger' : 'bg-success'}" style="width:100%"></div>
          </div>
        </div>`;
      container.style.display = '';
      const alertEl = document.getElementById(id);
      const bar = alertEl.querySelector('.progress-bar');
      let left = 5000; const step = 100; // 5s
      const timer = setInterval(()=>{
        left -= step; if (left <= 0) { clearInterval(timer); const bsAlert = bootstrap.Alert.getOrCreateInstance(alertEl); bsAlert.close(); return; }
        const pct = Math.max(0, Math.round((left/5000)*100));
        bar.style.width = pct + '%';
      }, step);
      alertEl.addEventListener('closed.bs.alert', ()=>{ clearInterval(timer); container.style.display = 'none'; container.innerHTML=''; });
    }

    function formatDateTime(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${day}.${month}.${year} ${hours}:${minutes}:${seconds}`;
    }

    document.getElementById('saveAutoUpdateSettings')?.addEventListener('click', async () => {
      const url = document.getElementById('remoteFileUrl').value.trim();
      const interval = parseInt(document.getElementById('checkInterval').value);
      const enabled = document.getElementById('autoUpdateEnabled').checked;

      if (enabled && !url) {
        showModalNotice('–í–≤–µ–¥–∏—Ç–µ URL —Ñ–∞–π–ª–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'danger');
        return;
      }

      // Collect warehouse settings
      const warehouseSettings = {};
      document.querySelectorAll('.warehouse-checkbox').forEach(checkbox => {
        const warehouseId = checkbox.getAttribute('data-warehouse-id');
        warehouseSettings[warehouseId] = {
          enabled: checkbox.checked
        };
      });

      try {
        const response = await fetch('/api/fbs-stock/auto-update/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, interval, enabled, warehouses: warehouseSettings })
        });

        const data = await response.json();
        if (response.ok) {
          showModalNotice('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
          loadAutoUpdateSettings();
        } else {
          showModalNotice('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'danger');
        }
      } catch (error) {
        showModalNotice('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message, 'danger');
      }
    });

    document.getElementById('testConnectionBtn')?.addEventListener('click', async () => {
      const url = document.getElementById('remoteFileUrl').value.trim();
      if (!url) {
        showModalNotice('–í–≤–µ–¥–∏—Ç–µ URL —Ñ–∞–π–ª–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'danger');
        return;
      }

      const btn = document.getElementById('testConnectionBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '–¢–µ—Å—Ç–∏—Ä—É–µ–º...';

      try {
        const response = await fetch('/api/fbs-stock/auto-update/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        const data = await response.json();
        if (response.ok) {
          showModalNotice(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ! –§–∞–π–ª –Ω–∞–π–¥–µ–Ω. –†–∞–∑–º–µ—Ä: ${data.size} –±–∞–π—Ç, –¥–∞—Ç–∞: ${data.lastModified}`, 'success');
        } else {
          showModalNotice('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª'), 'danger');
        }
      } catch (error) {
        showModalNotice('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message, 'danger');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });

    document.getElementById('manualUpdateBtn')?.addEventListener('click', async () => {
      console.log('Manual update button clicked!');
      
      const url = document.getElementById('remoteFileUrl').value.trim();
      console.log('Remote file URL:', url);
      
      if (!url) {
        console.log('No URL provided, showing error');
        showModalNotice('–í–≤–µ–¥–∏—Ç–µ URL —Ñ–∞–π–ª–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'danger');
        return;
      }

      const btn = document.getElementById('manualUpdateBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '–û–±–Ω–æ–≤–ª—è–µ–º...';
      
      console.log('Making request to /api/fbs-stock/auto-update/manual-update');

      try {
        const response = await fetch('/api/fbs-stock/auto-update/manual-update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (response.ok) {
          showModalNotice(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${data.processed} —Ç–æ–≤–∞—Ä–æ–≤, –æ–±–Ω–æ–≤–ª–µ–Ω–æ ${data.updated} –æ—Å—Ç–∞—Ç–∫–æ–≤`, 'success');
          loadAutoUpdateSettings(); // Refresh settings to show updated history
        } else {
          showModalNotice('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'danger');
        }
      } catch (error) {
        console.error('Error during manual update:', error);
        showModalNotice('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error.message, 'danger');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });

    async function loadAutoUpdateSettings() {
      try {
        const response = await fetch('/api/fbs-stock/auto-update/settings');
        const data = await response.json();
        
        if (response.ok) {
          const globalSettings = data.global || data; // Support old format
          document.getElementById('remoteFileUrl').value = globalSettings.url || '';
          document.getElementById('checkInterval').value = globalSettings.interval || 60;
          document.getElementById('autoUpdateEnabled').checked = globalSettings.enabled || false;
          
          updateStatusDisplay(globalSettings);
          updateHistoryDisplay(globalSettings.history || []);
          
          // Load warehouses if auto-update is enabled
          if (globalSettings.enabled) {
            await loadWarehousesForSettings(data.warehouses || {});
          } else {
            document.getElementById('warehouseSettingsContainer').style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error loading auto-update settings:', error);
      }
    }

    async function loadWarehousesForSettings(warehouseSettings) {
      try {
        // Get warehouses from the current page data
        const warehouseRows = document.querySelectorAll('#stockBody tr.warehouse-row');
        const warehouseSettingsContainer = document.getElementById('warehouseSettings');
        
        if (warehouseRows.length === 0) {
          warehouseSettingsContainer.innerHTML = '<div class="text-muted small">–°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–∫–ª–∞–¥–æ–≤</div>';
          document.getElementById('warehouseSettingsContainer').style.display = 'block';
          return;
        }
        
        let html = '';
        warehouseRows.forEach(row => {
          const warehouseId = row.getAttribute('data-wid');
          const warehouseName = row.getAttribute('data-wname');
          const isEnabled = warehouseSettings[warehouseId]?.enabled || false;
          
          html += `
            <div class="form-check mb-2">
              <input class="form-check-input warehouse-checkbox" type="checkbox" 
                     id="warehouse_${warehouseId}" 
                     data-warehouse-id="${warehouseId}"
                     ${isEnabled ? 'checked' : ''}>
              <label class="form-check-label" for="warehouse_${warehouseId}">
                ${warehouseName}
              </label>
            </div>
          `;
        });
        
        warehouseSettingsContainer.innerHTML = html;
        document.getElementById('warehouseSettingsContainer').style.display = 'block';
        
      } catch (error) {
        console.error('Error loading warehouses:', error);
        document.getElementById('warehouseSettings').innerHTML = '<div class="text-danger small">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–ª–∞–¥–æ–≤</div>';
      }
    }

    function updateStatusDisplay(settings) {
      const statusDiv = document.getElementById('autoUpdateStatus');
      const statusText = document.getElementById('statusText');
      const lastCheckTime = document.getElementById('lastCheckTime');

      if (settings.enabled) {
        statusDiv.className = 'alert alert-success';
        statusText.textContent = `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ ${settings.interval} –º–∏–Ω)`;
        lastCheckTime.textContent = settings.lastCheck ? `–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞: ${formatDateTime(settings.lastCheck)}` : '';
      } else {
        statusDiv.className = 'alert alert-info';
        statusText.textContent = '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ';
        lastCheckTime.textContent = '';
      }
    }

    function updateHistoryDisplay(history) {
      const historyDiv = document.getElementById('updateHistory');
      
      if (history.length === 0) {
        historyDiv.innerHTML = '<div class="text-muted small">–ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—É—Å—Ç–∞</div>';
        return;
      }

      const historyHtml = history.map(entry => {
        const statusClass = entry.success ? 'text-success' : 'text-danger';
        const statusIcon = entry.success ? '‚úÖ' : '‚ùå';
        return `
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="small">${statusIcon} ${formatDateTime(entry.timestamp)}</span>
            <span class="small ${statusClass}">${entry.message}</span>
          </div>
        `;
      }).join('');

      historyDiv.innerHTML = historyHtml;
    }
  </script>
</body>
</html>






