<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Остатки на складе FBS — WB Dashboard</title>
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <style>
    h1 { font-size: 1.7rem; }
    .thumb { width: 45px; height: 65px; object-fit: cover; cursor: zoom-in; }
    th, td { vertical-align: middle; }
    #imgPreview { display:none; position:fixed; left:50%; top:50%; transform: translate(-50%, -50%); z-index:1060; padding:4px; background:#fff; border:1px solid rgba(0,0,0,.15); box-shadow:0 .5rem 1rem rgba(0,0,0,.15); pointer-events: none; }
    #imgPreview img { max-width:420px; max-height:560px; display:block; }
    #stockSearch { padding: .5rem .5rem; }
    .warehouse-row { cursor: pointer; }
  </style>
</head>
<body>
  {% include '_navbar.html' %}

  <div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">Остатки на складе FBS <span id="totalSpan"></span></h1>
      <div class="d-flex align-items-center gap-3">
        <div class="text-muted">Обновлено: <span id="lastUpdated">{{ updated_at }}</span></div>
        <button id="refreshBtn" class="btn btn-outline-primary btn-sm" type="button">Обновить</button>
      </div>
    </div>

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <div class="card">
      <div class="card-body">
        <div class="table-responsive" style="max-height:70vh;">
          <table class="table table-sm align-middle mb-0" id="stockTable">
            <thead class="table-light text-center" style="position: sticky; top: 0; z-index: 2; background: #fff;">
              <tr>
                <th style="width:64px;">#</th>
                <th>Склад</th>
                <th>Тип товара</th>
                <th>Тип доставки</th>
                <th>Всего, шт.</th>
              </tr>
            </thead>
            <tbody id="stockBody">
              {% for w in warehouses %}
              <tr class="warehouse-row" data-wid="{{ w.id }}" data-wname="{{ w.name }}">
                <td class="text-center">{{ loop.index }}</td>
                <td class="text-start fw-semibold">{{ w.name }}</td>
                <td class="text-center">{{ w.cargoType }}</td>
                <td class="text-center">{{ w.deliveryType }}</td>
                <td class="text-center">{{ w.total_amount }}</td>
              </tr>
              {% endfor %}
              {% if not warehouses %}
              <tr><td colspan="5" class="text-center text-muted">Нет данных</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">Товары склада: <span id="whTitle" class="text-muted">не выбран</span></div>
          <div class="d-flex align-items-center gap-2" style="min-width:260px;">
            <input id="goodsSearch" type="search" class="form-control form-control-sm" placeholder="Поиск товара" />
            <button id="applyStocksBtn" class="btn btn-success btn-sm text-nowrap" type="button" disabled>Обновить остатки</button>
          </div>
        </div>
        <div id="noticeContainer" class="mt-2" style="display:none;"></div>
        <div class="table-responsive" style="max-height:60vh;">
          <table class="table table-sm align-middle mb-0" id="goodsTable">
            <thead class="table-light text-center" style="position: sticky; top: 0; z-index: 1; background:#fff;">
              <tr>
                <th class="text-center" style="width:56px;">#</th>
                <th style="width:72px;">Фото</th>
                <th>Артикул продавца</th>
                <th>Артикул WB</th>
                <th>Баркод</th>
                <th>Остаток</th>
              </tr>
            </thead>
            <tbody id="goodsBody">
              <tr><td colspan="6" class="text-center text-muted">Выберите склад</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="imgPreview"><img id="imgPreviewImg" src="" alt="preview" /></div>
  {% include '_footer.html' %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Hover preview like on /products
    const preview = document.getElementById('imgPreview');
    const previewImg = document.getElementById('imgPreviewImg');
    function bindPreview(){
      document.querySelectorAll('.thumb').forEach(img=>{
        img.addEventListener('mouseover', ()=>{ const src = img.getAttribute('data-src') || img.getAttribute('src'); if(src){ previewImg.src = src; preview.style.display='block'; }});
        img.addEventListener('mouseout', ()=>{ preview.style.display='none'; previewImg.src=''; });
      });
    }
    function setTotal(val){
      const s = document.getElementById('totalSpan');
      if (typeof val === 'number' && !isNaN(val)) s.textContent = `(${val} шт.)`; else s.textContent = '';
    }
    // initial from server rows
    (function(){
      try {
        const cells = Array.from(document.querySelectorAll('#stockBody tr td:last-child'));
        const total = cells.reduce((sum, td)=> sum + (parseInt(td.textContent.trim(), 10) || 0), 0);
        setTotal(total);
        bindPreview();
      } catch(_) { setTotal(0); }
    })();

    document.getElementById('refreshBtn')?.addEventListener('click', async ()=>{
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true; btn.textContent = 'Обновляем...';
      try{
        const res = await fetch('/api/fbs-stock/refresh', {method:'POST'});
        const data = await res.json();
        if(!res.ok) throw new Error(data.error||'Ошибка обновления');
        const tbody = document.getElementById('stockBody');
        tbody.innerHTML = '';
        (data.warehouses||[]).forEach((w, idx)=>{
          const tr = document.createElement('tr');
          tr.className = 'warehouse-row'; tr.setAttribute('data-wid', w.id); tr.setAttribute('data-wname', w.name||'');
          tr.innerHTML = `
            <td class="text-center">${idx+1}</td>
            <td class="text-start fw-semibold">${w.name||''}</td>
            <td class="text-center">${w.cargoType||'-'}</td>
            <td class="text-center">${w.deliveryType||'-'}</td>
            <td class="text-center">${w.total_amount??0}</td>
          `;
          tbody.appendChild(tr);
        });
        document.getElementById('lastUpdated').textContent = data.updated_at||'';
      }catch(e){ console.error(e); }
      finally{ btn.disabled = false; btn.textContent = 'Обновить'; }
    });

    // warehouse open/close and load goods
    let currentWarehouseId = null;
    let currentWarehouseName = '';
    document.getElementById('stockBody')?.addEventListener('click', async (e)=>{
      const row = e.target.closest('.warehouse-row');
      if (!row) return;
      const wid = row.getAttribute('data-wid');
      const wname = row.getAttribute('data-wname')||'';
      const title = document.getElementById('whTitle'); if (title) title.textContent = wname || `ID ${wid}`;
      const body = document.getElementById('goodsBody');
      try{
        body.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Загрузка...</td></tr>';
        const res = await fetch(`/api/fbs-stock/warehouse/${encodeURIComponent(wid)}`);
        const data = await res.json();
        if(!res.ok) throw new Error(data.error||'Ошибка загрузки');
        body.innerHTML = '';
        (data.rows||[]).forEach((r, idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="text-center">${idx+1}</td>
            <td class="text-center">${r.photo?`<img class=\"thumb\" src=\"${r.photo}\" data-src=\"${r.photo}\"/>`:'-'}</td>
            <td class="text-start">${r.nm_id?`<a href=\"https://www.wildberries.ru/catalog/${r.nm_id}/detail.aspx\" target=\"_blank\" rel=\"noopener\">${r.vendor_code||''}</a>`:(r.vendor_code||'')}</td>
            <td class="text-center">${r.nm_id||''}</td>
            <td class="text-center">${r.barcode||''}</td>
            <td class="text-center"><input type=\"number\" class=\"form-control form-control-sm stock-input\" value=\"${r.amount??0}\" data-sku=\"${r.barcode||''}\" style=\"width: 100px; margin: 0 auto;\"/></td>
          `;
          body.appendChild(tr);
        });
        bindPreview();
        // remember selected warehouse and reset edits
        currentWarehouseId = wid;
        currentWarehouseName = wname;
        edited.clear(); if (applyBtn) applyBtn.disabled = true;
        bindEditTracking();
      }catch(err){ body.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Ошибка загрузки</td></tr>'; }
    });

    // Track edits and enable apply button
    const applyBtn = document.getElementById('applyStocksBtn');
    if (applyBtn) applyBtn.disabled = true; // disabled by default
    let edited = new Map(); // sku -> amount
    function bindEditTracking(){
      document.querySelectorAll('.stock-input').forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const sku = inp.getAttribute('data-sku');
          const val = parseInt(inp.value, 10);
          if (!isNaN(val)) edited.set(sku, val); else edited.delete(sku);
          applyBtn.disabled = (edited.size === 0) || !currentWarehouseId;
        });
      });
    }
    bindEditTracking();

    // Notifications
    function showNotice(message, kind){
      const container = document.getElementById('noticeContainer');
      const isError = (kind === 'danger' || kind === 'error');
      const cls = isError ? 'alert-danger' : 'alert-success';
      const id = 'n' + String(Date.now());
      container.innerHTML = `
        <div id="${id}" class="alert ${cls} alert-dismissible fade show d-flex align-items-center" role="alert" style="position:relative;">
          <div class="me-2" aria-hidden="true">${isError ? '⚠️' : '✅'}</div>
          <div class="flex-grow-1">${message}</div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          <div class="progress" style="position:absolute; left:0; right:0; bottom:-2px; height:2px; background:transparent;">
            <div class="progress-bar ${isError ? 'bg-danger' : 'bg-success'}" style="width:100%"></div>
          </div>
        </div>`;
      container.style.display = '';
      const alertEl = document.getElementById(id);
      const bar = alertEl.querySelector('.progress-bar');
      let left = 5000; const step = 100; // 5s
      const timer = setInterval(()=>{
        left -= step; if (left <= 0) { clearInterval(timer); const bsAlert = bootstrap.Alert.getOrCreateInstance(alertEl); bsAlert.close(); return; }
        const pct = Math.max(0, Math.round((left/5000)*100));
        bar.style.width = pct + '%';
      }, step);
      alertEl.addEventListener('closed.bs.alert', ()=>{ clearInterval(timer); container.style.display = 'none'; container.innerHTML=''; });
    }

    applyBtn?.addEventListener('click', async ()=>{
      if (edited.size === 0) return;
      applyBtn.disabled = true; const prev = applyBtn.textContent; applyBtn.textContent = 'Обновляем...';
      try{
        const stocks = Array.from(edited.entries()).map(([sku, amount])=>({sku, amount}));
        const res = await fetch('/api/fbs-stock/update', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({warehouseId: currentWarehouseId, stocks})});
        const data = await res.json().catch(()=>({}));
        if(!res.ok) throw new Error(data.detail || data.error || 'Ошибка обновления остатков');
        edited.clear(); applyBtn.disabled = true; applyBtn.textContent = prev;
        showNotice('Остатки обновлены', 'success');
      }catch(e){
        console.error(e);
        showNotice('Ошибка обновления: ' + (e.message||e), 'danger');
        applyBtn.textContent = prev; applyBtn.disabled = false;
      }
    });

    // Live search like /products
    (function(){
      const search = document.getElementById('stockSearch');
      const tbody = document.querySelector('#stockTable tbody');
      if (search && tbody) {
        search.addEventListener('input', function(){
          const q = (this.value || '').toLowerCase().trim();
          const rows = tbody.querySelectorAll('tr');
          rows.forEach(r => {
            const txt = r.textContent.toLowerCase();
            r.style.display = q === '' || txt.indexOf(q) !== -1 ? '' : 'none';
          });
        });
      }
    })();
    // Goods search within selected warehouse table
    (function(){
      const gSearch = document.getElementById('goodsSearch');
      const gBody = document.getElementById('goodsBody');
      if (gSearch && gBody) {
        gSearch.addEventListener('input', function(){
          const q = (this.value || '').toLowerCase().trim();
          const rows = gBody.querySelectorAll('tr');
          rows.forEach(r => {
            const txt = r.textContent.toLowerCase();
            r.style.display = q === '' || txt.indexOf(q) !== -1 ? '' : 'none';
          });
        });
      }
    })();
  </script>
</body>
</html>


