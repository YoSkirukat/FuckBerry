<!doctype html>
<html lang="ru">
<head>
  {% block title %}<title>Маркетплейс DBS — WB Dashboard</title>{% endblock %}
  {% include '_header.html' %}
  {% block extra_styles %}
  <style>
    h1 { font-size: 1.7rem; }
    .status-badge {
      display: inline-block;
      padding: 0.15rem 0.4rem;
      border-radius: 0.25rem;
      font-weight: 600;
      line-height: 1.1;
    }
    .status-ok {
      color: #0f5132; /* тёмно-зелёный */
      background-color: #d1e7dd; /* светло-зелёный фон */
    }
    .status-cancel {
      color: #842029; /* красный текст */
      background-color: #f8d7da; /* розовый фон */
    }
    .status-pending {
      color: #b35c00; /* тёмно-оранжевый */
      background-color: #ffe5cc; /* светло-оранжевый фон */
    }
    .status-deliver {
      color: #084298; /* тёмно-синий */
      background-color: #cfe2ff; /* светло-синий фон */
    }
  </style>
  {% endblock %}
</head>
<body>
  {% include '_navbar.html' %}

  <div class="container mt-3">
    <h1 class="mb-4">Маркетплейс DBS</h1>

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    {% if products_hint %}
      <div class="alert alert-warning">{{ products_hint }}</div>
    {% endif %}

    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2">
          <h6 class="mb-0">Новые заказы DBS</h6>
          <div class="d-flex align-items-center gap-2 small text-muted">
            <span>Обновлено: <span id="dbsUpdatedAt">—</span></span>
            <button id="dbsRefreshBtn" class="btn btn-sm btn-outline-primary">Обновить</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-striped">
            <thead>
              <tr>
                <th class="text-center" style="width:40px;">
                  <input type="checkbox" id="selectAllDbs" class="form-check-input">
                </th>
                <th class="text-center" style="width:60px;">#</th>
                <th class="text-center">Номер и дата заказа</th>
                <th class="text-center" style="width:70px;">Фото</th>
                <th class="text-center">Наименование товара</th>
                <th class="text-center">Цена</th>
                <th class="text-center">Адрес</th>
                <th class="text-center">Баркод</th>
              </tr>
            </thead>
            <tbody id="dbsBody">
              <tr><td colspan="8" class="text-muted text-center">Загрузка...</td></tr>
            </tbody>
          </table>
          <div class="d-flex justify-content-between mt-2">
            <button id="dbsDeliverBtn" class="btn btn-primary btn-sm" disabled>
              Передать в доставку (<span id="selectedDbsCount">0</span>)
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container mt-4">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2">
          <h6 class="mb-0">Завершённые задания DBS</h6>
          <div class="d-flex align-items-center gap-2 small text-muted">
            <span>Загружено: <span id="dbsDoneUpdatedAt">—</span></span>
            <button id="dbsDoneRefreshBtn" class="btn btn-sm btn-outline-primary">Обновить</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-striped" id="dbsDoneTable">
            <thead>
              <tr>
                <th class="text-center" style="width:60px;">#</th>
                <th class="text-center" style="width:140px;">Статус</th>
                <th class="text-center">Номер и дата заказа</th>
                <th class="text-center" style="width:70px;">Фото</th>
                <th class="text-center">Наименование товара</th>
                <th class="text-center">Баркод</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="text-muted">Загрузка...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="text-center mt-2">
          <button id="dbsDoneMoreBtn" class="btn btn-outline-secondary btn-sm d-none">Показать ещё</button>
        </div>
      </div>
    </div>
  </div>

  <div id="imgPreview" style="display:none; position:fixed; left:50%; top:50%; transform: translate(-50%, -50%); z-index:1060; padding:4px; background:#fff; border:1px solid rgba(0,0,0,.15); box-shadow:0 .5rem 1rem rgba(0,0,0,.15); pointer-events: none;">
    <img id="imgPreviewImg" src="" alt="preview" style="max-width:420px; max-height:560px; display:block;" />
  </div>

  <script>
    (function(){
      const preview = document.getElementById('imgPreview');
      const previewImg = document.getElementById('imgPreviewImg');
      document.addEventListener('mouseover', function(e){
        const t = e.target;
        if (t && t.classList && t.classList.contains('product-thumb')){
          const src = t.getAttribute('data-src') || t.getAttribute('src');
          previewImg.src = src;
          preview.style.display = 'block';
        }
      });
      document.addEventListener('mouseout', function(e){
        const t = e.target;
        if (t && t.classList && t.classList.contains('product-thumb')){
          preview.style.display = 'none';
          previewImg.src = '';
        }
      });
    })();

    let dbsBtn, dbsTime;
    let dbsDoneBtn, dbsDoneTime, dbsDoneMoreBtn;
    let dbsDoneNext = null;
    let selectedDbs = new Set();

    document.addEventListener('DOMContentLoaded', function(){
      dbsBtn = document.getElementById('dbsRefreshBtn');
      dbsTime = document.getElementById('dbsUpdatedAt');
      dbsBtn?.addEventListener('click', ()=> loadDbsOrders(true));
      dbsDoneBtn = document.getElementById('dbsDoneRefreshBtn');
      dbsDoneTime = document.getElementById('dbsDoneUpdatedAt');
      dbsDoneMoreBtn = document.getElementById('dbsDoneMoreBtn');
      dbsDoneBtn?.addEventListener('click', ()=> loadDbsDone(true));
      dbsDoneMoreBtn?.addEventListener('click', ()=> loadDbsDone(false, true));
      document.getElementById('dbsDeliverBtn')?.addEventListener('click', deliverSelected);
      loadDbsOrders(true);
      loadDbsDone(true);
    });

    function setDbsLoading(isLoading){
      if (dbsBtn){
        dbsBtn.disabled = !!isLoading;
        dbsBtn.textContent = isLoading ? 'Загрузка…' : 'Обновить';
      }
    }

    async function loadDbsOrders(refresh){
      try{
        setDbsLoading(true);
        const r = await fetch('/api/dbs/orders/new' + (refresh ? '?refresh=1' : ''), { credentials: 'include' });
        const d = await r.json();
        renderDbs(d);
      }catch(e){
        console.error(e);
        const tbody = document.getElementById('dbsBody');
        if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-muted text-center">Ошибка загрузки</td></tr>';
      }finally{
        setDbsLoading(false);
      }
    }

    function renderDbs(data){
      const tbody = document.getElementById('dbsBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      (data.items || []).forEach((r, idx) => {
        const tr = document.createElement('tr');
        const parts = String(r['Номер и дата заказа']||'').split(' | ');
        const num = parts[0]||''; const dt = parts[1]||'';
        const img = r.photo ? `<img src='${r.photo}' class='product-thumb' style='width:31px;height:42px;object-fit:cover;'>` : '—';
        tr.innerHTML = `<td class="text-center"><input type="checkbox" class="form-check-input dbs-checkbox" data-order-id="${r.orderId || ''}"></td>
          <td class="text-center">${idx+1}</td>
          <td><div>${num}</div>${dt?`<div class='text-muted' style='font-size:0.68rem;'>${dt}</div>`:''}</td>
          <td class="text-center">${img}</td>
          <td>${r['Наименование товара']||''}</td>
          <td class="text-center">${r['Цена']!=null ? r['Цена'] : ''}</td>
          <td>${r['Адрес']||''}</td>
          <td>${r.barcode || '—'}</td>`;
        tbody.appendChild(tr);
      });
      if (!(data.items||[]).length){
        tbody.innerHTML = '<tr><td colspan="8" class="text-muted text-center">Нет новых заказов DBS</td></tr>';
      }
      if (dbsTime) dbsTime.textContent = data.updated_at || '—';
      // reset selection
      selectedDbs.clear();
      updateDeliverButton();
      const selectAll = document.getElementById('selectAllDbs');
      if (selectAll) selectAll.checked = false;
    }

    async function loadDbsDone(refresh, append){
      try{
        if (dbsDoneBtn){ dbsDoneBtn.disabled = true; dbsDoneBtn.textContent = 'Загрузка…'; }
        let url = '/api/dbs/orders?limit=1000';
        if (append && dbsDoneNext){ url += `&next=${encodeURIComponent(dbsDoneNext)}`; }
        const r = await fetch(url, { credentials: 'include' });
        const d = await r.json();
        renderDbsDone(d, append);
        if (dbsDoneTime) dbsDoneTime.textContent = new Date().toLocaleString('ru-RU');
      }catch(e){
        console.error(e);
        const tbody = document.querySelector('#dbsDoneTable tbody');
        if (!append && tbody){ tbody.innerHTML = '<tr><td colspan="6" class="text-muted">Ошибка загрузки</td></tr>'; }
      }finally{
        if (dbsDoneBtn){ dbsDoneBtn.disabled = false; dbsDoneBtn.textContent = 'Обновить'; }
      }
    }

    function renderDbsDone(data, append){
      const tbody = document.querySelector('#dbsDoneTable tbody');
      if (!tbody) return;
      if (!append){ tbody.innerHTML = ''; }
      const currentCount = append ? tbody.querySelectorAll('tr').length : 0;
      (data.items || []).forEach((r, idx) => {
        const tr = document.createElement('tr');
        const parts = String(r['Номер и дата заказа']||'').split(' | ');
        const num = parts[0]||''; const dt = parts[1]||'';
        const img = r.photo ? `<img src='${r.photo}' class='product-thumb' style='width:31px;height:42px;object-fit:cover;'>` : '—';
        // map statuses
        let rawStatus = (r.status || '').toLowerCase();
        let statusText = r.statusName || r.status || '';
        if (rawStatus === 'receive') statusText = 'Выкуплен';
        if (rawStatus === 'cancel') statusText = 'Отменен';
        if (rawStatus === 'confirm') statusText = 'На сборке';
        if (rawStatus === 'deliver') statusText = 'В доставке';
        let statusClass = '';
        if (rawStatus === 'receive') statusClass = 'status-badge status-ok';
        else if (rawStatus === 'cancel') statusClass = 'status-badge status-cancel';
        else if (rawStatus === 'confirm') statusClass = 'status-badge status-pending';
        else if (rawStatus === 'deliver') statusClass = 'status-badge status-deliver';
        const statusHtml = statusText ? `<span class="${statusClass}">${statusText}</span>` : '';
        tr.innerHTML = `<td class="text-center">${(currentCount + idx + 1)}</td>
          <td class="text-center">${statusHtml}</td>
          <td><div>${num}</div>${dt?`<div class='text-muted' style='font-size:0.68rem;'>${dt}</div>`:''}</td>
          <td class="text-center">${img}</td>
          <td>${r['Наименование товара']||''}</td>
          <td class="text-center">${r.barcode || '—'}</td>`;
        tbody.appendChild(tr);
      });
      dbsDoneNext = data.next || null;
      if (!append && !(data.items||[]).length){
        tbody.innerHTML = '<tr><td colspan="6" class="text-muted">Нет данных</td></tr>';
      }
      if (dbsDoneMoreBtn){
        if (dbsDoneNext){ dbsDoneMoreBtn.classList.remove('d-none'); } else { dbsDoneMoreBtn.classList.add('d-none'); }
      }
    }

    document.getElementById('selectAllDbs')?.addEventListener('change', function(){
      const checkboxes = document.querySelectorAll('.dbs-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = this.checked;
        if (this.checked){ selectedDbs.add(cb.dataset.orderId); } else { selectedDbs.delete(cb.dataset.orderId); }
      });
      updateDeliverButton();
    });

    document.addEventListener('change', function(e){
      if (e.target.classList && e.target.classList.contains('dbs-checkbox')){
        const id = e.target.dataset.orderId;
        if (e.target.checked){ selectedDbs.add(id); } else { selectedDbs.delete(id); }
        updateDeliverButton();
        updateSelectAllState();
      }
    });

    function updateDeliverButton(){
      const btn = document.getElementById('dbsDeliverBtn');
      const cnt = document.getElementById('selectedDbsCount');
      if (btn && cnt){
        cnt.textContent = selectedDbs.size;
        btn.disabled = selectedDbs.size === 0;
      }
    }

    function updateSelectAllState(){
      const selectAll = document.getElementById('selectAllDbs');
      const boxes = document.querySelectorAll('.dbs-checkbox');
      if (!selectAll || !boxes.length) return;
      const checkedCount = document.querySelectorAll('.dbs-checkbox:checked').length;
      selectAll.checked = checkedCount === boxes.length;
      selectAll.indeterminate = checkedCount > 0 && checkedCount < boxes.length;
    }

    async function deliverSelected(){
      if (selectedDbs.size === 0) return;
      const btn = document.getElementById('dbsDeliverBtn');
      try{
        if (btn){ btn.disabled = true; btn.textContent = 'Отправка…'; }
        let ok = 0, err = 0;
        for (const id of selectedDbs){
          try{
            const r = await fetch(`/api/dbs/orders/${encodeURIComponent(id)}/deliver`, { method: 'PATCH', credentials: 'include' });
            if (r.ok){ ok++; } else { err++; }
          }catch(ex){ err++; }
        }
        // Refresh list
        await loadDbsOrders(true);
        alert(`Передано в доставку: ${ok}${err?`, ошибок: ${err}`:''}`);
      }finally{
        if (btn){ btn.disabled = selectedDbs.size===0; btn.textContent = `Передать в доставку (<span id="selectedDbsCount">${selectedDbs.size}</span>)`; }
      }
    }
  </script>

  {% include '_footer.html' %}
</body>
</html>


