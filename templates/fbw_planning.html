<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤–∫–∏ ‚Äî FuckBerry</title>
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    h1 { font-size: 1.7rem; }
    .form-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .form-section h5 {
      color: #495057;
      margin-bottom: 15px;
      font-weight: 600;
    }
    button.calendar-day {
    border: none;
    }
    .btn-calculate {
      background: linear-gradient(135deg, #007bff, #0056b3);
      border: none;
      height: 37px;
      padding: 0;
      width: 50%;
      font-weight: 400;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    .btn-calculate:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    .result-section {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    .result-section.show {
      display: block;
    }
    .table-responsive {
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .table th {
      font-weight: 600;
      border-bottom: 2px solid #dee2e6;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    .editable-cell {
      border: 1px solid #ced4da;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    .editable-cell:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .editable-cell:hover {
      border-color: #86b7fe;
    }
    .table th {
      font-size: 0.9rem;
      white-space: nowrap;
    }
    .table td {
      vertical-align: middle;
    }
    .text-end {
      text-align: right !important;
    }
    .warehouse-search-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
    }
    .warehouse-search-item:hover {
      background-color: #f8f9fa;
    }
    .warehouse-search-item:last-child {
      border-bottom: none;
    }
    .warehouse-name {
      font-weight: 500;
      color: #333;
    }
    .warehouse-details {
      font-size: 0.85em;
      color: #666;
      margin-top: 2px;
    }
    .warehouse-sorting-center {
      background-color: #e3f2fd;
      border-left: 3px solid #2196f3;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
    .planning-table {
      font-size: 13px;
    }
    
    .table-container {
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      position: relative;
    }
    
    .totals-row {
      background-color: #e3f2fd !important;
      font-weight: bold;
      border-top: 2px solid #2196f3;
    }
    
    .totals-row td {
      border-top: 2px solid #2196f3;
    }
    
    
    .planning-table th {
      text-align: center;
      vertical-align: middle;
      white-space: nowrap;
      padding: 8px 4px;
      position: sticky;
      top: 0;
      z-index: 100;
      background-color: #212529;
      border-bottom: 2px solid #dee2e6;
    }
    
    .planning-table .totals-row th {
      position: sticky;
      top: 61px; /* –í—ã—Å–æ—Ç–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ —à–∞–ø–∫–∏ */
      z-index: 99;
      background-color: #e3f2fd !important;
      border-top: 2px solid #2196f3;
      border-bottom: 2px solid #2196f3;
      font-weight: bold;
      text-align: center;
      vertical-align: middle;
      white-space: nowrap;
      padding: 8px 4px;
    }
    
    /* –£–±–∏—Ä–∞–µ–º –ø–æ–ª–æ—Å—ã –¥–ª—è —Å—Ç—Ä–æ–∫–∏ –∏—Ç–æ–≥–æ–≤ */
    .planning-table .totals-row {
      background-color: #e3f2fd !important;
    }
    
    .planning-table .totals-row:nth-child(odd) {
      background-color: #e3f2fd !important;
    }
    
    .planning-table .totals-row:nth-child(even) {
      background-color: #e3f2fd !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
    .calendar-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      z-index: 1050;
      margin-top: 0.25rem;
      width: 320px;
      max-width: 90vw;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #dee2e6;
      background-color: #f8f9fa;
    }
    
    .calendar-nav {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      transition: background-color 0.15s ease-in-out;
    }
    
    .calendar-nav:hover {
      background-color: #e9ecef;
    }
    
    .calendar-grid {
      padding: 1rem;
    }
    
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.25rem;
      margin-bottom: 0.5rem;
    }
    
    .calendar-weekday {
      text-align: center;
      font-weight: 600;
      font-size: 0.875rem;
      color: #6c757d;
      padding: 0.5rem 0;
    }
    
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.25rem;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      transition: all 0.15s ease-in-out;
      position: relative;
    }
    
    .calendar-day:hover {
      background-color: #e9ecef;
    }
    
    .calendar-day.other-month {
      color: #adb5bd;
    }
    
    .calendar-day.today {
      background-color: #fff3cd;
      color: #856404;
      font-weight: 600;
    }
    
    .calendar-day.selected-start {
      background-color: #0d6efd;
      color: white;
      font-weight: 600;
    }
    
    .calendar-day.selected-end {
      background-color: #0d6efd;
      color: white;
      font-weight: 600;
    }
    
    .calendar-day.in-range {
      background-color: #e7f1ff;
      color: #0d6efd;
    }
    
    .calendar-day.in-range:not(.selected-start):not(.selected-end) {
      border-radius: 0;
    }
    
    .calendar-day.selected-start.in-range {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }
    
    .calendar-day.selected-end.in-range {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }
    
    .calendar-footer {
      display: flex;
      justify-content: space-between;
      padding: 1rem;
      border-top: 1px solid #dee2e6;
      background-color: #f8f9fa;
    }
    
    .calendar-day.weekend {
      color: #dc3545;
    }
    
    .calendar-day.other-month.weekend {
      color: #f5c6cb;
    }
    
    /* –ú–æ–±–∏–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
    @media (max-width: 768px) {
      .calendar-dropdown.mobile-centered {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: 90vw !important;
        max-width: 400px !important;
        z-index: 1060 !important;
        margin: 0 !important;
        box-shadow: 0 0.5rem 2rem rgba(0, 0, 0, 0.3) !important;
      }
      
      .calendar-dropdown.mobile-centered .calendar-grid {
        max-height: 60vh;
        overflow-y: auto;
      }
    }
    
    .planning-table td {
      vertical-align: middle;
      padding: 6px 4px;
    }
    
    .planning-table .product-name {
      white-space: nowrap;
      overflow: visible;
      text-overflow: unset;
    }
    
    .planning-table .numeric-column {
      text-align: center;
      width: 80px;
    }
    
    .planning-table .barcode-column {
      width: 120px;
      max-width: 120px;
    }
    
    .planning-table .photo-column {
      width: 80px;
      max-width: 80px;
      text-align: center;
    }
    
    .planning-table .product-name-column {
      width: 400px;
      min-width: 400px;
      max-width: none;
    }
    
    .planning-table .editable-cell {
      text-align: center;
      width: 80px;
    }
    
    .planning-table .editable-cell input {
      width: 100%;
      text-align: center;
      border: 1px solid #ddd;
      padding: 2px 4px;
      font-size: 13px;
    }
    
    .planning-table .editable-cell input.highlighted {
      background-color: #5ec34a73 !important;
    }
    
    /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
    .planning-table th,
    .planning-table td {
      border-right: 1px solid #dee2e6;
    }
    
    .planning-table th:last-child,
    .planning-table td:last-child {
      border-right: none;
    }
    
    .planning-table {
      border-collapse: separate;
      border-spacing: 0;
    }
    
    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
    .form-text.small {
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }
    
    @media (max-width: 768px) {
      .form-section .row .col-md-2 {
        margin-bottom: 1rem;
      }
      .form-section .row .col-md-4 {
        margin-bottom: 1rem;
      }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ Excel */
    #exportExcelBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    #exportExcelBtn:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
  </style>
</head>
<body>
  {% include '_navbar.html' %}

  <div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="mb-0">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤–∫–∏ FBW</h1>
    </div>

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <div class="form-section">
      <h5>üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h5>
      <form id="planningForm">
        <div class="row">
          <div class="col-md-2 mb-3">
            <label for="warehouse" class="form-label">
              –°–∫–ª–∞–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
              <i class="bi bi-info-circle text-muted ms-1" 
                 data-bs-toggle="tooltip" 
                 data-bs-placement="top" 
                 title="–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥ –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –æ—Ç–≥—Ä—É–∑–∫—É"
                 style="cursor: help;"></i>
            </label>
            <div class="position-relative">
              <input type="text" class="form-control" id="warehouseSearch" placeholder="–ù–∞—á–Ω–∏—Ç–µ –ø–µ—á–∞—Ç–∞—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–∫–ª–∞–¥–∞..." autocomplete="off">
              <select class="form-select" id="warehouse" name="warehouse" style="display: none;">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</option>
              </select>
              <div id="warehouseDropdown" class="dropdown-menu w-100" style="max-height: 300px; overflow-y: auto; display: none;"></div>
            </div>
          </div>
          <div class="col-md-2 mb-3">
            <label for="salesPeriodRange" class="form-label">
              –ü–µ—Ä–∏–æ–¥ –ø—Ä–æ–¥–∞–∂
              <i class="bi bi-info-circle text-muted ms-1" 
                 data-bs-toggle="tooltip" 
                 data-bs-placement="top" 
                 title="–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –ø—Ä–æ–¥–∞–∂ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –º–µ—Å—è—Ü–∞)"
                 style="cursor: help;"></i>
            </label>
            <div class="position-relative" style="position: relative !important;">
              <input type="text" class="form-control" id="salesPeriodRange" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –ø—Ä–æ–¥–∞–∂" readonly style="cursor: pointer;" />
              <input type="hidden" name="salesPeriodFrom" id="salesPeriodFrom" />
              <input type="hidden" name="salesPeriodTo" id="salesPeriodTo" />
              <span class="position-absolute top-50 end-0 translate-middle-y me-3" style="cursor: pointer;" id="salesPeriodBtn">üìÖ</span>
              <div id="salesPeriodCalendar" class="calendar-dropdown" style="display: none;">
                <div class="calendar-header">
                  <button type="button" class="calendar-nav" id="salesPeriodPrevMonth">‚Äπ</button>
                  <span id="salesPeriodCurrentMonthYear">–°–µ–Ω—Ç—è–±—Ä—å 2025</span>
                  <button type="button" class="calendar-nav" id="salesPeriodNextMonth">‚Ä∫</button>
                </div>
                <div class="calendar-grid" id="salesPeriodCalendarGrid">
                  <div class="calendar-weekdays" id="salesPeriodWeekdays">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è JavaScript -->
                  </div>
                  <div class="calendar-days" id="salesPeriodDays">
                    <!-- –î–Ω–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è JavaScript -->
                  </div>
                </div>
                <div class="calendar-footer">
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="salesPeriodResetDates">–°–±—Ä–æ—Å–∏—Ç—å</button>
                  <button type="button" class="btn btn-sm btn-primary" id="salesPeriodApplyDates">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-2 mb-3">
            <label for="planningDays" class="form-label">
              –î–Ω–µ–π –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
              <i class="bi bi-info-circle text-muted ms-1" 
                 data-bs-toggle="tooltip" 
                 data-bs-placement="top" 
                 title="–ö–æ–ª-–≤–æ –¥–Ω–µ–π –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º –æ—Å—Ç–∞—Ç–æ–∫ —Ç–æ–≤–∞—Ä–∞ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º 60 –¥–Ω–µ–π)"
                 style="cursor: help;"></i>
            </label>
            <input type="number" class="form-control" id="planningDays" name="planningDays" 
                   value="30" min="1" max="365" required>
          </div>
          <div class="col-md-2 mb-3">
            <label for="supplyDate" class="form-label">
              –î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏
              <i class="bi bi-info-circle text-muted ms-1" 
                 data-bs-toggle="tooltip" 
                 data-bs-placement="top" 
                 title="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é –¥–∞—Ç—É –ø–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥, –æ–Ω–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–Ω–µ–π –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"
                 style="cursor: help;"></i>
            </label>
            <input type="date" class="form-control" id="supplyDate" name="supplyDate" required>
          </div>
          <div class="col-md-3 mb-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary btn-calculate w-100">
              <i class="bi bi-calculator me-2"></i>
              –ü–æ—Å—á–∏—Ç–∞—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å
            </button>
          </div>
        </div>
      </form>
    </div>

    <div class="result-section" id="resultSection">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0" data-bs-toggle="tooltip" data-bs-placement="top" 
            title="<strong>–§–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–∞:</strong><br>
‚Ä¢ <strong>–ü—Ä–æ–¥–∞–∂ –≤ –¥–µ–Ω—å</strong> = –ó–∞–∫–∞–∑–∞–Ω–æ –∑–∞ –ø–µ—Ä–∏–æ–¥ √∑ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø–µ—Ä–∏–æ–¥–∞<br>
‚Ä¢ <strong>–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π –æ—Å—Ç–∞—Ç–æ–∫</strong> = –ü—Ä–æ–¥–∞–∂ –≤ –¥–µ–Ω—å √ó (–î–Ω–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è + –î–Ω–∏ –¥–æ –ø–æ—Å—Ç–∞–≤–∫–∏)<br>
‚Ä¢ <strong>–û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å</strong> = –¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ √∑ –ü—Ä–æ–¥–∞–∂ –≤ –¥–µ–Ω—å<br>
‚Ä¢ <strong>–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥</strong> = –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π –æ—Å—Ç–∞—Ç–æ–∫ - –¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ - –í –ø—É—Ç–∏ –Ω–∞ —Å–∫–ª–∞–¥">
          üìà –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        </h5>
        <div class="d-flex align-items-center gap-3">
          <div id="productsCount" class="text-muted small" style="display: none;">
            <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –∑–¥–µ—Å—å -->
          </div>
          <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="tableSettingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–±–ª–∏—Ü—ã">
              <i class="bi bi-gear"></i>
            </button>
            <button type="button" class="btn btn-success btn-sm" id="exportExcelBtn" disabled>
              <i class="bi bi-file-earmark-excel me-1"></i>
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Excel
            </button>
          </div>
        </div>
      </div>
      <div class="loading" id="loadingDiv">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <div class="mt-2" id="loadingText">–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</div>
      </div>
      
      <div id="resultsContent" style="display: none;">
        <div class="table-container">
          <table id="resultsTable" class="table table-striped table-hover planning-table">
            <thead class="table-dark">
              <tr>
                <th class="numeric-column" style="width: 50px;">‚Ññ</th>
                <th class="barcode-column">–ë–∞—Ä–∫–æ–¥</th>
                <th class="photo-column" style="width: 80px;">–§–æ—Ç–æ</th>
                <th class="product-name-column">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                <th class="numeric-column">
                  –¢–µ–∫—É—â–∏–π<br>–æ—Å—Ç–∞—Ç–æ–∫
                  <button type="button" class="btn btn-sm btn-outline-light ms-1 sort-btn" data-column="currentStock" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <i class="bi bi-arrow-down-up"></i>
                  </button>
                </th>
                <th class="numeric-column">
                  –û—Å—Ç–∞—Ç–æ–∫ –ø–æ<br>–≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º
                  <button type="button" class="btn btn-sm btn-outline-light ms-1 sort-btn" data-column="allStocks" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <i class="bi bi-arrow-down-up"></i>
                  </button>
                </th>
                <th class="numeric-column">
                  –í –ø—É—Ç–∏<br>–Ω–∞ —Å–∫–ª–∞–¥
                  <button type="button" class="btn btn-sm btn-outline-light ms-1 sort-btn" data-column="inTransit" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <i class="bi bi-arrow-down-up"></i>
                  </button>
                </th>
                <th class="numeric-column">
                  –ó–∞–∫–∞–∑–∞–Ω–æ<br>–∑–∞ –ø–µ—Ä–∏–æ–¥
                  <button type="button" class="btn btn-sm btn-outline-light ms-1 sort-btn" data-column="orderedInPeriod" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <i class="bi bi-arrow-down-up"></i>
                  </button>
                </th>
                <th class="numeric-column">
                  –ü—Ä–æ–¥–∞–∂<br>–≤ –¥–µ–Ω—å
                  <button type="button" class="btn btn-sm btn-outline-light ms-1 sort-btn" data-column="salesPerDay" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <i class="bi bi-arrow-down-up"></i>
                  </button>
                </th>
                <th class="numeric-column">
                  –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π<br>–æ—Å—Ç–∞—Ç–æ–∫
                  <button type="button" class="btn btn-sm btn-outline-light ms-1 sort-btn" data-column="requiredStock" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <i class="bi bi-arrow-down-up"></i>
                  </button>
                </th>
                <th class="numeric-column">
                  –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å
                  <button type="button" class="btn btn-sm btn-outline-light ms-1 sort-btn" data-column="turnover" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <i class="bi bi-arrow-down-up"></i>
                  </button>
                </th>
                <th class="numeric-column">
                  –ü–æ—Å—Ç–∞–≤–∏—Ç—å<br>–Ω–∞ —Å–∫–ª–∞–¥
                  <button type="button" class="btn btn-sm btn-outline-light ms-1 sort-btn" data-column="toSupply" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <i class="bi bi-arrow-down-up"></i>
                  </button>
                </th>
              </tr>
              <!-- –°—Ç—Ä–æ–∫–∞ —Å –∏—Ç–æ–≥–∞–º–∏ —Å—Ä–∞–∑—É –ø–æ–¥ —à–∞–ø–∫–æ–π -->
              <tr class="table-info totals-row">
                <th class="numeric-column"></th>
                <th class="barcode-column"><strong>–ò–¢–û–ì–û:</strong></th>
                <th class="photo-column"></th>
                <th class="product-name-column"></th>
                <th class="numeric-column" id="totalCurrentStock"><strong>0</strong></th>
                <th class="numeric-column" id="totalAllStocks"><strong>0</strong></th>
                <th class="numeric-column" id="totalInTransit"><strong>0</strong></th>
                <th class="numeric-column" id="totalOrdered"><strong>0</strong></th>
                <th class="numeric-column"></th>
                <th class="numeric-column"></th>
                <th class="numeric-column"></th>
                <th class="numeric-column" id="totalToSupply"><strong>0</strong></th>
              </tr>
            </thead>
            <tbody id="resultsTableBody">
              <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ -->
  <div id="imgPreview" style="display:none; position:fixed; left:50%; top:50%; transform: translate(-50%, -50%); z-index:1060; padding:4px; background:#fff; border:1px solid rgba(0,0,0,.15); box-shadow:0 .5rem 1rem rgba(0,0,0,.15); pointer-events: none;">
    <img id="imgPreviewImg" src="" alt="preview" style="max-width:420px; max-height:560px; display:block;" />
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ—Å—Ç–∞–≤–∫–∞—Ö -->
  <div class="modal fade" id="pendingSuppliesModal" tabindex="-1" aria-labelledby="pendingSuppliesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pendingSuppliesModalLabel">
            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
            –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ –ø—Ä–∏–Ω—è—Ç—ã–µ –ø–æ—Å—Ç–∞–≤–∫–∏
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-3">
            –ù–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç –µ—Å—Ç—å –Ω–µ –ø—Ä–∏–Ω—è—Ç—ã–µ –ø–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∫–ª–∞–¥.<br />  
            <strong>–£—á–∏—Ç—ã–≤–∞—Ç—å –∏—Ö –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ—Å—Ç–∞–≤–∫–∏?</strong>
          </p>
          
          <div id="pendingSuppliesList" class="mb-3">
            <!-- –°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–∞–≤–æ–∫ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
          </div>
          
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            –ï—Å–ª–∏ –≤—ã –≤—ã–±–µ—Ä–µ—Ç–µ "–î–∞", —Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –∏–∑ —ç—Ç–∏—Ö –ø–æ—Å—Ç–∞–≤–æ–∫ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–ª–æ–Ω–∫—É "–í –ø—É—Ç–∏ –Ω–∞ —Å–∫–ª–∞–¥".
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="rejectSuppliesBtn">
            <i class="bi bi-x-circle me-1"></i>
            –ù–µ—Ç, –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å
          </button>
          <button type="button" class="btn btn-primary" id="acceptSuppliesBtn">
            <i class="bi bi-check-circle me-1"></i>
            –î–∞, —É—á–∏—Ç—ã–≤–∞—Ç—å
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–∞–±–ª–∏—Ü—ã -->
  <div class="modal fade" id="tableSettingsModal" tabindex="-1" aria-labelledby="tableSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="tableSettingsModalLabel">
            <i class="bi bi-gear me-2"></i>
            –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ:</p>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="colNumber" checked>
                <label class="form-check-label" for="colNumber">
                  ‚Ññ
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="colBarcode" checked>
                <label class="form-check-label" for="colBarcode">
                  –ë–∞—Ä–∫–æ–¥
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="colPhoto" checked>
                <label class="form-check-label" for="colPhoto">
                  –§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="colName" checked>
                <label class="form-check-label" for="colName">
                  –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="colCurrentStock" checked>
                <label class="form-check-label" for="colCurrentStock">
                  –¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="colAllStocks" checked>
                <label class="form-check-label" for="colAllStocks">
                  –û—Å—Ç–∞—Ç–æ–∫ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º
                </label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="colInTransit" checked>
                <label class="form-check-label" for="colInTransit">
                  –í –ø—É—Ç–∏ –Ω–∞ —Å–∫–ª–∞–¥
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="colOrdered" checked>
                <label class="form-check-label" for="colOrdered">
                  –ó–∞–∫–∞–∑–∞–Ω–æ –∑–∞ –ø–µ—Ä–∏–æ–¥
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="colSalesPerDay" checked>
                <label class="form-check-label" for="colSalesPerDay">
                  –ü—Ä–æ–¥–∞–∂ –≤ –¥–µ–Ω—å
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="colRequiredStock" checked>
                <label class="form-check-label" for="colRequiredStock">
                  –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π –æ—Å—Ç–∞—Ç–æ–∫
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="colTurnover" checked>
                <label class="form-check-label" for="colTurnover">
                  –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="colToSupply" checked>
                <label class="form-check-label" for="colToSupply">
                  –ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥
                </label>
              </div>
            </div>
          </div>
          
          <div class="mt-3">
            <button type="button" class="btn btn-outline-primary btn-sm" id="selectAllColumns">
              <i class="bi bi-check-square me-1"></i>
              –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="deselectAllColumns">
              <i class="bi bi-square me-1"></i>
              –°–Ω—è—Ç—å –≤—Å–µ
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i>
            –û—Ç–º–µ–Ω–∞
          </button>
          <button type="button" class="btn btn-primary" id="applyTableSettings">
            <i class="bi bi-check-circle me-1"></i>
            –ü—Ä–∏–º–µ–Ω–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allWarehouses = [];
    let filteredWarehouses = [];
    let currentProducts = []; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü—ã
    let sortDirection = 'desc'; // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏: 'asc' –∏–ª–∏ 'desc'
    let pendingSupplies = []; // –ù–µ–ø—Ä–∏–Ω—è—Ç—ã–µ –ø–æ—Å—Ç–∞–≤–∫–∏
    let pendingSuppliesModal = null; // –°—Å—ã–ª–∫–∞ –Ω–∞ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    
    // –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å –≤—ã–±–æ—Ä–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞ –ø—Ä–æ–¥–∞–∂
    class SalesPeriodCalendar {
      constructor() {
        this.currentDate = new Date();
        this.selectedStart = null;
        this.selectedEnd = null;
        this.isSelecting = false;
        this.calendar = document.getElementById('salesPeriodCalendar');
        this.input = document.getElementById('salesPeriodRange');
        this.startInput = document.getElementById('salesPeriodFrom');
        this.endInput = document.getElementById('salesPeriodTo');
        this.btn = document.getElementById('salesPeriodBtn');
        this.grid = document.getElementById('salesPeriodCalendarGrid');
        this.weekdays = document.getElementById('salesPeriodWeekdays');
        this.days = document.getElementById('salesPeriodDays');
        this.monthYear = document.getElementById('salesPeriodCurrentMonthYear');
        this.prevBtn = document.getElementById('salesPeriodPrevMonth');
        this.nextBtn = document.getElementById('salesPeriodNextMonth');
        this.resetBtn = document.getElementById('salesPeriodResetDates');
        this.applyBtn = document.getElementById('salesPeriodApplyDates');
        
        this.months = [
          '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
          '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
        ];
        
        this.weekdayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
        
        this.init();
      }
      
      init() {
        if (!this.calendar || !this.input || !this.btn) {
          return;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞—Ç—ã
        this.loadSavedDates();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        this.btn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleCalendar();
        });
        this.input.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleCalendar();
        });
        this.prevBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.prevMonth();
        });
        this.nextBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.nextMonth();
        });
        this.resetBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.resetSelection();
        });
        this.applyBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.applySelection();
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
          if (!this.calendar.contains(e.target) && 
              !this.input.contains(e.target) && 
              !this.btn.contains(e.target)) {
            this.hideCalendar();
          }
        });
        
        // –ü–µ—Ä–µ–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
          if (this.calendar.style.display === 'block') {
            this.adjustPosition();
          }
        });
        
        this.renderCalendar();
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ
        this.calendar.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }
      
      loadSavedDates() {
        const startValue = this.startInput?.value || '';
        const endValue = this.endInput?.value || '';
        
        if (startValue && endValue) {
          this.selectedStart = new Date(startValue);
          this.selectedEnd = new Date(endValue);
          this.updateInputDisplay();
        } else {
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          const today = new Date();
          const thirtyDaysAgo = new Date(today);
          thirtyDaysAgo.setDate(today.getDate() - 30);
          
          this.selectedStart = thirtyDaysAgo;
          this.selectedEnd = today;
          this.updateInputDisplay();
          this.updateHiddenInputs();
        }
      }
      
      toggleCalendar() {
        if (this.calendar.style.display === 'block') {
          this.hideCalendar();
        } else {
          this.showCalendar();
        }
      }
      
      showCalendar() {
        this.calendar.style.display = 'block';
        this.adjustPosition();
        this.renderCalendar();
      }
      
      hideCalendar() {
        this.calendar.style.display = 'none';
      }
      
      adjustPosition() {
        const rect = this.input.getBoundingClientRect();
        const calendar = this.calendar;
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å–ø—Ä–∞–≤–∞
        const spaceRight = viewportWidth - rect.right;
        const spaceLeft = rect.left;
        const spaceBelow = viewportHeight - rect.bottom;
        
        if (spaceRight >= 320) {
          calendar.style.left = '0';
          calendar.style.right = 'auto';
        } else if (spaceLeft >= 320) {
          calendar.style.left = 'auto';
          calendar.style.right = '0';
        } else {
          // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
          calendar.classList.add('mobile-centered');
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        if (spaceBelow < 400 && rect.top > 400) {
          calendar.style.top = 'auto';
          calendar.style.bottom = '100%';
          calendar.style.marginTop = '0';
          calendar.style.marginBottom = '0.25rem';
        } else {
          calendar.style.top = '100%';
          calendar.style.bottom = 'auto';
          calendar.style.marginTop = '0.25rem';
          calendar.style.marginBottom = '0';
        }
      }
      
      prevMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
        this.renderCalendar();
      }
      
      nextMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
        this.renderCalendar();
      }
      
      renderCalendar() {
        if (!this.weekdays || !this.days || !this.monthYear) return;
        
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        
        this.monthYear.textContent = `${this.months[month]} ${year}`;
        
        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
        this.weekdays.innerHTML = '';
        this.days.innerHTML = '';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
        this.weekdayNames.forEach(day => {
          const dayHeader = document.createElement('div');
          dayHeader.className = 'calendar-weekday';
          dayHeader.textContent = day;
          this.weekdays.appendChild(dayHeader);
        });
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        // –ù–∞—Ö–æ–¥–∏–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è (0 = –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1 = –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, ...)
        let startDay = firstDay.getDay();
        if (startDay === 0) startDay = 7; // –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ = 7
        
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const prevMonth = new Date(year, month - 1, 0);
        const daysInPrevMonth = prevMonth.getDate();
        
        for (let i = startDay - 1; i > 0; i--) {
          const day = daysInPrevMonth - i + 1;
          const dayElement = this.createDayElement(day, true);
          this.days.appendChild(dayElement);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        for (let day = 1; day <= daysInMonth; day++) {
          const dayElement = this.createDayElement(day, false);
          this.days.appendChild(dayElement);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ—Ç–∫–∏
        const totalCells = this.days.children.length;
        const remainingCells = 42 - totalCells; // 6 –Ω–µ–¥–µ–ª—å * 7 –¥–Ω–µ–π
        
        for (let day = 1; day <= remainingCells; day++) {
          const dayElement = this.createDayElement(day, true);
          this.days.appendChild(dayElement);
        }
      }
      
      createDayElement(day, isOtherMonth) {
        const dayElement = document.createElement('button');
        dayElement.className = 'calendar-day';
        dayElement.textContent = day;
        
        if (isOtherMonth) {
          dayElement.classList.add('other-month');
        } else {
          const currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), day);
          this.updateDayClasses(dayElement, currentDate);
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–µ–Ω—å –≤—ã—Ö–æ–¥–Ω—ã–º
          const dayOfWeek = currentDate.getDay();
          if (dayOfWeek === 0 || dayOfWeek === 6) {
            dayElement.classList.add('weekend');
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–µ–Ω—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º
          const today = new Date();
          if (currentDate.toDateString() === today.toDateString()) {
            dayElement.classList.add('today');
          }
          
          dayElement.addEventListener('click', () => {
            this.selectDate(currentDate);
          });
        }
        
        return dayElement;
      }
      
      updateDayClasses(dayElement, date) {
        // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã –≤—ã–±–æ—Ä–∞
        dayElement.classList.remove('selected-start', 'selected-end', 'in-range');
        
        if (!this.selectedStart && !this.selectedEnd) return;
        
        const time = date.getTime();
        const startTime = this.selectedStart ? this.selectedStart.getTime() : null;
        const endTime = this.selectedEnd ? this.selectedEnd.getTime() : null;
        
        if (startTime && endTime) {
          // –ü–æ–ª–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –≤—ã–±—Ä–∞–Ω
          if (time === startTime) {
            dayElement.classList.add('selected-start');
          } else if (time === endTime) {
            dayElement.classList.add('selected-end');
          } else if (time > startTime && time < endTime) {
            dayElement.classList.add('in-range');
          }
        } else if (startTime && time === startTime) {
          // –¢–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ –≤—ã–±—Ä–∞–Ω–æ
          dayElement.classList.add('selected-start');
        }
      }
      
      selectDate(date) {
        if (!this.selectedStart || (this.selectedStart && this.selectedEnd)) {
          // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π –≤—ã–±–æ—Ä
          this.selectedStart = new Date(date);
          this.selectedEnd = null;
          this.isSelecting = true;
        } else if (this.isSelecting) {
          // –ó–∞–≤–µ—Ä—à–∞–µ–º –≤—ã–±–æ—Ä
          if (date < this.selectedStart) {
            this.selectedEnd = this.selectedStart;
            this.selectedStart = new Date(date);
          } else {
            this.selectedEnd = new Date(date);
          }
          this.isSelecting = false;
        }
        
        this.updateInputDisplay();
        this.updateHiddenInputs();
        this.renderCalendar();
      }
      
      updateInputDisplay() {
        if (!this.input) return;
        
        if (this.selectedStart && this.selectedEnd) {
          const startStr = this.formatDate(this.selectedStart);
          const endStr = this.formatDate(this.selectedEnd);
          this.input.value = `${startStr} ‚Äî ${endStr}`;
        } else if (this.selectedStart) {
          this.input.value = this.formatDate(this.selectedStart);
        } else {
          this.input.value = '';
        }
      }
      
      updateHiddenInputs() {
        if (this.startInput && this.selectedStart) {
          this.startInput.value = this.formatDateForInput(this.selectedStart);
        }
        if (this.endInput && this.selectedEnd) {
          this.endInput.value = this.formatDateForInput(this.selectedEnd);
        }
      }
      
      formatDate(date) {
        return date.toLocaleDateString('ru-RU');
      }
      
      formatDateForInput(date) {
        return date.toISOString().split('T')[0];
      }
      
      resetSelection() {
        this.selectedStart = null;
        this.selectedEnd = null;
        this.isSelecting = false;
        this.updateInputDisplay();
        this.updateHiddenInputs();
        this.renderCalendar();
      }
      
      applySelection() {
        this.hideCalendar();
        this.validateDates();
      }
      
      validateDates() {
        const df = this.startInput?.value || '';
        const dt = this.endInput?.value || '';
        
        let ok = true; 
        let msg = '';
        
        if (df && dt && df > dt) {
          ok = false; 
          msg = '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è';
        }
        if (!df || !dt) {
          ok = false; 
          msg = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –ø—Ä–æ–¥–∞–∂';
        }
        
        return ok;
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç—É–ª—Ç–∏–ø—ã Bootstrap
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
          html: true
        });
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ Excel
      document.getElementById('exportExcelBtn').addEventListener('click', function() {
        exportToExcel();
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      const preview = document.getElementById('imgPreview');
      const previewImg = document.getElementById('imgPreviewImg');
      
      document.addEventListener('mouseover', function(e){
        const t = e.target;
        if (t && t.classList && t.classList.contains('product-thumb')){
          const src = t.getAttribute('data-src') || t.getAttribute('src');
          previewImg.src = src;
          preview.style.display = 'block';
        }
      });
      
      document.addEventListener('mouseout', function(e){
        const t = e.target;
        if (t && t.classList && t.classList.contains('product-thumb')){
          preview.style.display = 'none';
          previewImg.src = '';
        }
      });
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      loadWarehouses();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø–µ—Ä–∏–æ–¥–∞ –ø—Ä–æ–¥–∞–∂
      new SalesPeriodCalendar();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      pendingSuppliesModal = new bootstrap.Modal(document.getElementById('pendingSuppliesModal'));
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      document.getElementById('acceptSuppliesBtn').addEventListener('click', function() {
        acceptPendingSupplies();
        pendingSuppliesModal.hide();
      });
      
      document.getElementById('rejectSuppliesBtn').addEventListener('click', function() {
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª –ø–æ—Å—Ç–∞–≤–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–∑ –Ω–∏—Ö');
        pendingSuppliesModal.hide();
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –ø–æ—Å—Ç–∞–≤–æ–∫
        showResultsWithProducts(currentProducts, window.lastFormData);
      });
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–∞–±–ª–∏—Ü—ã
      const tableSettingsModal = new bootstrap.Modal(document.getElementById('tableSettingsModal'));
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–∞–±–ª–∏—Ü—ã
      document.getElementById('tableSettingsBtn').addEventListener('click', function() {
        tableSettingsModal.show();
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –∫–æ–ª–æ–Ω–æ–∫
      document.getElementById('selectAllColumns').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('#tableSettingsModal input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = true;
        });
      });
      
      document.getElementById('deselectAllColumns').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('#tableSettingsModal input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = false;
        });
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–∞–±–ª–∏—Ü—ã
      document.getElementById('applyTableSettings').addEventListener('click', function() {
        console.log('–ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" –Ω–∞–∂–∞—Ç–∞');
        applyTableColumnSettings();
        
        // –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        this.blur();
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        tableSettingsModal.hide();
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û—Ç–º–µ–Ω–∞"
      document.querySelector('#tableSettingsModal .btn-secondary').addEventListener('click', function() {
        console.log('–ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∞" –Ω–∞–∂–∞—Ç–∞');
        this.blur();
      });
      
      // –î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π
      const today = new Date();
      const supplyDate = new Date(today);
      supplyDate.setDate(today.getDate() + 7);
      document.getElementById('supplyDate').value = supplyDate.toISOString().split('T')[0];
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
      document.getElementById('planningForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞ –∏–∑ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞
        data.warehouse_name = document.getElementById('warehouseSearch').value;
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è - –∏—â–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∫–ª–∞–¥ –≤ –¥–∞–Ω–Ω—ã—Ö
        const warehouseName = document.getElementById('warehouseSearch').value;
        let selectedWarehouse = null;
        
        // –ò—â–µ–º —Å–∫–ª–∞–¥ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if (warehouseName && allWarehouses.length > 0) {
          selectedWarehouse = allWarehouses.find(warehouse => 
            warehouse.name === warehouseName
          );
        }
        
        console.log(`–í–∞–ª–∏–¥–∞—Ü–∏—è: warehouseName="${warehouseName}", selectedWarehouse:`, selectedWarehouse);
        
        if (!selectedWarehouse || !warehouseName) {
          if (warehouseName && !selectedWarehouse) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥ –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞, –∞ –Ω–µ –≤–≤–æ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é');
          } else {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥ –∏–∑ —Å–ø–∏—Å–∫–∞');
          }
          document.getElementById('warehouseSearch').focus();
          document.getElementById('warehouseSearch').style.borderColor = '#dc3545';
          return;
        } else {
          document.getElementById('warehouseSearch').style.borderColor = '';
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–π select —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º ID
        const hiddenSelect = document.getElementById('warehouse');
        
        // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏
        hiddenSelect.innerHTML = '';
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –æ–ø—Ü–∏—é —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Å–∫–ª–∞–¥–æ–º
        const option = document.createElement('option');
        option.value = selectedWarehouse.id;
        option.textContent = selectedWarehouse.name;
        option.selected = true;
        hiddenSelect.appendChild(option);
        
        console.log(`–û–±–Ω–æ–≤–ª–µ–Ω —Å–∫—Ä—ã—Ç—ã–π select: ${selectedWarehouse.id}`);
        console.log(`–°–∫—Ä—ã—Ç—ã–π select value –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${hiddenSelect.value}`);
        }
        if (!data.salesPeriodFrom || !data.salesPeriodTo || !data.planningDays || !data.supplyDate) {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
          return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç
        const fromDate = new Date(data.salesPeriodFrom);
        const toDate = new Date(data.salesPeriodTo);
        if (fromDate >= toDate) {
          alert('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è');
          return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        showResults();
        calculatePlanning(data);
      });
    });
    
    function showResults() {
      document.getElementById('resultSection').classList.add('show');
      document.getElementById('loadingDiv').style.display = 'block';
      document.getElementById('resultsContent').style.display = 'none';
    }
    
    function calculatePlanning(data) {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      loadUserProducts(data);
    }
    
    function loadUserProducts(formData) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏
      document.getElementById('loadingText').textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...';
      
      // –ü–æ–ª—É—á–∞–µ–º ID —Å–∫–ª–∞–¥–∞ –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ select
      const warehouseId = document.getElementById('warehouse').value;
      console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –¥–ª—è —Å–∫–ª–∞–¥–∞ ID: ${warehouseId}`);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã, –æ—Å—Ç–∞—Ç–∫–∏ –∏ –∑–∞–∫–∞–∑—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
      const dateFrom = formData.salesPeriodFrom;
      const dateTo = formData.salesPeriodTo;
      
      console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞: ${dateFrom} - ${dateTo}`);
      
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ YYYY-MM-DD –≤ DD.MM.YYYY –¥–ª—è API
      function convertDateFormat(dateStr) {
        if (!dateStr) return dateStr;
        const parts = dateStr.split('-');
        if (parts.length === 3) {
          return `${parts[2]}.${parts[1]}.${parts[0]}`;
        }
        return dateStr;
      }
      
      const dateFromFormatted = convertDateFormat(dateFrom);
      const dateToFormatted = convertDateFormat(dateTo);
      
      console.log(`–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã: ${dateFromFormatted} - ${dateToFormatted}`);
      
      Promise.all([
        fetch('/api/fbw/planning/products'),
        fetch(`/api/fbw/planning/stocks?warehouse_id=${warehouseId}`),
        fetch('/api/fbw/planning/stocks?warehouse_id=all'), // –û—Å—Ç–∞—Ç–∫–∏ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º
        fetch(`/api/fbw/planning/orders?warehouse_id=${warehouseId}&date_from=${dateFromFormatted}&date_to=${dateToFormatted}`)
      ])
      .then(responses => Promise.all(responses.map(r => r.json())))
      .then(([productsData, stocksData, allStocksData, ordersData]) => {
        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏:', {productsData, stocksData, allStocksData, ordersData});
        
        if (productsData.success && stocksData.success) {
          // –ï—Å–ª–∏ –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
          if (!allStocksData.success) {
            console.warn('–û—Å—Ç–∞—Ç–∫–∏ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ:', allStocksData);
            allStocksData = {
              success: true,
              stocks: {},
              total_stocks: 0,
              unique_products: 0
            };
          }
          
          // –ï—Å–ª–∏ –∑–∞–∫–∞–∑—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
          if (!ordersData.success) {
            console.warn('–ó–∞–∫–∞–∑—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ:', ordersData);
            ordersData = {
              success: true,
              orders: {},
              total_orders: 0,
              unique_products: 0,
              warehouse_name: stocksData.warehouse_name,
              date_from: dateFrom,
              date_to: dateTo
            };
          }
          console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${productsData.count} —Ç–æ–≤–∞—Ä–æ–≤ —Å –±–∞—Ä–∫–æ–¥–∞–º–∏`);
          console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –æ—Å—Ç–∞—Ç–∫–æ–≤ –¥–ª—è —Å–∫–ª–∞–¥–∞ ${stocksData.warehouse_id} (${stocksData.warehouse_name}):`, Object.keys(stocksData.stocks).length);
          console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º:`, Object.keys(allStocksData.stocks).length);
          console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è —Å–∫–ª–∞–¥–∞ ${ordersData.warehouse_name} –∑–∞ –ø–µ—Ä–∏–æ–¥ ${ordersData.date_from} - ${ordersData.date_to}:`, ordersData.total_orders);
          console.log('–û—Å—Ç–∞—Ç–∫–∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å–∫–ª–∞–¥—É:', stocksData.stocks);
          console.log('–û—Å—Ç–∞—Ç–∫–∏ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º:', allStocksData.stocks);
          console.log('–ó–∞–∫–∞–∑—ã:', ordersData.orders);
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤
          if (stocksData.updated_at) {
            console.log(`–û—Å—Ç–∞—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${stocksData.updated_at}`);
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            window.stocksUpdatedAt = stocksData.updated_at;
          }
          
          // –û—Ç–ª–∞–¥–∫–∞ —Ñ–æ—Ç–æ
          const productsWithPhotos = productsData.products.filter(p => p.photo);
          console.log(`–¢–æ–≤–∞—Ä–æ–≤ —Å —Ñ–æ—Ç–æ: ${productsWithPhotos.length}`);
          if (productsWithPhotos.length > 0) {
            console.log('–ü—Ä–∏–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ñ–æ—Ç–æ:', productsWithPhotos.slice(0, 3).map(p => ({barcode: p.barcode, photo: p.photo})));
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤
          console.log('–ü–µ—Ä–≤—ã–µ 3 —Ç–æ–≤–∞—Ä–∞ –∏–∑ API:', productsData.products.slice(0, 3).map(p => ({
            barcode: p.barcode, 
            name: p.name, 
            photo: p.photo,
            hasPhoto: !!p.photo
          })));
          
          // –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –æ—Å—Ç–∞—Ç–∫–∏ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤
          const productsWithStock = productsData.products.filter(p => stocksData.stocks[p.barcode] > 0);
          console.log(`–¢–æ–≤–∞—Ä–æ–≤ —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏: ${productsWithStock.length}`);
          if (productsWithStock.length > 0) {
            console.log('–ü—Ä–∏–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤ —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏:', productsWithStock.slice(0, 3));
          }
          
          // –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –∑–∞–∫–∞–∑—ã –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤
          const productsWithOrders = productsData.products.filter(p => ordersData.orders[p.barcode] > 0);
          console.log(`–¢–æ–≤–∞—Ä–æ–≤ —Å –∑–∞–∫–∞–∑–∞–º–∏: ${productsWithOrders.length}`);
          if (productsWithOrders.length > 0) {
            console.log('–ü—Ä–∏–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤ —Å –∑–∞–∫–∞–∑–∞–º–∏:', productsWithOrders.slice(0, 3));
          }
          
          // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –±–∞—Ä–∫–æ–¥–æ–≤
          console.log('–ü—Ä–∏–º–µ—Ä—ã –±–∞—Ä–∫–æ–¥–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤:', productsData.products.slice(0, 5).map(p => p.barcode));
          console.log('–ü—Ä–∏–º–µ—Ä—ã –±–∞—Ä–∫–æ–¥–æ–≤ –∑–∞–∫–∞–∑–æ–≤:', Object.keys(ordersData.orders).slice(0, 5));
          
          // –ü—Ä–æ–≤–µ—Ä–∏–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –±–∞—Ä–∫–æ–¥–æ–≤
          const productBarcodes = new Set(productsData.products.map(p => p.barcode));
          const orderBarcodes = new Set(Object.keys(ordersData.orders));
          const commonBarcodes = [...productBarcodes].filter(barcode => orderBarcodes.has(barcode));
          console.log(`–û–±—â–∏—Ö –±–∞—Ä–∫–æ–¥–æ–≤ –º–µ–∂–¥—É —Ç–æ–≤–∞—Ä–∞–º–∏ –∏ –∑–∞–∫–∞–∑–∞–º–∏: ${commonBarcodes.length}`);
          if (commonBarcodes.length > 0) {
            console.log('–ü—Ä–∏–º–µ—Ä—ã –æ–±—â–∏—Ö –±–∞—Ä–∫–æ–¥–æ–≤:', commonBarcodes.slice(0, 5));
            
            // –ü—Ä–æ–≤–µ—Ä–∏–º –∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –æ–±—â–∏—Ö –±–∞—Ä–∫–æ–¥–æ–≤
            console.log('–ó–Ω–∞—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –æ–±—â–∏—Ö –±–∞—Ä–∫–æ–¥–æ–≤:');
            commonBarcodes.slice(0, 5).forEach(barcode => {
              const orderQuantity = ordersData.orders[barcode];
              console.log(`  ${barcode}: ${orderQuantity} (—Ç–∏–ø: ${typeof orderQuantity})`);
            });
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏
          document.getElementById('loadingText').textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${productsData.count} —Ç–æ–≤–∞—Ä–æ–≤, –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏ ${ordersData.total_orders} –∑–∞–∫–∞–∑–æ–≤. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å...`;
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–≤–æ–¥–∫–µ
          window.totalOrdersCount = ordersData.total_orders || 0;
          
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
          const products = productsData.products.map(product => ({
            barcode: product.barcode,
            name: product.name,
            photo: product.photo,  // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ photo
            currentStock: stocksData.stocks[product.barcode] || 0,  // –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Å–∫–ª–∞–¥–µ
            allStocks: allStocksData.stocks[product.barcode] || 0,  // –û—Å—Ç–∞—Ç–æ–∫ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º
            orderedInPeriod: ordersData.orders[product.barcode] || 0,  // –ó–∞–∫–∞–∑—ã –∑–∞ –ø–µ—Ä–∏–æ–¥
            salesPerDay: 0,
            requiredStock: 0,
            turnover: 0,
            toSupply: 0,
            inTransit: 0,
            nm_id: product.nm_id,
            supplier_article: product.supplier_article
          }));
          
          // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞ –≤ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
          formData.warehouse_name = stocksData.warehouse_name;
          
          // –û—Ç–ª–∞–¥–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥–∞–ª–∏—Å—å –≤ –º–∞—Å—Å–∏–≤ products
          const productsWithPhotosAfter = products.filter(p => p.photo);
          console.log(`–¢–æ–≤–∞—Ä–æ–≤ —Å —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${productsWithPhotosAfter.length}`);
          if (productsWithPhotosAfter.length > 0) {
            console.log('–ü—Ä–∏–º–µ—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ñ–æ—Ç–æ:', productsWithPhotosAfter.slice(0, 3).map(p => ({
              barcode: p.barcode, 
              photo: p.photo,
              hasPhoto: !!p.photo
            })));
          }
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
          window.lastFormData = formData;
          
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é currentProducts
          currentProducts = [...products];
          console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω currentProducts:', currentProducts.length);
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–ø—Ä–∏–Ω—è—Ç—ã—Ö –ø–æ—Å—Ç–∞–≤–æ–∫
          console.log(`–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è —Å–∫–ª–∞–¥–∞: "${stocksData.warehouse_name}"`);
          console.log('–¢–æ–≤–∞—Ä—ã –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ—Å—Ç–∞–≤–æ–∫:', products.length);
          console.log('–ü—Ä–∏–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ—Å—Ç–∞–≤–æ–∫:', products.slice(0, 3));
          checkPendingSupplies(stocksData.warehouse_name, products, formData);
        } else {
          const errorMsg = productsData.message || stocksData.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
          showError(errorMsg);
        }
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
      });
    }
    
    function showResultsWithProducts(products, formData) {
      console.log('showResultsWithProducts –≤—ã–∑–≤–∞–Ω–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏:', products.length);
      console.log('–ü—Ä–∏–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤:', products.slice(0, 3));
      
      document.getElementById('loadingDiv').style.display = 'none';
      document.getElementById('resultsContent').style.display = 'block';
      
      // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É Excel
      document.getElementById('exportExcelBtn').disabled = false;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤
      const productsCountDiv = document.getElementById('productsCount');
      productsCountDiv.style.display = 'none';
      
      // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏
      const productsWithStock = products.filter(p => p.currentStock > 0).length;
      const totalStock = products.reduce((sum, p) => sum + p.currentStock, 0);
      
      // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞ –∏–∑ API –æ—Ç–≤–µ—Ç–∞
      const warehouseName = formData.warehouse_name || `–°–∫–ª–∞–¥ ${formData.warehouse}`;
      
      const totalOrders = window.totalOrdersCount || 0;
      const stocksUpdateTime = window.stocksUpdatedAt || '';
      productsCountDiv.innerHTML = `
        <div class="mb-2">
          <strong>–°–∫–ª–∞–¥:</strong> ${warehouseName} | 
          <strong>–¢–æ–≤–∞—Ä–æ–≤:</strong> ${products.length} | 
          <strong>–° –æ—Å—Ç–∞—Ç–∫–∞–º–∏:</strong> ${productsWithStock} | 
          <strong>–û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫:</strong> ${totalStock} —à—Ç. | 
          <strong>–ó–∞–∫–∞–∑–∞–Ω–æ –∑–∞ –ø–µ—Ä–∏–æ–¥:</strong> ${totalOrders} —à—Ç.
        </div>
        ${stocksUpdateTime ? `<div class="mb-2 text-success small"><i class="bi bi-arrow-clockwise"></i> –û—Å—Ç–∞—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${stocksUpdateTime}</div>` : ''}
      `;
      
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É–ª—ã –¥–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
      const daysInPeriod = calculateDaysBetween(formData.salesPeriodFrom, formData.salesPeriodTo);
      const daysToSupply = calculateDaysBetween(new Date().toISOString().split('T')[0], formData.supplyDate);
      const planningDays = parseInt(formData.planningDays);
      
      products.forEach(item => {
        // –ü—Ä–æ–¥–∞–∂ –≤ –¥–µ–Ω—å = –∑–∞–∫–∞–∑–∞–Ω–æ –∑–∞ –ø–µ—Ä–∏–æ–¥ / –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –ø–µ—Ä–∏–æ–¥–∞
        item.salesPerDay = daysInPeriod > 0 ? (item.orderedInPeriod / daysInPeriod) : 0;
        
        // –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π –æ—Å—Ç–∞—Ç–æ–∫ = –ø—Ä–æ–¥–∞–∂ –≤ –¥–µ–Ω—å * (–¥–Ω–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è + –¥–Ω–∏ –¥–æ –ø–æ—Å—Ç–∞–≤–∫–∏)
        item.requiredStock = item.salesPerDay * (planningDays + daysToSupply);
        
        // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å = —Ç–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ / –ø—Ä–æ–¥–∞–∂ –≤ –¥–µ–Ω—å
        item.turnover = item.salesPerDay > 0 ? (item.currentStock / item.salesPerDay) : 0;
        
        // –ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥ = –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –æ—Å—Ç–∞—Ç–æ–∫ - —Ç–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ - –≤ –ø—É—Ç–∏
        item.toSupply = Math.max(0, item.requiredStock - item.currentStock - item.inTransit);
      });
      
      renderResultsTable(products);
    }
    
    function showError(message) {
      document.getElementById('loadingDiv').style.display = 'none';
      document.getElementById('resultsContent').style.display = 'block';
      
      const tbody = document.getElementById('resultsTableBody');
      tbody.innerHTML = `
        <tr>
          <td colspan="10" class="text-center text-danger">
            <div class="py-4">
              <i class="bi bi-exclamation-triangle me-2"></i>
              ${message}
            </div>
          </td>
        </tr>
      `;
    }
    
    function calculateDaysBetween(dateFrom, dateTo) {
      const from = new Date(dateFrom);
      const to = new Date(dateTo);
      const diffTime = Math.abs(to - from);
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –æ–±–∞ –¥–Ω—è
    }
    
    function renderResultsTable(data) {
      console.log('renderResultsTable –≤—ã–∑–≤–∞–Ω–∞ —Å –¥–∞–Ω–Ω—ã–º–∏:', data.length);
      console.log('–ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞:', data.slice(0, 3));
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      currentProducts = [...data];
      
      const tbody = document.getElementById('resultsTableBody');
      tbody.innerHTML = '';
      
      data.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="numeric-column">${index + 1}</td>
          <td class="barcode-column">${item.barcode}</td>
          <td class="photo-column">
            ${item.photo ? 
              `<img src="${item.photo}" data-src="${item.photo}" class="product-thumb" alt="photo" style="width:45px;height:65px;object-fit:cover;cursor: zoom-in;" />` : 
              '<span class="text-muted">–Ω–µ—Ç —Ñ–æ—Ç–æ</span>'
            }
          </td>
          <td class="product-name-column">
            <div class="product-name" title="${item.name}">${item.name}</div>
          </td>
          <td class="numeric-column">${item.currentStock}</td>
          <td class="numeric-column">${item.allStocks}</td>
          <td class="numeric-column">${item.inTransit}</td>
          <td class="numeric-column">${item.orderedInPeriod}</td>
          <td class="numeric-column">${item.salesPerDay.toFixed(2)}</td>
          <td class="numeric-column">${Math.round(item.requiredStock)}</td>
          <td class="numeric-column">${item.turnover.toFixed(1)}</td>
          <td class="editable-cell">
            <input type="number" 
                   class="form-control form-control-sm" 
                   value="${Math.round(item.toSupply)}" 
                   min="0" 
                   data-index="${index}"
                   data-field="toSupply">
          </td>
        `;
        tbody.appendChild(row);
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö —è—á–µ–µ–∫
      addEditableCellHandlers();
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ —Ñ–æ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö input –ø–æ–ª–µ–π
      applyInputBackgrounds();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏
      updateTotals();
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      setupSorting();
    }
    
    function setupSorting() {
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      const sortButtons = document.querySelectorAll('.sort-btn');
      sortButtons.forEach(button => {
        button.addEventListener('click', function() {
          const column = this.getAttribute('data-column');
          sortTable(column);
        });
      });
    }
    
    function sortTable(column) {
      if (currentProducts.length === 0) return;
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏
      const sortKey = `sort_${column}`;
      if (!window[sortKey]) {
        window[sortKey] = 'desc'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é
      }
      
      // –ú–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏
      window[sortKey] = window[sortKey] === 'asc' ? 'desc' : 'asc';
      const currentDirection = window[sortKey];
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
      const sortedProducts = [...currentProducts].sort((a, b) => {
        let aValue, bValue;
        
        // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–æ–Ω–∫–∏
        switch(column) {
          case 'currentStock':
            aValue = parseInt(a.currentStock) || 0;
            bValue = parseInt(b.currentStock) || 0;
            break;
          case 'allStocks':
            aValue = parseInt(a.allStocks) || 0;
            bValue = parseInt(b.allStocks) || 0;
            break;
          case 'inTransit':
            aValue = parseInt(a.inTransit) || 0;
            bValue = parseInt(b.inTransit) || 0;
            break;
          case 'orderedInPeriod':
            aValue = parseInt(a.orderedInPeriod) || 0;
            bValue = parseInt(b.orderedInPeriod) || 0;
            break;
          case 'salesPerDay':
            aValue = parseFloat(a.salesPerDay) || 0;
            bValue = parseFloat(b.salesPerDay) || 0;
            break;
          case 'requiredStock':
            aValue = parseInt(a.requiredStock) || 0;
            bValue = parseInt(b.requiredStock) || 0;
            break;
          case 'turnover':
            aValue = parseFloat(a.turnover) || 0;
            bValue = parseFloat(b.turnover) || 0;
            break;
          case 'toSupply':
            aValue = parseInt(a.toSupply) || 0;
            bValue = parseInt(b.toSupply) || 0;
            break;
          default:
            return 0;
        }
        
        if (currentDirection === 'asc') {
          return aValue - bValue;
        } else {
          return bValue - aValue;
        }
      });
      
      // –û—Ç–ª–∞–¥–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
      console.log(`–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ${column} ${currentDirection}:`, sortedProducts.slice(0, 5).map(p => ({
        barcode: p.barcode,
        name: p.name,
        [column]: p[column]
      })));
      
      // –û–±–Ω–æ–≤–ª—è–µ–º currentProducts –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
      currentProducts = [...sortedProducts];
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      const sortButtons = document.querySelectorAll('.sort-btn');
      sortButtons.forEach(button => {
        const icon = button.querySelector('i');
        const buttonColumn = button.getAttribute('data-column');
        const buttonSortKey = `sort_${buttonColumn}`;
        const buttonDirection = window[buttonSortKey] || 'desc';
        
        if (buttonColumn === column) {
          // –ê–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
          if (buttonDirection === 'asc') {
            icon.className = 'bi bi-arrow-up';
          } else {
            icon.className = 'bi bi-arrow-down';
          }
        } else {
          // –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—É—é –∏–∫–æ–Ω–∫—É
          icon.className = 'bi bi-arrow-down-up';
        }
      });
      
      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
      renderTableFromData(sortedProducts);
    }
    
    function renderTableFromData(data) {
      const tbody = document.getElementById('resultsTableBody');
      tbody.innerHTML = '';
      
      data.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="numeric-column">${index + 1}</td>
          <td class="barcode-column">${item.barcode}</td>
          <td class="photo-column">
            ${item.photo ? 
              `<img src="${item.photo}" data-src="${item.photo}" class="product-thumb" alt="photo" style="width:45px;height:65px;object-fit:cover;cursor: zoom-in;" />` : 
              '<span class="text-muted">–Ω–µ—Ç —Ñ–æ—Ç–æ</span>'
            }
          </td>
          <td class="product-name-column">
            <div class="product-name" title="${item.name}">${item.name}</div>
          </td>
          <td class="numeric-column">${item.currentStock}</td>
          <td class="numeric-column">${item.allStocks}</td>
          <td class="numeric-column">${item.inTransit}</td>
          <td class="numeric-column">${item.orderedInPeriod}</td>
          <td class="numeric-column">${item.salesPerDay.toFixed(2)}</td>
          <td class="numeric-column">${Math.round(item.requiredStock)}</td>
          <td class="numeric-column">${item.turnover.toFixed(1)}</td>
          <td class="editable-cell">
            <input type="number" 
                   class="form-control form-control-sm" 
                   value="${Math.round(item.toSupply)}" 
                   min="0" 
                   data-index="${index}"
                   data-field="toSupply">
          </td>
        `;
        tbody.appendChild(row);
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö —è—á–µ–µ–∫
      addEditableCellHandlers();
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ —Ñ–æ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö input –ø–æ–ª–µ–π
      applyInputBackgrounds();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏
      updateTotals();
    }
    
    function updateTotals() {
      const rows = document.querySelectorAll('#resultsTableBody tr');
      let totalCurrentStock = 0;
      let totalAllStocks = 0;
      let totalInTransit = 0;
      let totalOrdered = 0;
      let totalToSupply = 0;
      
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 12) { // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ 12 –∏–∑-–∑–∞ –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏
          totalCurrentStock += parseInt(cells[4].textContent) || 0;
          totalAllStocks += parseInt(cells[5].textContent) || 0;
          totalInTransit += parseInt(cells[6].textContent) || 0;
          totalOrdered += parseInt(cells[7].textContent) || 0;
          
          // –î–ª—è "–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥" –±–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ input
          const toSupplyInput = cells[11].querySelector('input'); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å
          if (toSupplyInput) {
            totalToSupply += parseInt(toSupplyInput.value) || 0;
          }
        }
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –≤ —Å—Ç—Ä–æ–∫–µ
      document.getElementById('totalCurrentStock').textContent = totalCurrentStock;
      document.getElementById('totalAllStocks').textContent = totalAllStocks;
      document.getElementById('totalInTransit').textContent = totalInTransit;
      document.getElementById('totalOrdered').textContent = totalOrdered;
      document.getElementById('totalToSupply').textContent = totalToSupply;
      
      // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ currentProducts –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      updateCurrentProductsFromTable();
    }
    
    function addEditableCellHandlers() {
      const editableCells = document.querySelectorAll('.editable-cell');
      editableCells.forEach(cell => {
        cell.addEventListener('change', function() {
          const index = this.dataset.index;
          const field = this.dataset.field;
          const value = parseInt(this.value) || 0;
          
          console.log(`–ò–∑–º–µ–Ω–µ–Ω–æ –ø–æ–ª–µ ${field} –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${index}: ${value}`);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ —Ñ–æ–Ω–∞
          updateInputBackground(this);
          
          // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
          updateTotals();
        });
        
        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ (–Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞)
        cell.addEventListener('input', function() {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ —Ñ–æ–Ω–∞
          updateInputBackground(this);
          
          updateTotals();
        });
      });
    }
    
    function updateInputBackground(input) {
      const value = parseInt(input.value) || 0;
      if (value > 0) {
        input.classList.add('highlighted');
      } else {
        input.classList.remove('highlighted');
      }
    }
    
    function applyInputBackgrounds() {
      const inputs = document.querySelectorAll('.editable-cell input');
      inputs.forEach(input => {
        updateInputBackground(input);
      });
    }
    
    function recalculateToSupply(index) {
      const row = document.querySelector(`[data-index="${index}"]`).closest('tr');
      const cells = row.querySelectorAll('td');
      
      // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
      const currentStock = parseInt(cells[2].textContent) || 0;
      const requiredStock = parseInt(cells[5].textContent) || 0;
      const inTransit = parseInt(row.querySelector('[data-field="inTransit"]').value) || 0;
      
      // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º "–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥"
      const toSupply = Math.max(0, requiredStock - currentStock - inTransit);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–æ–ª–µ
      const toSupplyInput = row.querySelector('[data-field="toSupply"]');
      toSupplyInput.value = toSupply;
      
      console.log(`–ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ "–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥" –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${index}: ${toSupply}`);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–∫–ª–∞–¥–æ–≤
    async function loadWarehouses() {
      try {
        const response = await fetch('/api/fbw/warehouses');
        const data = await response.json();
        
        if (data.success) {
          console.log('–î–∞–Ω–Ω—ã–µ —Å–∫–ª–∞–¥–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞:', data);
          allWarehouses = data.warehouses;
          filteredWarehouses = [...allWarehouses];
          setupWarehouseSearch();
          console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.count} —Å–∫–ª–∞–¥–æ–≤:`, allWarehouses);
        } else {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–ª–∞–¥–æ–≤:', data.message);
          showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–∫–ª–∞–¥–æ–≤');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–ª–∞–¥–æ–≤:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–∫–ª–∞–¥–æ–≤');
      }
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ —Å–∫–ª–∞–¥–æ–≤
    function setupWarehouseSearch() {
      const searchInput = document.getElementById('warehouseSearch');
      const dropdown = document.getElementById('warehouseDropdown');
      const hiddenSelect = document.getElementById('warehouse');
      
      console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ —Å–∫–ª–∞–¥–æ–≤:');
      console.log('searchInput:', searchInput);
      console.log('dropdown:', dropdown);
      console.log('hiddenSelect:', hiddenSelect);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å–∫–ª–∞–¥—ã –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
      searchInput.addEventListener('focus', function() {
        showWarehouseDropdown();
      });
      
      // –ü–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
      searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        console.log(`Input event: query="${query}", lastSelectedValue="${searchInput.dataset.lastSelectedValue}"`);
        
        // –û—á–∏—â–∞–µ–º —Å–∫—Ä—ã—Ç—ã–π select —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é
        // (–Ω–µ –ø—Ä–∏ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—è)
        if (query !== searchInput.dataset.lastSelectedValue) {
          hiddenSelect.value = '';
          console.log('–û—á–∏—â–µ–Ω —Å–∫—Ä—ã—Ç—ã–π select - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é');
        }
        
        if (query.length === 0) {
          filteredWarehouses = [...allWarehouses];
        } else {
          filteredWarehouses = allWarehouses.filter(warehouse => 
            warehouse.name.toLowerCase().includes(query) ||
            (warehouse.city && warehouse.city.toLowerCase().includes(query)) ||
            (warehouse.address && warehouse.address.toLowerCase().includes(query))
          );
        }
        showWarehouseDropdown();
      });
      
      // –°–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —ç–ª–µ–º–µ–Ω—Ç–∞
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#warehouseSearch') && !e.target.closest('#warehouseDropdown')) {
          dropdown.style.display = 'none';
        }
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–∫–ª–∞–¥–∞
      dropdown.addEventListener('click', function(e) {
        console.log('–ö–ª–∏–∫ –ø–æ dropdown:', e.target);
        const item = e.target.closest('.warehouse-search-item');
        console.log('–ù–∞–π–¥–µ–Ω–Ω—ã–π item:', item);
        
        if (item) {
          const warehouseId = item.dataset.warehouseId;
          const warehouseName = item.dataset.warehouseName;
          
          console.log(`–î–∞–Ω–Ω—ã–µ —Å–∫–ª–∞–¥–∞ - ID: ${warehouseId}, Name: ${warehouseName}`);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–π select
          hiddenSelect.innerHTML = '';
          const option = document.createElement('option');
          option.value = warehouseId;
          option.textContent = warehouseName;
          option.selected = true;
          hiddenSelect.appendChild(option);
          console.log(`–°–∫—Ä—ã—Ç—ã–π select –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${hiddenSelect.value}`);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç
          searchInput.value = warehouseName;
          
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —ç—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
          searchInput.dataset.lastSelectedValue = warehouseName;
          
          // –°–∫—Ä—ã–≤–∞–µ–º dropdown
          dropdown.style.display = 'none';
          
          console.log(`–í—ã–±—Ä–∞–Ω —Å–∫–ª–∞–¥: ${warehouseName} (ID: ${warehouseId})`);
          console.log(`–°–∫—Ä—ã—Ç—ã–π select value: ${hiddenSelect.value}`);
          console.log(`–ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ value: ${searchInput.value}`);
        }
      });
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å dropdown —Å–æ —Å–∫–ª–∞–¥–∞–º–∏
    function showWarehouseDropdown() {
      const dropdown = document.getElementById('warehouseDropdown');
      dropdown.innerHTML = '';
      
      if (filteredWarehouses.length === 0) {
        dropdown.innerHTML = '<div class="warehouse-search-item text-muted">–°–∫–ª–∞–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
      } else {
        filteredWarehouses.forEach(warehouse => {
          const item = document.createElement('div');
          item.className = 'warehouse-search-item';
          if (warehouse.is_sorting_center) {
            item.classList.add('warehouse-sorting-center');
          }
          
          item.dataset.warehouseId = warehouse.id;
          item.dataset.warehouseName = warehouse.name;
          
          item.innerHTML = `
            <div class="warehouse-name">${warehouse.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
            <div class="warehouse-details">
              ${warehouse.city ? warehouse.city : ''} 
              ${warehouse.is_sorting_center ? '‚Ä¢ –°–æ—Ä—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —Ü–µ–Ω—Ç—Ä' : ''}
            </div>
          `;
          
          dropdown.appendChild(item);
        });
      }
      
      dropdown.style.display = 'block';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
    function updateCurrentProductsFromTable() {
      const rows = document.querySelectorAll('#resultsTableBody tr');
      rows.forEach((row, index) => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 12 && currentProducts[index]) { // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ 12
          // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ "–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥" –∏–∑ input
          const toSupplyInput = cells[11].querySelector('input'); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å
          if (toSupplyInput) {
            currentProducts[index].toSupply = parseInt(toSupplyInput.value) || 0;
          }
        }
      });
    }
    
    // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel
    function exportToExcel() {
      if (currentProducts.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º
      updateCurrentProductsFromTable();
      
      // –û—Ç–ª–∞–¥–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ (–ø–µ—Ä–≤—ã–µ 3 —Ç–æ–≤–∞—Ä–∞):', currentProducts.slice(0, 3).map(p => ({
        barcode: p.barcode,
        name: p.name,
        toSupply: p.toSupply
      })));
      
      // –°–æ–∑–¥–∞–µ–º CSV –¥–∞–Ω–Ω—ã–µ
      let csvContent = '\uFEFF'; // BOM –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–∏
      
      // –ó–∞–≥–æ–ª–æ–≤–∫–∏
      const headers = [
        '‚Ññ',
        '–ë–∞—Ä–∫–æ–¥',
        '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ',
        '–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫',
        '–û—Å—Ç–∞—Ç–æ–∫ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º',
        '–í –ø—É—Ç–∏ –Ω–∞ —Å–∫–ª–∞–¥',
        '–ó–∞–∫–∞–∑–∞–Ω–æ –∑–∞ –ø–µ—Ä–∏–æ–¥',
        '–ü—Ä–æ–¥–∞–∂ –≤ –¥–µ–Ω—å',
        '–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π –æ—Å—Ç–∞—Ç–æ–∫',
        '–û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å',
        '–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥'
      ];
      
      csvContent += headers.join(';') + '\n';
      
      // –î–∞–Ω–Ω—ã–µ
      currentProducts.forEach((item, index) => {
        const row = [
          index + 1,
          item.barcode,
          `"${item.name}"`, // –û–±—Ä–∞–º–ª—è–µ–º –≤ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
          item.currentStock,
          item.allStocks,
          item.inTransit,
          item.orderedInPeriod,
          item.salesPerDay.toFixed(2),
          Math.round(item.requiredStock),
          item.turnover.toFixed(1),
          Math.round(item.toSupply)
        ];
        csvContent += row.join(';') + '\n';
      });
      
      // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å –¥–∞—Ç–æ–π
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];
      link.setAttribute('download', `planning_${dateStr}.csv`);
      
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ–ø—Ä–∏–Ω—è—Ç—ã—Ö –ø–æ—Å—Ç–∞–≤–æ–∫
    async function checkPendingSupplies(warehouseName, products, formData) {
      try {
        console.log(`–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è —Å–∫–ª–∞–¥–∞: "${warehouseName}" (—Ç–∏–ø: ${typeof warehouseName})`);
        console.log('–¢–æ–≤–∞—Ä—ã –≤ checkPendingSupplies:', products.length);
        console.log('–ü—Ä–∏–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤ –≤ checkPendingSupplies:', products.slice(0, 3));
        const startTime = performance.now();
        
        const response = await fetch(`/api/fbw/planning/supplies?warehouse_name=${encodeURIComponent(warehouseName)}&force_refresh=true`);
        const data = await response.json();
        
        const endTime = performance.now();
        console.log(`–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å—Ç–∞–≤–æ–∫ –∑–∞–Ω—è–ª–∞: ${(endTime - startTime).toFixed(2)} –º—Å`);
        
        console.log('–û—Ç–≤–µ—Ç API –ø–æ—Å—Ç–∞–≤–æ–∫:', data);
        
        if (data.success && data.supplies && data.supplies.length > 0) {
          console.log(`–ù–∞–π–¥–µ–Ω–æ ${data.supplies.length} –Ω–µ–ø—Ä–∏–Ω—è—Ç—ã—Ö –ø–æ—Å—Ç–∞–≤–æ–∫:`, data.supplies);
          pendingSupplies = data.supplies;
          showPendingSuppliesModal(products, formData);
        } else {
          console.log('–ù–µ–ø—Ä–∏–Ω—è—Ç—ã—Ö –ø–æ—Å—Ç–∞–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü—Ä–∏—á–∏–Ω–∞:', {
            success: data.success,
            supplies: data.supplies,
            count: data.count,
            error: data.error
          });
          console.log('–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...');
          // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
          setTimeout(() => {
            showResultsWithProducts(products, formData);
          }, 500);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫:', error);
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        setTimeout(() => {
          showResultsWithProducts(products, formData);
        }, 500);
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –ø–æ—Å—Ç–∞–≤–∫–∞–º–∏
    function showPendingSuppliesModal(products, formData) {
      console.log('showPendingSuppliesModal –≤—ã–∑–≤–∞–Ω–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏:', products.length);
      console.log('–ü—Ä–∏–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤ –≤ showPendingSuppliesModal:', products.slice(0, 3));
      
      const suppliesList = document.getElementById('pendingSuppliesList');
      suppliesList.innerHTML = '';
      
      if (pendingSupplies.length === 0) {
        suppliesList.innerHTML = '<p class="text-muted">–ü–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
      }
      
      // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –ø–æ—Å—Ç–∞–≤–∫–∞–º–∏
      const table = document.createElement('table');
      table.className = 'table table-sm table-striped';
      table.innerHTML = `
        <thead class="table-light">
          <tr>
            <th>‚Ññ –ø–æ—Å—Ç–∞–≤–∫–∏</th>
            <th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞</th>
            <th>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏</th>
          </tr>
        </thead>
        <tbody>
          ${pendingSupplies.map(supply => `
            <tr>
              <td><strong>${supply.supply_id}</strong></td>
              <td>${supply.warehouse}</td>
              <td class="text-center">${supply.total_goods} —à—Ç.</td>
              <td>${supply.planned_date}</td>
            </tr>
          `).join('')}
        </tbody>
      `;
      
      suppliesList.appendChild(table);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      pendingSuppliesModal.show();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω—è—Ç–∏—è –ø–æ—Å—Ç–∞–≤–æ–∫ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ "–í –ø—É—Ç–∏ –Ω–∞ —Å–∫–ª–∞–¥")
    function acceptPendingSupplies() {
      console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω—è–ª –ø–æ—Å—Ç–∞–≤–∫–∏, –¥–æ–±–∞–≤–ª—è–µ–º –≤ "–í –ø—É—Ç–∏ –Ω–∞ —Å–∫–ª–∞–¥"');
      console.log('currentProducts –≤ acceptPendingSupplies:', currentProducts.length);
      console.log('–ü—Ä–∏–º–µ—Ä—ã currentProducts –≤ acceptPendingSupplies:', currentProducts.slice(0, 3));
      
      // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω—É–ª—è–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è "–í –ø—É—Ç–∏ –Ω–∞ —Å–∫–ª–∞–¥"
      currentProducts.forEach(product => {
        product.inTransit = 0;
      });
      
      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –±–∞—Ä–∫–æ–¥–∞–º –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
      const productsByBarcode = {};
      currentProducts.forEach(product => {
        productsByBarcode[product.barcode] = product;
      });
      
      console.log('–ö–∞—Ä—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –±–∞—Ä–∫–æ–¥–∞–º:', Object.keys(productsByBarcode).length, '—Ç–æ–≤–∞—Ä–æ–≤');
      console.log('–ü—Ä–∏–º–µ—Ä—ã –±–∞—Ä–∫–æ–¥–æ–≤ –≤ —Å–ø–∏—Å–∫–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', Object.keys(productsByBarcode).slice(0, 5));
      
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –ø–æ—Å—Ç–∞–≤–∫—É
      let totalAdded = 0;
      pendingSupplies.forEach(supply => {
        console.log(`–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ—Å—Ç–∞–≤–∫—É ${supply.supply_id} —Å ${supply.goods ? supply.goods.length : 0} —Ç–æ–≤–∞—Ä–∞–º–∏`);
        
        if (supply.goods && supply.goods.length > 0) {
          console.log('–ü—Ä–∏–º–µ—Ä—ã –±–∞—Ä–∫–æ–¥–æ–≤ –≤ –ø–æ—Å—Ç–∞–≤–∫–µ:', supply.goods.slice(0, 5).map(g => g.barcode));
          
          supply.goods.forEach(good => {
            const barcode = good.barcode;
            const quantity = good.quantity || 0;
            
            if (productsByBarcode[barcode]) {
              productsByBarcode[barcode].inTransit += quantity;
              totalAdded += quantity;
              console.log(`–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ "–í –ø—É—Ç–∏": ${barcode} - ${quantity} —à—Ç.`);
            } else {
              console.log(`–¢–æ–≤–∞—Ä —Å –±–∞—Ä–∫–æ–¥–æ–º ${barcode} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è`);
            }
          });
        } else {
          console.log(`–ü–æ—Å—Ç–∞–≤–∫–∞ ${supply.supply_id} –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–≤–∞—Ä–æ–≤`);
        }
      });
      
      console.log(`–í—Å–µ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ "–í –ø—É—Ç–∏ –Ω–∞ —Å–∫–ª–∞–¥": ${totalAdded} —Ç–æ–≤–∞—Ä–æ–≤`);
      
      showResultsWithProducts(currentProducts, window.lastFormData);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–ª–æ–Ω–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
    function applyTableColumnSettings() {
      console.log('–§—É–Ω–∫—Ü–∏—è applyTableColumnSettings –≤—ã–∑–≤–∞–Ω–∞');
      
      const columnSettings = {
        'colNumber': 0,
        'colBarcode': 1,
        'colPhoto': 2,
        'colName': 3,
        'colCurrentStock': 4,
        'colAllStocks': 5,
        'colInTransit': 6,
        'colOrdered': 7,
        'colSalesPerDay': 8,
        'colRequiredStock': 9,
        'colTurnover': 10,
        'colToSupply': 11
      };
      
      // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤
      const visibleColumns = {};
      Object.keys(columnSettings).forEach(columnId => {
        const checkbox = document.getElementById(columnId);
        const isChecked = checkbox ? checkbox.checked : true;
        visibleColumns[columnSettings[columnId]] = isChecked;
        console.log(`–ö–æ–ª–æ–Ω–∫–∞ ${columnId} (–∏–Ω–¥–µ–∫—Å ${columnSettings[columnId]}): ${isChecked ? '–≤–∏–¥–∏–º–∞' : '—Å–∫—Ä—ã—Ç–∞'}`);
      });
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∞–±–ª–∏—Ü–∞
      const resultsTable = document.getElementById('resultsTable');
      if (!resultsTable) {
        console.log('–¢–∞–±–ª–∏—Ü–∞ resultsTable –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return;
      }
      
      // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ —Ç–∞–±–ª–∏—Ü—ã
      const headerCells = document.querySelectorAll('#resultsTable thead tr:first-child th');
      const totalsCells = document.querySelectorAll('#resultsTable thead tr:last-child th');
      
      console.log(`–ù–∞–π–¥–µ–Ω–æ —è—á–µ–µ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞: ${headerCells.length}`);
      console.log(`–ù–∞–π–¥–µ–Ω–æ —è—á–µ–µ–∫ –∏—Ç–æ–≥–æ–≤: ${totalsCells.length}`);
      
      headerCells.forEach((cell, index) => {
        if (visibleColumns[index] !== undefined) {
          const shouldShow = visibleColumns[index];
          cell.style.display = shouldShow ? '' : 'none';
          console.log(`–ó–∞–≥–æ–ª–æ–≤–æ–∫ ${index}: ${shouldShow ? '–ø–æ–∫–∞–∑–∞–Ω' : '—Å–∫—Ä—ã—Ç'}`);
        }
      });
      
      totalsCells.forEach((cell, index) => {
        if (visibleColumns[index] !== undefined) {
          const shouldShow = visibleColumns[index];
          cell.style.display = shouldShow ? '' : 'none';
          console.log(`–ò—Ç–æ–≥–∏ ${index}: ${shouldShow ? '–ø–æ–∫–∞–∑–∞–Ω—ã' : '—Å–∫—Ä—ã—Ç—ã'}`);
        }
      });
      
      // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–æ–ª–æ–Ω–æ–∫
      const sortButtons = document.querySelectorAll('.sort-btn');
      const columnToIndex = {
        'currentStock': 4,
        'allStocks': 5,
        'inTransit': 6,
        'orderedInPeriod': 7,
        'salesPerDay': 8,
        'requiredStock': 9,
        'turnover': 10,
        'toSupply': 11
      };
      
      sortButtons.forEach(button => {
        const column = button.getAttribute('data-column');
        const columnIndex = columnToIndex[column];
        if (columnIndex !== undefined && visibleColumns[columnIndex] !== undefined) {
          button.style.display = visibleColumns[columnIndex] ? '' : 'none';
        }
      });
      
      // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ –≤ —Å—Ç—Ä–æ–∫–∞—Ö –¥–∞–Ω–Ω—ã—Ö
      const dataRows = document.querySelectorAll('#resultsTable tbody tr');
      console.log(`–ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö: ${dataRows.length}`);
      
      dataRows.forEach((row, rowIndex) => {
        const cells = row.querySelectorAll('td');
        cells.forEach((cell, index) => {
          if (visibleColumns[index] !== undefined) {
            const shouldShow = visibleColumns[index];
            cell.style.display = shouldShow ? '' : 'none';
            if (rowIndex === 0) { // –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
              console.log(`–î–∞–Ω–Ω—ã–µ ${index}: ${shouldShow ? '–ø–æ–∫–∞–∑–∞–Ω—ã' : '—Å–∫—Ä—ã—Ç—ã'}`);
            }
          }
        });
      });
      
      console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:', visibleColumns);
    }
  </script>
  {% include '_footer.html' %}
  
</body>
</html>
