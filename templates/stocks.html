<!doctype html>
<html lang="ru">
<head>
  {% block title %}<title>Остатки на складах — WB Dashboard</title>{% endblock %}
  {% include '_header.html' %}
  {% block extra_styles %}
  <style>
    h1 { font-size: 1.7rem; }
    input#stocksSearch { margin: 20px 0px;padding: 10px;}
    .mb-2 {margin-bottom: 1.1rem !important;}
    /* Compact warehouses table inside product details */
    .wh-compact { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: .5rem; padding: .5rem; display: inline-block; }
    .wh-compact .table-responsive { display: inline-block; width: auto; max-width: 100%; }
    .wh-compact table { font-size: .9rem; margin-bottom: 0; width: auto !important; }
    .wh-compact thead th { color: #6c757d; font-weight: 600; }
    .wh-compact .table td, .wh-compact .table th { padding: .25rem .5rem; }
    .wh-compact .table tr + tr td { border-top: 1px solid #edf0f2; }
    .wh-compact .table td, .wh-compact .table th { white-space: nowrap; }

    /* Compact full-width table for Warehouses tab details */
    .wh-compact-full { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: .5rem; padding: .5rem; }
    .wh-compact-full .table-responsive { width: 100%; }
    .wh-compact-full table { font-size: .9rem; margin-bottom: 0; width: 100%; }
    .wh-compact-full .table td, .wh-compact-full .table th { padding: .25rem .5rem; }
    .wh-compact-full .table tr + tr td { border-top: 1px solid #edf0f2; }
  </style>
  {% endblock %}
</head>
<body>
  {% include '_navbar.html' %}
  <div class="container mt-3">
    <div class="d-flex align-items-center justify-content-between mb-2 gap-2 flex-wrap">
      <h1 class="mb-0">Остатки на складах{% if total_qty_all is defined %} ({{ total_qty_all }} шт.){% endif %}</h1>
      <div class="d-flex gap-2">
        <form method="post" action="/stocks/export">
          <button class="btn btn-success btn-sm" type="submit">Выгрузить в Excel</button>
        </form>
        <button id="refreshStocks" class="btn btn-primary btn-sm">Обновить остатки</button>
      </div>
    </div>
    <div class="text-muted mb-2">Обновлено: <span id="stocksUpdatedAt">{{ updated_at or '' }}</span></div>
    <div id="stocksMsg" class="small"></div>
    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    <ul class="nav nav-tabs" id="stocksTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-products" data-bs-toggle="tab" data-bs-target="#pane-products" type="button" role="tab">По товарам</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-warehouses" data-bs-toggle="tab" data-bs-target="#pane-warehouses" type="button" role="tab">По складам</button>
      </li>
    </ul>
    <div class="tab-content border border-top-0 rounded-bottom p-0">
      <div class="tab-pane fade show active" id="pane-products" role="tabpanel" aria-labelledby="tab-products">
        <div class="p-3 pt-2">
          <div class="table-responsive" style="max-height:70vh;">
            <table class="table table-sm align-middle mb-0" id="byProductsTable">
              <thead style="position: sticky; top: 0; z-index: 2; background: #fff;">
                <tr>
                  <th style="width:56px;" class="text-center">#</th>
                  <th style="width:60px;" class="text-center"></th>
                  <th>Товар</th>
                  <th class="text-end">Остаток (на складе)</th>
                  <th class="text-end">В пути</th>
                </tr>
                <tr>
                  <th colspan="6"><input id="stocksSearch" type="search" class="form-control form-control-sm" placeholder="Поиск товара" /></th>
                </tr>
              </thead>
              <tbody>
                {% for p in products_agg %}
                <tr class="prod-row">
                  <td class="text-center">{{ loop.index }}</td>
                  <td class="text-center">
                    {% if p.photo %}
                      <img src="{{ p.photo }}" data-src="{{ p.photo }}" class="product-thumb" alt="photo" style="width:45px;height:65px;object-fit:cover;cursor: zoom-in;" />
                    {% else %}
                      <span class="text-muted">нет фото</span>
                    {% endif %}
                  </td>
                  <td>
                    <div>
                      {% if p.nm_id %}
                        <a href="/product/{{ p.nm_id }}" class="text-decoration-none">{{ p.vendor_code or '' }}</a>
                        <span class="ms-1 small"><a href="https://www.wildberries.ru/catalog/{{ p.nm_id }}/detail.aspx" target="_blank" rel="noopener" class="text-muted" title="Открыть на WB"><i class="fas fa-external-link-alt"></i></a></span>
                      {% else %}
                        {{ p.vendor_code or '' }}
                      {% endif %}
                    </div>
                    {% if p.nm_id or p.barcode %}
                      <div class="small text-muted mt-1">
                        {% if p.nm_id %}Артикул WB: {{ p.nm_id }}{% endif %}
                        {% if p.nm_id and p.barcode %} | {% endif %}
                        {% if p.barcode %}Баркод: {{ p.barcode }}{% endif %}
                      </div>
                    {% endif %}
                    <div class="mt-1">
                      <button class="btn btn-link btn-sm p-0" type="button" data-bs-toggle="collapse" data-bs-target="#prod-{{ loop.index }}">Показать остатки товара по складам</button>
                    </div>
                  </td>
                  <td class="text-end">{{ p.total_qty or 0 }}</td>
                  <td class="text-end">{{ p.total_in_transit or 0 }}</td>
                </tr>
                <tr class="collapse" id="prod-{{ loop.index }}">
                  <td></td>
                  <td colspan="5">
                    <div class="wh-compact">
                      <div class="table-responsive">
                        <table class="table table-sm">
                          <thead>
                            <tr>
                              <th>Склад</th>
                              <th class="text-end">Остаток</th>
                              <th class="text-end">В пути</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for w in p.warehouses %}
                            <tr>
                              <td>{{ w.warehouse }}</td>
                              <td class="text-end">{{ w.qty }}</td>
                              <td class="text-end">{{ w.in_transit or 0 }}</td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </td>
                </tr>
                {% endfor %}
                {% if not products_agg %}
                  <tr><td colspan="4" class="text-muted">Нет данных</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="pane-warehouses" role="tabpanel" aria-labelledby="tab-warehouses">
        <div class="p-3 pt-2">
          <div class="table-responsive" style="max-height:70vh;">
            <table class="table table-sm align-middle mb-0" id="byWarehousesTable">
              <thead style="position: sticky; top: 0; z-index: 2; background: #fff;">
                <tr>
                  <th style="width:56px;" class="text-center">#</th>
                  <th>Склад</th>
                  <th class="text-end">Остаток (на складе)</th>
                  <th class="text-end">В пути</th>
                </tr>
              </thead>
              <tbody>
                {% for w in warehouses_agg %}
                <tr class="wh-row" data-bs-toggle="collapse" data-bs-target="#wh-{{ loop.index }}" style="cursor:pointer;">
                  <td class="text-center">{{ loop.index }}</td>
                  <td>{{ w.warehouse or '' }}</td>
                  <td class="text-end">{{ w.total_qty or 0 }}</td>
                  <td class="text-end">{{ w.total_in_transit or 0 }}</td>
                </tr>
                <tr class="collapse" id="wh-{{ loop.index }}">
                  <td></td>
                  <td colspan="2">
                    <div class="wh-compact-full">
                      <div class="table-responsive">
                        <table class="table table-sm">
                          <thead><tr><th style="width:60px;"></th><th>Товар</th><th class="text-end">Остаток</th><th class="text-end">В пути</th></tr></thead>
                          <tbody>
                            {% for p in w.products %}
                            <tr>
                              <td class="text-center">
                                {% if p.photo %}
                                  <img src="{{ p.photo }}" data-src="{{ p.photo }}" class="product-thumb" alt="photo" style="width:45px;height:65px;object-fit:cover;cursor: zoom-in;" />
                                {% else %}
                                  <span class="text-muted">—</span>
                                {% endif %}
                              </td>
                              <td>
                                <div>
                                  {% if p.nm_id %}
                                    <a href="/product/{{ p.nm_id }}" class="text-decoration-none">{{ p.vendor_code or '' }}</a>
                                    <span class="ms-1 small"><a href="https://www.wildberries.ru/catalog/{{ p.nm_id }}/detail.aspx" target="_blank" rel="noopener" class="text-muted" title="Открыть на WB"><i class="fas fa-external-link-alt"></i></a></span>
                                  {% else %}
                                    {{ p.vendor_code or '' }}
                                  {% endif %}
                                </div>
                                {% if p.nm_id or p.barcode %}
                                  <div class="small text-muted mt-1">
                                    {% if p.nm_id %}Артикул WB: {{ p.nm_id }}{% endif %}
                                    {% if p.nm_id and p.barcode %} | {% endif %}
                                    {% if p.barcode %}Баркод: {{ p.barcode }}{% endif %}
                                  </div>
                                {% endif %}
                              </td>
                              <td class="text-end">{{ p.qty }}</td>
                              <td class="text-end">{{ p.in_transit or 0 }}</td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </td>
                </tr>
                {% endfor %}
                {% if not warehouses_agg %}
                  <tr><td colspan="3" class="text-muted">Нет данных</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="imgPreview" style="display:none; position:fixed; left:50%; top:50%; transform: translate(-50%, -50%); z-index:1060; padding:4px; background:#fff; border:1px solid rgba(0,0,0,.15); box-shadow:0 .5rem 1rem rgba(0,0,0,.15); pointer-events: none;">
    <img id="imgPreviewImg" src="" alt="preview" style="max-width:420px; max-height:560px; display:block;" />
  </div>
  <script>
    (function(){
      const btn = document.getElementById('refreshStocks');
      if (btn) {
        btn.addEventListener('click', async function(){
          btn.disabled = true; const prev = btn.textContent; btn.textContent = 'Обновление...';
          try {
            const res = await fetch('/api/stocks/refresh', { method: 'POST' });
            const data = await res.json().catch(()=>({}));
            if (!res.ok) {
              const msgEl = document.getElementById('stocksMsg');
              // Показать статус и возможный Retry-After
              const status = data.status || res.status;
              let retry = parseInt(data.retry_after || '0', 10);
              if (!retry || isNaN(retry)) retry = (status === 429 ? 60 : 0); // дефолт для 429
              if (msgEl) msgEl.className = 'small text-danger';
              if (msgEl) msgEl.textContent = `Ошибка обновления (status ${status})`;
              // Короткую подпись оставим на кнопке
              btn.textContent = retry > 0 ? `Подождите ${retry} c...` : 'Ошибка';
              if (retry > 0) {
                const timer = setInterval(()=>{
                  retry -= 1;
                  if (retry <= 0) { clearInterval(timer); btn.textContent = prev; btn.disabled = false; if (msgEl) msgEl.textContent = ''; }
                  else { btn.textContent = `Подождите ${retry} c...`; }
                }, 1000);
              } else {
                setTimeout(()=>{ btn.textContent = prev; btn.disabled = false; if (msgEl) msgEl.textContent=''; }, 3000);
              }
              const updEl = document.getElementById('stocksUpdatedAt');
              if (updEl && data.updated_at) updEl.textContent = data.updated_at;
              return;
            }
            const updEl = document.getElementById('stocksUpdatedAt');
            if (updEl && data.updated_at) updEl.textContent = data.updated_at;
            // Подтянем свежие агрегаты и перерисуем таблицы без перезагрузки
            try {
              const dres = await fetch('/api/stocks/data');
              const djson = await dres.json();
              if (dres.ok && djson) {
                const total = document.querySelector('h1');
                if (total && djson.total_qty_all != null) {
                  const inTransit = (djson.total_in_transit_all || 0).toLocaleString('ru-RU');
                  total.innerHTML = `Остатки на складах (${(djson.total_qty_all||0).toLocaleString('ru-RU')} шт., в пути: ${inTransit})`;
                }
                // Перерисовка вкладки По товарам
                const tbodyProd = document.querySelector('#byProductsTable tbody');
                if (tbodyProd && Array.isArray(djson.products)) {
                  tbodyProd.innerHTML='';
                  let idx=1;
                  for (const p of djson.products) {
                    const tr = document.createElement('tr'); tr.className='prod-row';
                    const photoCell = p.photo ? `<img src='${p.photo}' data-src='${p.photo}' class='product-thumb' alt='photo' style='width:45px;height:65px;object-fit:cover;cursor: zoom-in;' />` : `<span class='text-muted'>нет фото</span>`;
                    const titleCell = `
                      <div>
                        ${p.nm_id ? `<a href='/product/${p.nm_id}' class='text-decoration-none'>${p.vendor_code||''}</a><span class='ms-1 small'><a href='https://www.wildberries.ru/catalog/${p.nm_id}/detail.aspx' target='_blank' rel='noopener' class='text-muted' title='Открыть на WB'><i class='fas fa-external-link-alt'></i></a></span>` : `${p.vendor_code||''}`}
                      </div>
                      ${(p.nm_id||p.barcode) ? `<div class='small text-muted mt-1'>${p.nm_id ? `Артикул WB: ${p.nm_id}` : ''}${(p.nm_id && p.barcode) ? ' | ' : ''}${p.barcode ? `Баркод: ${p.barcode}` : ''}</div>` : ''}
                      <div class='mt-1'><button class='btn btn-link btn-sm p-0' type='button' data-bs-toggle='collapse' data-bs-target='#prod-${idx}'>Показать остатки товара по складам</button></div>
                    `;
                    tr.innerHTML = `<td class='text-center'>${idx}</td><td class='text-center'>${photoCell}</td><td>${titleCell}</td><td class='text-end'>${(p.total_qty||0).toLocaleString('ru-RU')}</td><td class='text-end'>${(p.total_in_transit||0).toLocaleString('ru-RU')}</td>`;
                    const trd = document.createElement('tr'); trd.className='collapse'; trd.id = `prod-${idx}`;
                    trd.innerHTML = `<td></td><td colspan='5'><div class='wh-compact'><div class='table-responsive'><table class='table table-sm'><thead><tr><th>Склад</th><th class='text-end'>Остаток</th><th class='text-end'>В пути</th></tr></thead><tbody>${(p.warehouses||[]).map(w=>`<tr><td>${w.warehouse}</td><td class='text-end'>${(w.qty||0).toLocaleString('ru-RU')}</td><td class='text-end'>${(w.in_transit||0).toLocaleString('ru-RU')}</td></tr>`).join('')}</tbody></table></div></div></td>`;
                    tbodyProd.appendChild(tr); tbodyProd.appendChild(trd); idx++;
                  }
                }
                // Перерисовка вкладки По складам
                const tbodyWh = document.querySelector('#byWarehousesTable tbody');
                if (tbodyWh && Array.isArray(djson.warehouses)) {
                  tbodyWh.innerHTML='';
                  let idx=1;
                  for (const w of djson.warehouses) {
                    const tr = document.createElement('tr'); tr.className='wh-row'; tr.setAttribute('data-bs-toggle','collapse'); tr.setAttribute('data-bs-target',`#wh-${idx}`); tr.style.cursor='pointer';
                    tr.innerHTML = `<td class=\"text-center\">${idx}</td><td>${w.warehouse||''}</td><td class=\"text-end\">${(w.total_qty||0).toLocaleString('ru-RU')}</td><td class=\"text-end\">${(w.total_in_transit||0).toLocaleString('ru-RU')}</td>`;
                    const trd = document.createElement('tr'); trd.className='collapse'; trd.id = `wh-${idx}`;
                    trd.innerHTML = `<td></td><td colspan=\"3\"><div class=\"wh-compact-full\"><div class=\"table-responsive\"><table class=\"table table-sm\"><thead><tr><th style='width:60px;'></th><th>Товар</th><th class='text-end'>Остаток</th><th class='text-end'>В пути</th></tr></thead><tbody>${(w.products||[]).map(p=>`<tr><td class='text-center'>${p.photo ? `<img src='${p.photo}' data-src='${p.photo}' class='product-thumb' alt='photo' style='width:45px;height:65px;object-fit:cover;cursor: zoom-in;' />` : `<span class='text-muted'>—</span>`}</td><td><div>${p.nm_id ? `<a href='/product/${p.nm_id}' class='text-decoration-none'>${p.vendor_code||''}</a><span class='ms-1 small'><a href='https://www.wildberries.ru/catalog/${p.nm_id}/detail.aspx' target='_blank' rel='noopener' class='text-muted' title='Открыть на WB'><i class='fas fa-external-link-alt'></i></a></span>` : `${p.vendor_code||''}`}</div>${(p.nm_id||p.barcode) ? `<div class='small text-muted mt-1'>${p.nm_id ? `Артикул WB: ${p.nm_id}` : ''}${(p.nm_id && p.barcode) ? ' | ' : ''}${p.barcode ? `Баркод: ${p.barcode}` : ''}</div>` : ''}</td><td class='text-end'>${(p.qty||0).toLocaleString('ru-RU')}</td><td class='text-end'>${(p.in_transit||0).toLocaleString('ru-RU')}</td></tr>`).join('')}</tbody></table></div></div></td>`;
                    tbodyWh.appendChild(tr); tbodyWh.appendChild(trd); idx++;
                  }
                }
              }
            } catch(e) { console.error(e); }
            btn.textContent = 'Готово';
            setTimeout(()=>{ btn.textContent = prev; btn.disabled = false; }, 1000);
          } catch (e) {
            console.error(e);
            btn.textContent = 'Ошибка';
            setTimeout(()=>{ btn.textContent = prev; btn.disabled = false; }, 1500);
          }
        });
      }
      
      
      
      const search = document.getElementById('stocksSearch');
      const tbody = document.querySelector('#byProductsTable tbody');
      if (search && tbody) {
        search.addEventListener('input', function(){
          const q = (this.value || '').toLowerCase().trim();
          const prodRows = tbody.querySelectorAll('tr.prod-row');
          prodRows.forEach(row => {
            const match = q === '' || row.textContent.toLowerCase().indexOf(q) !== -1;
            row.style.display = match ? '' : 'none';
            const detail = row.nextElementSibling;
            if (detail && detail.classList.contains('collapse')) {
              if (!match) {
                detail.classList.remove('show');
                detail.hidden = true;
              } else {
                detail.hidden = false;
              }
            }
          });
        });
      }

      // Hover preview like on /products
      const preview = document.getElementById('imgPreview');
      const previewImg = document.getElementById('imgPreviewImg');
      document.addEventListener('mouseover', function(e){
        const t = e.target;
        if (t && t.classList && t.classList.contains('product-thumb')){
          const src = t.getAttribute('data-src') || t.getAttribute('src');
          previewImg.src = src;
          preview.style.display = 'block';
        }
      });
      document.addEventListener('mouseout', function(e){
        const t = e.target;
        if (t && t.classList && t.classList.contains('product-thumb')){
          preview.style.display = 'none';
          previewImg.src = '';
        }
      });
    })();
  </script>
  {% include '_footer.html' %}
</body>
</html>
