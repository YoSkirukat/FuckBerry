<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Товары — WB Dashboard</title>
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <style>
    h1 { font-size: 1.7rem; }
    input#productsSearch { margin: 20px 0px;padding: 10px;}
    .mb-2 {margin-bottom: 1.1rem !important;}
  </style>
</head>
<body>
  {% include '_navbar.html' %}
  <div class="container mt-3">
    <div class="d-flex align-items-center justify-content-between mb-2 gap-2 flex-wrap">
      <h1 class="mb-0">Товары{% if items_count is defined %} ({{ items_count }} шт.){% endif %}</h1>
      <button id="refreshProducts" class="btn btn-primary btn-sm">Обновить список товаров</button>
    </div>
    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    <div class="card">
      <div class="card-body">
        <div class="table-responsive" style="max-height:70vh;">
          <table class="table table-sm align-middle mb-0" id="productsTable">
            <thead style="position: sticky; top: 0; z-index: 2; background: #fff;">
              <tr>
                <th class="text-center" style="width:56px;">#</th>
                <th style="width:72px;">Фото</th>
                <th>Артикул продавца</th>
                <th>Артикул WB</th>
                <th>Баркод</th>
                <th class="text-center" style="width:48px;"></th>
              </tr>
              <tr>
                <th colspan="5">
                  <input id="productsSearch" type="search" class="form-control form-control-sm" placeholder="Поиск товара" />
                </th>
              </tr>
            </thead>
            <tbody>
              {% for it in items %}
              <tr>
                <td class="text-center">{{ loop.index }}</td>
                <td>
                  {% if it.photo %}
                    <img src="{{ it.photo }}" data-src="{{ it.photo }}" class="product-thumb" alt="photo" style="width:45px;height:65px;object-fit:cover;cursor: zoom-in;" />
                  {% else %}
                    <span class="text-muted">нет фото</span>
                  {% endif %}
                </td>
                <td>
                  {% if it.nm_id %}
                    <a href="https://www.wildberries.ru/catalog/{{ it.nm_id }}/detail.aspx" target="_blank" rel="noopener">{{ it.supplier_article or '' }}</a>
                  {% else %}
                    {{ it.supplier_article or '' }}
                  {% endif %}
                </td>
                <td>{{ it.nm_id or '' }}</td>
                <td>{{ it.barcode or '' }}</td>
                <td class="text-center">
                  {% if it.nm_id %}
                    <a href="https://seller.wildberries.ru/new-goods/card?nmID={{ it.nm_id }}&type=EXIST_CARD" target="_blank" rel="noopener" title="Редактировать" class="text-decoration-none">✎</a>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
              {% if not items %}
                <tr><td colspan="6" class="text-muted">Нет данных</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div id="imgPreview" style="display:none; position:fixed; left:50%; top:50%; transform: translate(-50%, -50%); z-index:1060; padding:4px; background:#fff; border:1px solid rgba(0,0,0,.15); box-shadow:0 .5rem 1rem rgba(0,0,0,.15); pointer-events: none;">
    <img id="imgPreviewImg" src="" alt="preview" style="max-width:420px; max-height:560px; display:block;" />
  </div>
  <script>
    (function(){
      const btn = document.getElementById('refreshProducts');
      if (!btn) return;
      btn.addEventListener('click', async function(){
        btn.disabled = true; const prev = btn.textContent; btn.textContent = 'Обновление...';
        try {
          const res = await fetch('/api/products/refresh', { method: 'POST' });
          const data = await res.json().catch(()=>({}));
          if (!res.ok) throw new Error(data.error || 'Ошибка обновления');
          location.reload();
        } catch (e) {
          console.error(e);
          btn.textContent = 'Ошибка';
          setTimeout(()=>{ btn.textContent = prev; btn.disabled = false; }, 1500);
          return;
        }
      });
      // Live search
      const search = document.getElementById('productsSearch');
      const tbody = document.querySelector('#productsTable tbody');
      if (search && tbody) {
        search.addEventListener('input', function(){
          const q = (this.value || '').toLowerCase().trim();
          const rows = tbody.querySelectorAll('tr');
          rows.forEach(r => {
            const txt = r.textContent.toLowerCase();
            r.style.display = q === '' || txt.indexOf(q) !== -1 ? '' : 'none';
          });
        });
      }

      // Image hover preview
      const preview = document.getElementById('imgPreview');
      const previewImg = document.getElementById('imgPreviewImg');
      document.addEventListener('mouseover', function(e){
        const t = e.target;
        if (t && t.classList && t.classList.contains('product-thumb')){
          const src = t.getAttribute('data-src') || t.getAttribute('src');
          previewImg.src = src;
          preview.style.display = 'block';
        }
      });
      document.addEventListener('mouseout', function(e){
        const t = e.target;
        if (t && t.classList && t.classList.contains('product-thumb')){
          preview.style.display = 'none';
          previewImg.src = '';
        }
      });
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
